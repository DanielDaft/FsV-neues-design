<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Event Delegation Test</title>
<style>
.card-circles .ue-circle {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 2px solid #ccc;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer !important;
  transition: all 0.2s ease;
  color: white;
  pointer-events: auto !important;
  position: relative !important;
  z-index: 999 !important;
  margin: 2px;
}

.card-circles .ue-circle:not(.blue-empty):not(.blue-filled) {
  background: #22C55E;
  color: white;
  border: 2px solid #22C55E;
}

.card-circles .ue-circle.add-circle-btn {
  background: transparent;
  border: 2px dashed #22c55e;
  color: #22c55e;
}

.card-circles .quarter-circle {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 2px solid #22c55e;
  cursor: pointer;
  background: #f3f4f6;
  position: relative;
  overflow: hidden;
  transition: all 0.2s ease;
  margin: 2px;
}

.card-circles .quarter-circle.pie-25 {
  background: conic-gradient(#22c55e 0deg 90deg, #f3f4f6 90deg 360deg);
}

.card-circles .quarter-circle.pie-50 {
  background: conic-gradient(#22c55e 0deg 180deg, #f3f4f6 180deg 360deg);
}

.card-circles .quarter-circle.pie-75 {
  background: conic-gradient(#22c55e 0deg 270deg, #f3f4f6 270deg 360deg);
}

.card-circles .quarter-circle.pie-100 {
  background: #22c55e;
}

.card-circles .quarter-circle.add-circle-btn {
  background: transparent;
  border: 2px dashed #22c55e;
  color: #22c55e;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 600;
}

.ue-circle.blue-empty {
  background: transparent;
  border: 2px solid #3b82f6;
  color: #3b82f6;
}

.ue-circle.blue-filled {
  background: #3b82f6;
  border: 2px solid #3b82f6;
  color: white;
}

.circle-row {
  display: flex;
  align-items: center;
  margin: 10px 0;
}

.test-container {
  padding: 20px;
  max-width: 800px;
  margin: 20px auto;
  border: 1px solid #ccc;
  border-radius: 8px;
}

.test-result {
  background: #f0f8ff;
  padding: 10px;
  margin: 10px 0;
  border-radius: 5px;
  border: 1px solid #0066cc;
}
</style>
</head>
<body>

<div class="test-container">
  <h2>Event Delegation Test für Kartenansicht</h2>
  
  <div class="test-result" id="testResults">
    <strong>Test Ergebnisse:</strong>
    <ul id="resultList"></ul>
  </div>

  <div id="cardView" data-category="grundstufe">
    <h3>Grundstufe Kategorie:</h3>
    <div class="card-circles">
      <div class="circle-row">
        <span style="color: #22c55e; font-weight: 600; font-size: 14px; margin-right: 8px;">UE:</span>
        <div class="ue-circle full">1</div>
        <div class="ue-circle full">2</div>
        <div class="ue-circle add-circle-btn">+</div>
      </div>
      <div class="circle-row">
        <span style="color: #22c55e; font-weight: 600; font-size: 14px; margin-right: 8px;">UE:</span>
        <div class="quarter-circle pie-25"></div>
        <div class="quarter-circle pie-50"></div>
        <div class="quarter-circle add-circle-btn">+</div>
      </div>
    </div>
  </div>

  <div id="cardView2" data-category="uberlandfahrten">
    <h3>Überlandfahrten Kategorie:</h3>
    <div class="card-circles">
      <div class="circle-row">
        <span style="color: #3b82f6; font-weight: 600; font-size: 14px; margin-right: 8px;">PS:</span>
        <div class="ue-circle blue-empty">1</div>
        <div class="ue-circle blue-filled">2</div>
        <div class="ue-circle blue-empty">3</div>
      </div>
    </div>
  </div>

  <button onclick="runTests()" style="padding: 10px 20px; margin: 20px 0; background: #0066cc; color: white; border: none; border-radius: 5px; cursor: pointer;">
    Event Delegation Tests ausführen
  </button>
</div>

<script>
let testResults = [];
let ueCircleCount = 2;
let quarterCircleCount = 2;

function addTestResult(test, result) {
  testResults.push(`${test}: ${result}`);
  updateResultDisplay();
}

function updateResultDisplay() {
  const list = document.getElementById('resultList');
  list.innerHTML = testResults.map(result => `<li>${result}</li>`).join('');
}

// Mock functions to simulate the actual PWA functionality
function addCategoryUECircle(studentId, categoryKey) {
  ueCircleCount++;
  addTestResult(`addCategoryUECircle(${studentId}, ${categoryKey})`, '✅ AUFGERUFEN');
  
  // Simulate adding a new UE circle
  const cardView = document.querySelector(`[data-category="${categoryKey}"]`);
  const ueRow = cardView.querySelector('.circle-row');
  const addBtn = ueRow.querySelector('.ue-circle.add-circle-btn');
  
  const newCircle = document.createElement('div');
  newCircle.className = 'ue-circle full';
  newCircle.textContent = ueCircleCount;
  
  ueRow.insertBefore(newCircle, addBtn);
  addTestResult('UE Kreis hinzugefügt', '✅ VISUELL BESTÄTIGT');
}

function removeCategoryUECircle(studentId, categoryKey, index) {
  addTestResult(`removeCategoryUECircle(${studentId}, ${categoryKey}, ${index})`, '✅ AUFGERUFEN');
  
  // Simulate removing UE circle
  const cardView = document.querySelector(`[data-category="${categoryKey}"]`);
  const ueCircles = cardView.querySelectorAll('.ue-circle.full');
  if (ueCircles[index]) {
    ueCircles[index].remove();
    ueCircleCount--;
    addTestResult('UE Kreis entfernt', '✅ VISUELL BESTÄTIGT');
  }
}

function addCategoryQuarterCircle(studentId, categoryKey) {
  quarterCircleCount++;
  addTestResult(`addCategoryQuarterCircle(${studentId}, ${categoryKey})`, '✅ AUFGERUFEN');
  
  // Simulate adding quarter circle
  const cardView = document.querySelector(`[data-category="${categoryKey}"]`);
  const quarterRow = cardView.querySelectorAll('.circle-row')[1];
  const addBtn = quarterRow.querySelector('.quarter-circle.add-circle-btn');
  
  const newCircle = document.createElement('div');
  newCircle.className = 'quarter-circle pie-25';
  
  quarterRow.insertBefore(newCircle, addBtn);
  addTestResult('Quarter Kreis hinzugefügt', '✅ VISUELL BESTÄTIGT');
}

function toggleCategoryQuarterCircle(studentId, categoryKey, index) {
  addTestResult(`toggleCategoryQuarterCircle(${studentId}, ${categoryKey}, ${index})`, '✅ AUFGERUFEN');
  
  // Simulate quarter circle progression
  const cardView = document.querySelector(`[data-category="${categoryKey}"]`);
  const quarterRow = cardView.querySelectorAll('.circle-row')[1];
  const quarterCircles = quarterRow.querySelectorAll('.quarter-circle:not(.add-circle-btn)');
  
  if (quarterCircles[index]) {
    const circle = quarterCircles[index];
    const currentClass = circle.className;
    
    if (currentClass.includes('pie-25')) {
      circle.className = 'quarter-circle pie-50';
    } else if (currentClass.includes('pie-50')) {
      circle.className = 'quarter-circle pie-75';
    } else if (currentClass.includes('pie-75')) {
      circle.className = 'quarter-circle pie-100';
    } else if (currentClass.includes('pie-100')) {
      circle.remove();
      quarterCircleCount--;
    } else {
      circle.className = 'quarter-circle pie-25';
    }
    
    addTestResult('Quarter Kreis Status geändert', '✅ VISUELL BESTÄTIGT');
  }
}

function toggleBlueCircle(studentId, categoryKey, index) {
  addTestResult(`toggleBlueCircle(${studentId}, ${categoryKey}, ${index})`, '✅ AUFGERUFEN');
  
  // Simulate blue circle toggle
  const cardView = document.querySelector(`[data-category="${categoryKey}"]`);
  const blueCircles = cardView.querySelectorAll('.ue-circle.blue-empty, .ue-circle.blue-filled');
  
  if (blueCircles[index]) {
    const circle = blueCircles[index];
    if (circle.classList.contains('blue-empty')) {
      circle.className = 'ue-circle blue-filled';
      circle.textContent = circle.textContent;
    } else {
      circle.className = 'ue-circle blue-empty';
      circle.textContent = circle.textContent;
    }
    
    addTestResult('Blauer PS Kreis Status geändert', '✅ VISUELL BESTÄTIGT');
  }
}

function getCurrentStudent() {
  return { id: 'test-student-123' };
}

// Event Delegation Implementation (copied from main PWA)
function setupCardViewEventDelegation(studentId) {
  const cardViews = document.querySelectorAll('[id^="cardView"]');
  
  cardViews.forEach(cardView => {
    if (!cardView) return;
    
    // Remove previous event listeners
    cardView.removeEventListener('click', handleCardViewClick);
    
    // Add event listener
    cardView.addEventListener('click', handleCardViewClick);
  });
  
  function handleCardViewClick(event) {
    event.stopPropagation();
    
    const target = event.target;
    const studentId = getCurrentStudent()?.id;
    if (!studentId) return;
    
    // UE Circles - Add
    if (target.classList.contains('add-circle-btn') && target.classList.contains('ue-circle')) {
      const categoryDiv = target.closest('[data-category]');
      const categoryKey = categoryDiv?.getAttribute('data-category');
      
      if (categoryKey) {
        addCategoryUECircle(studentId, categoryKey);
        event.preventDefault();
        return false;
      }
    }
    
    // UE Circles - Remove
    if (target.classList.contains('ue-circle') && target.classList.contains('full') && !target.classList.contains('add-circle-btn')) {
      const categoryDiv = target.closest('[data-category]');
      const categoryKey = categoryDiv?.getAttribute('data-category');
      
      // Extract index from circle text
      const circleNumber = parseInt(target.textContent) - 1;
      
      if (categoryKey && !isNaN(circleNumber)) {
        removeCategoryUECircle(studentId, categoryKey, circleNumber);
        event.preventDefault();
        return false;
      }
    }
    
    // Quarter Circles - Add
    if (target.classList.contains('add-circle-btn') && target.classList.contains('quarter-circle')) {
      const categoryDiv = target.closest('[data-category]');
      const categoryKey = categoryDiv?.getAttribute('data-category');
      
      if (categoryKey) {
        addCategoryQuarterCircle(studentId, categoryKey);
        event.preventDefault();
        return false;
      }
    }
    
    // Quarter Circles - Toggle
    if (target.classList.contains('quarter-circle') && !target.classList.contains('add-circle-btn')) {
      const categoryDiv = target.closest('[data-category]');
      const categoryKey = categoryDiv?.getAttribute('data-category');
      
      // Determine index (all quarter circles in the row)
      const quarterRow = target.parentElement;
      const allQuarterCircles = Array.from(quarterRow.querySelectorAll('.quarter-circle:not(.add-circle-btn)'));
      const circleIndex = allQuarterCircles.indexOf(target);
      
      if (categoryKey && circleIndex !== -1) {
        toggleCategoryQuarterCircle(studentId, categoryKey, circleIndex);
        event.preventDefault();
        return false;
      }
    }
    
    // Blue PS Circles - Toggle
    if (target.classList.contains('ue-circle') && (target.classList.contains('blue-empty') || target.classList.contains('blue-filled'))) {
      const categoryDiv = target.closest('[data-category]');
      const categoryKey = categoryDiv?.getAttribute('data-category');
      
      // Extract index from circle text
      const circleNumber = parseInt(target.textContent) - 1;
      
      if (categoryKey && !isNaN(circleNumber)) {
        toggleBlueCircle(studentId, categoryKey, circleNumber);
        event.preventDefault();
        return false;
      }
    }
  }
}

function runTests() {
  testResults = [];
  addTestResult('Event Delegation Test gestartet', '🚀 BEGINN');
  
  // Setup event delegation
  setupCardViewEventDelegation('test-student-123');
  addTestResult('Event Delegation eingerichtet', '✅ SETUP KOMPLETT');
  
  // Test UE circle addition
  setTimeout(() => {
    const addBtn = document.querySelector('.ue-circle.add-circle-btn');
    if (addBtn) {
      addBtn.click();
      addTestResult('UE Add Button Test', '✅ KLICK SIMULIERT');
    }
  }, 500);
  
  // Test UE circle removal
  setTimeout(() => {
    const ueCircle = document.querySelector('.ue-circle.full');
    if (ueCircle) {
      ueCircle.click();
      addTestResult('UE Remove Button Test', '✅ KLICK SIMULIERT');
    }
  }, 1000);
  
  // Test quarter circle addition
  setTimeout(() => {
    const quarterAddBtn = document.querySelector('.quarter-circle.add-circle-btn');
    if (quarterAddBtn) {
      quarterAddBtn.click();
      addTestResult('Quarter Add Button Test', '✅ KLICK SIMULIERT');
    }
  }, 1500);
  
  // Test quarter circle toggle
  setTimeout(() => {
    const quarterCircle = document.querySelector('.quarter-circle:not(.add-circle-btn)');
    if (quarterCircle) {
      quarterCircle.click();
      addTestResult('Quarter Toggle Test', '✅ KLICK SIMULIERT');
    }
  }, 2000);
  
  // Test blue circle toggle
  setTimeout(() => {
    const blueCircle = document.querySelector('.ue-circle.blue-empty');
    if (blueCircle) {
      blueCircle.click();
      addTestResult('Blue Circle Toggle Test', '✅ KLICK SIMULIERT');
    }
  }, 2500);
  
  setTimeout(() => {
    addTestResult('Alle Tests abgeschlossen', '🎉 FERTIG');
  }, 3000);
}

// Auto-run tests on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(runTests, 1000);
});
</script>

</body>
</html>