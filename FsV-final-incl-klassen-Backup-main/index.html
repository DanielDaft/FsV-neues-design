<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Deutsche Fahrschul-App</title>

<!-- PWA Manifest -->
<link rel="manifest" href="/manifest.json">
<link rel="stylesheet" href="class-manager-styles.css">

<!-- iOS Safari spezifische Meta-Tags -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Fahrschul-App">
<meta name="format-detection" content="telephone=no">

<!-- iOS Touch Icons - Verschiedene GrÃ¶ÃŸen fÃ¼r alle Apple Devices -->
<link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiB2aWV3Qm94PSIwIDAgMTgwIDE4MCI+PHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIGZpbGw9IiMyNTYzZWIiIHJ4PSIyNCIvPjx0ZXh0IHg9IjkwIiB5PSIxMDUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI2OCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCI+RnNWPC90ZXh0Pjwvc3ZnPg==">
<link rel="apple-touch-icon" sizes="152x152" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNTIiIGhlaWdodD0iMTUyIiB2aWV3Qm94PSIwIDAgMTUyIDE1MiI+PHJlY3Qgd2lkdGg9IjE1MiIgaGVpZ2h0PSIxNTIiIGZpbGw9IiMyNTYzZWIiIHJ4PSIyMCIvPjx0ZXh0IHg9Ijc2IiB5PSI4OCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjU3IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJjZW50cmFsIj5Gc1Y8L3RleHQ+PC9zdmc+">
<link rel="apple-touch-icon" sizes="120x120" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiB2aWV3Qm94PSIwIDAgMTIwIDEyMCI+PHJlY3Qgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiMyNTYzZWIiIHJ4PSIxNiIvPjx0ZXh0IHg9IjYwIiB5PSI3MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ1IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJjZW50cmFsIj5Gc1Y8L3RleHQ+PC9zdmc+">

<!-- Standard Favicon -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDMyIDMyIj48cmVjdCB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIGZpbGw9IiMyNTYzZWIiIHJ4PSI0Ii8+PHRleHQgeD0iMTYiIHk9IjE5IiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9ImNlbnRyYWwiPkZzVjwvdGV4dD48L3N2Zz4=">

<!-- Theme Colors -->
<meta name="theme-color" content="#2563eb">
<meta name="msapplication-TileColor" content="#2563eb">

<!-- Preconnects fÃ¼r Performance -->
<link rel="preconnect" href="https://fonts.googleapis.com">


<style>
/* ROOT VARIABLES FÃœR LIGHT/DARK MODE */
:root {
  /* LIGHT MODE (Standard) */
  --bg-primary: #f5f5f5;
  --bg-secondary: #ffffff;
  --bg-tertiary: #fafafa;
  --text-primary: #333333;
  --text-secondary: #6b7280;
  --text-tertiary: #9ca3af;
  --border-color: #e5e7eb;
  --shadow-color: rgba(0, 0, 0, 0.1);
  --shadow-hover: rgba(0, 0, 0, 0.15);
  
  /* FARBIGE ELEMENTE BLEIBEN UNBERÃœHRT */
  --orange-primary: #f59e0b;
  --orange-secondary: #f97316;
  --red-primary: #dc2626;
  --red-secondary: #ef4444;
  --blue-primary: #2563eb;
  --blue-secondary: #3b82f6;
  --green-primary: #22c55e;
  --yellow-primary: #eab308;
}

/* DARK MODE VARIABLES */
[data-theme="dark"] {
  --bg-primary: #1a1a1a;
  --bg-secondary: #2d2d2d;
  --bg-tertiary: #3a3a3a;
  --text-primary: #ffffff;
  --text-secondary: #e5e5e5;
  --text-tertiary: #b5b5b5;
  --border-color: #4a4a4a;
  --shadow-color: rgba(0, 0, 0, 0.3);
  --shadow-hover: rgba(0, 0, 0, 0.4);
}

/* FORCE ALLE TEXTE IM DARK MODE WEISS */
[data-theme="dark"] .student-phone,
[data-theme="dark"] .student-date,
[data-theme="dark"] .student-details,
[data-theme="dark"] .student-name {
  color: #ffffff !important;
}

/* SMOOTH TRANSITIONS FÃœR ALLE FARB-Ã„NDERUNGEN */
* {
  transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
}

/* SCROLLBAR STYLING FÃœR BEIDE MODI */
/* Webkit Scrollbars (Chrome, Safari, Edge) */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg-primary);
}

::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--text-tertiary);
}

/* Firefox Scrollbars */
* {
  scrollbar-width: thin;
  scrollbar-color: var(--border-color) var(--bg-primary);
}

/* BRUTAL EINFACHE LÃ–SUNG - ALLE FETTEN TEXTE UNTERSTREICHEN */
*[style*="font-weight: bold"] {
  text-decoration: underline !important;
}

*[style*="font-weight:bold"] {
  text-decoration: underline !important;
}

div[style*="bold"] {
  text-decoration: underline !important;
}

/* ALLE FETTEN TEXTE UNTERSTREICHEN */
/*
*[style*="font-weight: bold"],
*[style*="font-weight: 600"],
.training-info h3,
.section-title,
.info-text,
.progress-text,
.ue-title,
.fahrt-title,
h1, h2, h3, h4, h5, h6 {
  text-decoration: underline;
}
*/

/* DROPDOWN-CONTENT UNTERSTREICHUNG FÃœR FETTE TEXTE - ALLE KATEGORIEN */
.training-content h4,
.training-content .font-medium,
.training-items h4,
.training-items .font-medium,
.training-content .mb-2,
.training-items .mb-2,
.training-section h4,
.training-section .font-medium {
  text-decoration: underline !important;
  font-weight: 600;
  color: var(--text-primary);
}

/* ALLE SECTION-NAMEN IN DROPDOWNS UNTERSTREICHEN */
.training-content [class*="mb-2"],
.training-items [class*="mb-2"],
.training-content .section-name,
.training-items .section-name {
  text-decoration: underline !important;
  font-weight: 600;
}

/* SPEZIELLE UNTERSTREICHUNG FÃœR ALLE KATEGORIE-ÃœBERSCHRIFTEN IM DROPDOWN */
.training-content > .training-items > div > h4,
.training-items > div > h4,
.progress-item + h4,
h4[class*="font-medium"],
h4[class*="text-gray"] {
  text-decoration: underline !important;
  font-weight: 600;
  color: var(--text-primary);
}

/* UTILITY CLASSES FÃœR DROPDOWN */
.mb-4 {
  margin-bottom: 1rem;
}

.mb-2 {
  margin-bottom: 0.5rem;
  text-decoration: underline;
  font-weight: 600;
  color: var(--text-primary);
}

.ml-4 {
  margin-left: 1rem;
}

.font-medium {
  font-weight: 500;
}

.text-gray-700 {
  color: var(--text-primary);
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
background-color: var(--bg-primary);
min-height: 100vh;
-webkit-overflow-scrolling: touch;
color: var(--text-primary);
}

/* GENAU WIE IN IHREN BILDERN - PROFESSIONAL DESIGN */

/* HEADER STYLES */
.main-header {
background: var(--bg-secondary);
padding: 20px 24px;
display: flex;
justify-content: space-between;
align-items: center;
box-shadow: 0 1px 3px var(--shadow-color);
position: relative;
}

.main-header .header-left {
display: flex;
align-items: center;
gap: 16px;
}

.main-header .header-center {
position: absolute;
left: 50%;
transform: translateX(-50%);
}

.main-header .header-right {
display: flex;
align-items: center;
gap: 16px;
}

.main-header h1 {
font-size: 28px;
font-weight: 600;
color: var(--text-primary);
}

.btn-primary {
background: var(--blue-primary);
color: white;
padding: 12px 20px;
border: none;
border-radius: 8px;
font-weight: 600;
font-size: 16px;
cursor: pointer;
display: flex;
align-items: center;
gap: 8px;
transition: all 0.2s;
min-height: 48px;
touch-action: manipulation;
user-select: none;
-webkit-tap-highlight-color: transparent;
}

.btn-primary:hover {
background: var(--blue-secondary);
transform: translateY(-1px);
}

.btn-primary:active {
transform: scale(0.98);
}

/* CONTAINER */
.container {
max-width: 1200px;
margin: 0 auto;
padding: 24px;
}

/* DARK MODE TOGGLE BUTTON */
.theme-toggle {
background: var(--bg-tertiary);
border: 2px solid var(--border-color);
border-radius: 50px;
padding: 8px 16px;
cursor: pointer;
display: flex;
align-items: center;
gap: 8px;
font-size: 14px;
font-weight: 600;
color: var(--text-secondary);
transition: all 0.3s ease;
user-select: none;
-webkit-tap-highlight-color: transparent;
margin-right: 16px;
}

.theme-toggle:hover {
background: var(--bg-secondary);
border-color: var(--text-tertiary);
transform: translateY(-1px);
}

.theme-toggle .icon {
font-size: 18px;
transition: transform 0.3s ease;
}

.theme-toggle:hover .icon {
transform: scale(1.1);
}

/* ELEGANT BUTTON STYLE - BASIEREND AUF TOGGLE DESIGN */
.btn-elegant {
background: var(--bg-tertiary);
border: 2px solid var(--border-color);
border-radius: 50px;
padding: 8px 16px;
cursor: pointer;
display: flex;
align-items: center;
gap: 8px;
font-size: 14px;
font-weight: 600;
color: var(--text-secondary);
transition: all 0.3s ease;
user-select: none;
-webkit-tap-highlight-color: transparent;
text-decoration: none;
}

.btn-elegant:hover {
background: var(--bg-secondary);
border-color: var(--text-tertiary);
transform: translateY(-1px);
}

.btn-elegant .icon {
font-size: 18px;
transition: transform 0.3s ease;
}

.btn-elegant:hover .icon {
transform: scale(1.1);
}

/* VARIANTEN FÃœR VERSCHIEDENE BUTTON-TYPEN */
.btn-elegant.primary {
background: var(--blue-primary);
border-color: var(--blue-secondary);
color: white;
}

.btn-elegant.primary:hover {
background: var(--blue-secondary);
border-color: var(--blue-primary);
}

.btn-elegant.secondary {
background: var(--bg-tertiary);
border-color: var(--border-color);
color: var(--text-primary);
}

.btn-elegant.secondary:hover {
background: var(--bg-secondary);
border-color: var(--blue-primary);
color: var(--blue-primary);
}

.btn-elegant.pdf {
background: var(--orange-primary);
border-color: var(--orange-secondary);
color: white;
}

.btn-elegant.pdf:hover {
background: var(--orange-secondary);
border-color: var(--orange-primary);
}

/* ðŸ“š KLASSENAUSWAHL-CARDS */
.class-selection-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
gap: 20px;
margin-bottom: 24px;
max-width: 1400px;
margin-left: auto;
margin-right: auto;
}

.class-card {
background: var(--bg-secondary);
border-radius: 16px;
padding: 24px;
box-shadow: 0 2px 8px var(--shadow-color);
cursor: pointer;
transition: all 0.3s ease;
border: 2px solid transparent;
position: relative;
overflow: hidden;
}

.class-card:hover {
transform: translateY(-4px);
box-shadow: 0 8px 25px var(--shadow-hover);
border-color: var(--blue-primary);
}

.class-card-header {
display: flex;
align-items: center;
gap: 16px;
margin-bottom: 16px;
}

.class-icon {
width: 60px;
height: 60px;
border-radius: 50%;
background: var(--blue-primary);
display: flex;
align-items: center;
justify-content: center;
font-size: 32px;
flex-shrink: 0;
}

/* SVG-ICONS FÃœR FÃœHRERSCHEINKLASSEN */
.class-icon-img {
width: 36px;
height: 36px;
color: white;
filter: brightness(0) invert(1); /* Macht die Icons weiÃŸ */
}

.class-icon svg {
width: 36px;
height: 36px;
color: white;
}

.class-title {
font-size: 24px;
font-weight: 700;
color: var(--text-primary);
}

.class-description {
color: var(--text-secondary);
font-size: 14px;
line-height: 1.5;
margin-bottom: 20px;
min-height: 42px;
}

.class-stats {
display: flex;
justify-content: space-between;
align-items: center;
}

.student-count {
font-size: 16px;
font-weight: 600;
color: var(--text-primary);
}

.has-students {
color: var(--green-primary);
font-size: 18px;
}

.no-students {
color: var(--text-tertiary);
font-size: 18px;
}

/* ðŸ“Š STATS & WELCOME BANNERS */
.welcome-banner {
background: linear-gradient(135deg, var(--blue-primary), var(--blue-secondary));
color: white;
border-radius: 16px;
padding: 32px;
text-align: center;
margin-top: 24px;
}

.welcome-icon {
font-size: 48px;
margin-bottom: 16px;
}

.welcome-text h3 {
margin: 0 0 8px 0;
font-size: 24px;
}

.welcome-text p {
margin: 0;
opacity: 0.9;
font-size: 16px;
}

.stats-banner {
background: var(--bg-secondary);
border: 1px solid var(--border-color);
border-radius: 12px;
padding: 16px;
margin-top: 24px;
box-shadow: 0 1px 3px var(--shadow-color);
}

.stats-content {
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
gap: 16px;
}

.stats-main {
display: flex;
align-items: center;
gap: 12px;
}

.stats-icon {
font-size: 20px;
}

.stats-text {
display: flex;
flex-direction: column;
gap: 2px;
}

.stats-text strong {
font-size: 16px;
color: var(--text-primary);
}

.stats-subtitle {
font-size: 14px;
color: var(--text-secondary);
}

.stats-tip {
font-size: 14px;
color: var(--text-secondary);
font-style: italic;
}

/* ðŸŽ¯ KLASSENSPEZIFISCHE BANNER */
.class-info-banner {
background: var(--bg-secondary);
border: 1px solid var(--border-color);
border-radius: 12px;
padding: 16px;
margin-bottom: 24px;
box-shadow: 0 1px 3px var(--shadow-color);
}

.class-info-content {
display: flex;
align-items: center;
gap: 16px;
}

.class-info-main {
display: flex;
align-items: center;
gap: 12px;
}

.class-info-icon {
font-size: 24px;
}

.class-info-text {
display: flex;
flex-direction: column;
gap: 2px;
}

.class-info-text strong {
font-size: 16px;
color: var(--text-primary);
}

.class-info-subtitle {
font-size: 14px;
color: var(--text-secondary);
}

/* ðŸš« EMPTY STATE FÃœR KLASSEN */
.empty-class-state {
text-align: center;
padding: 60px 20px;
background: var(--bg-secondary);
border-radius: 16px;
border: 2px dashed var(--border-color);
}

.empty-icon {
font-size: 64px;
margin-bottom: 16px;
opacity: 0.5;
}

.empty-title {
font-size: 20px;
font-weight: 600;
color: var(--text-primary);
margin-bottom: 8px;
}

.empty-description {
font-size: 14px;
color: var(--text-secondary);
margin-bottom: 24px;
max-width: 400px;
margin-left: auto;
margin-right: auto;
}

/* ðŸ‘¤ ERWEITERTE STUDENT CARDS */
.student-class {
font-size: 12px;
color: var(--blue-primary);
font-weight: 600;
margin-top: 4px;
}

/* RESPONSIVE DESIGN */
@media (max-width: 768px) {
  .class-selection-grid {
    grid-template-columns: 1fr;
  }
  
  .class-card {
    padding: 20px;
  }
  
  .class-icon {
    width: 50px;
    height: 50px;
    font-size: 24px;
  }
  
  .class-title {
    font-size: 20px;
  }
  
  .stats-content {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .welcome-banner {
    padding: 24px;
  }
  
  .welcome-icon {
    font-size: 40px;
  }
}

/* ðŸ” HAMBURGER-MENÃœ */
.hamburger-menu-btn {
background: var(--bg-tertiary);
border: 2px solid var(--border-color);
border-radius: 8px;
width: 44px;
height: 44px;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.2s ease;
margin-left: 12px; /* Rechts positioniert - margin-left statt margin-right */
}

.hamburger-menu-btn:hover {
border-color: var(--blue-primary);
background: var(--bg-secondary);
transform: translateY(-1px);
}

.hamburger-icon {
font-size: 18px;
color: var(--text-primary);
font-weight: bold;
}

.hamburger-menu-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.5);
z-index: 1000;
display: none;
backdrop-filter: blur(4px);
transition: opacity 0.3s ease;
}

.hamburger-menu-overlay.active {
display: flex;
align-items: flex-start;
justify-content: flex-end;
padding: 20px;
}

.hamburger-menu-overlay.closing {
opacity: 0;
}

.hamburger-menu {
background: var(--bg-primary);
border-radius: 12px;
box-shadow: 0 8px 32px var(--shadow-color);
border: 1px solid var(--border-color);
min-width: 260px;
max-width: 320px;
animation: menuSlideIn 0.3s ease;
}

.hamburger-menu.closing {
animation: menuSlideOut 0.3s ease;
}

@keyframes menuSlideIn {
from {
  opacity: 0;
  transform: translateY(-20px) scale(0.95);
}
to {
  opacity: 1;
  transform: translateY(0) scale(1);
}
}

@keyframes menuSlideOut {
from {
  opacity: 1;
  transform: translateY(0) scale(1);
}
to {
  opacity: 0;
  transform: translateY(-20px) scale(0.95);
}
}

.hamburger-header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 16px 20px;
border-bottom: 1px solid var(--border-color);
}

.hamburger-header h3 {
margin: 0;
font-size: 18px;
font-weight: 600;
color: var(--text-primary);
}

.close-btn {
background: none;
border: none;
font-size: 24px;
color: var(--text-secondary);
cursor: pointer;
width: 32px;
height: 32px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.2s ease;
}

.close-btn:hover {
background: var(--bg-tertiary);
color: var(--text-primary);
}

.hamburger-items {
padding: 8px 0;
}

.hamburger-item {
width: 100%;
background: none;
border: none;
padding: 12px 20px;
display: flex;
align-items: center;
gap: 12px;
cursor: pointer;
transition: all 0.2s ease;
text-align: left;
}

.hamburger-item:hover {
background: var(--bg-tertiary);
}

.hamburger-item-icon {
font-size: 20px;
width: 24px;
text-align: center;
}

.hamburger-item-text {
font-size: 16px;
font-weight: 500;
color: var(--text-primary);
}

/* Mobile Optimierungen fÃ¼r Hamburger-MenÃ¼ */
@media (max-width: 768px) {
  .hamburger-menu-overlay.active {
    padding: 10px;
  }
  
  .hamburger-menu {
    min-width: 240px;
    max-width: calc(100vw - 20px);
  }
  
  .hamburger-item {
    padding: 14px 20px;
  }
  
  .hamburger-item-text {
    font-size: 17px;
  }
}

/* STUDENT CARDS - GENAU WIE IM BILD */
.student-grid {
display: grid;
gap: 16px;
}

.student-card {
background: var(--bg-secondary);
border-radius: 12px;
padding: 20px;
box-shadow: 0 1px 3px var(--shadow-color);
cursor: pointer;
transition: all 0.2s;
position: relative;
touch-action: manipulation;
user-select: none;
-webkit-tap-highlight-color: transparent;
}

.student-card:hover {
box-shadow: 0 4px 12px var(--shadow-hover);
transform: translateY(-2px);
}

.student-card:active {
transform: scale(0.98);
}

.student-info {
display: flex;
align-items: flex-start;
gap: 16px;
margin-bottom: 16px;
}

.student-avatar {
width: 50px;
height: 50px;
background: #e0f2fe;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 24px;
flex-shrink: 0;
}

.student-details {
color: var(--text-primary);
font-size: 14px;
line-height: 1.6;
}

.student-name {
font-size: 20px;
font-weight: 600;
color: var(--text-primary);
margin-bottom: 4px;
}

.student-phone {
color: var(--text-primary);
font-size: 14px;
margin-bottom: 2px;
}

.student-date {
color: var(--text-primary);
font-size: 14px;
}

/* HÃ–HERE SPEZIFITÃ„T FÃœR DARK MODE */
[data-theme="dark"] .student-phone {
color: #ffffff !important;
}

[data-theme="dark"] .student-date {
color: #ffffff !important;
}

/* ZUSÃ„TZLICH FÃœR ALLE STUDENT DETAILS */
[data-theme="dark"] .student-details {
color: #ffffff !important;
}

.student-phone {
color: #6b7280;
font-size: 14px;
margin-bottom: 8px;
display: flex;
align-items: center;
gap: 6px;
}

.student-date {
color: #6b7280;
font-size: 14px;
}

.student-progress {
color: #dc2626;
font-weight: 600;
font-size: 16px;
}

.progress-bar {
height: 4px;
background: #e5e7eb;
border-radius: 2px;
margin-top: 12px;
overflow: hidden;
}

.progress-fill {
height: 100%;
background: #dc2626;
border-radius: 2px;
transition: width 0.5s ease;
}

/* LÃ–SCH-BUTTON - ROTES MÃœLLEIMER-ICON */
.delete-btn {
position: absolute;
top: 16px;
right: 16px;
width: 32px;
height: 32px;
background: none;
border: none;
cursor: pointer;
color: #dc2626;
font-size: 18px;
display: flex;
align-items: center;
justify-content: center;
border-radius: 6px;
transition: all 0.2s;
touch-action: manipulation;
user-select: none;
-webkit-tap-highlight-color: transparent;
}

.delete-btn:hover {
background: #fee2e2;
}

/* DETAIL VIEW */
.detail-header {
background: var(--bg-secondary);
padding: 16px 24px;
display: flex;
align-items: center;
gap: 16px;
box-shadow: 0 1px 3px var(--shadow-color);
position: relative;
}

.detail-header .header-left {
display: flex;
align-items: center;
gap: 16px;
}

.detail-header .header-center {
position: absolute;
left: 50%;
transform: translateX(-50%);
}

.detail-header .header-right {
display: flex;
align-items: center;
gap: 16px;
margin-left: auto;
}

.back-btn {
width: 40px;
height: 40px;
background: var(--bg-tertiary);
border: 1px solid var(--border-color);
cursor: pointer;
font-size: 20px;
color: var(--text-primary);
display: flex;
align-items: center;
justify-content: center;
border-radius: 8px;
transition: all 0.2s;
touch-action: manipulation;
user-select: none;
-webkit-tap-highlight-color: transparent;
}

.back-btn:hover {
background: #f3f4f6;
}

.detail-title {
font-size: 24px;
font-weight: 600;
color: var(--text-primary);
flex: 1;
}

.edit-btn {
width: 40px;
height: 40px;
background: none;
border: none;
cursor: pointer;
font-size: 18px;
color: #6b7280;
display: flex;
align-items: center;
justify-content: center;
border-radius: 8px;
transition: all 0.2s;
touch-action: manipulation;
user-select: none;
-webkit-tap-highlight-color: transparent;
}

.edit-btn:hover {
background: #f3f4f6;
color: #374151;
}

/* SECTIONS */
.section {
background: var(--bg-secondary);
border-radius: 12px;
padding: 24px;
margin-bottom: 16px;
box-shadow: 0 1px 3px var(--shadow-color);
}

.section-header {
display: flex;
align-items: center;
gap: 12px;
margin-bottom: 20px;
}

.section-icon {
font-size: 20px;
}

.section-title {
font-size: 22px;
font-weight: 600;
color: var(--text-primary);
}

/* PERSONAL INFO */
.info-grid {
display: grid;
gap: 12px;
}

.info-item {
display: flex;
align-items: center;
gap: 12px;
padding: 8px 0;
}

.info-icon {
color: var(--text-secondary);
font-size: 16px;
width: 20px;
}

.info-text {
color: var(--text-primary);
font-size: 15px;
}

/* FAHRT SECTIONS - NEUE KREIS-FUNKTIONALITÃ„T */
.fahrt-section {
margin-bottom: 24px;
}

.fahrt-title {
font-size: 16px;
font-weight: 600;
color: var(--text-primary);
margin-bottom: 12px;
}

.fahrt-buttons {
display: flex;
flex-wrap: wrap;
gap: 8px;
align-items: center;
}

/* NEUE KREIS-BUTTONS - GENAU WIE IM BILD */
.circle-btn {
width: 44px;
height: 44px;
border-radius: 50%;
border: 3px solid var(--blue-secondary);
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.2s;
background: var(--bg-secondary);
position: relative;
touch-action: manipulation;
user-select: none;
-webkit-tap-highlight-color: transparent;
overflow: hidden;
}

.circle-btn:active {
transform: scale(0.95);
}

/* FÃœLLSTÃ„NDE DER KREISE - 0%, 25%, 50%, 75%, 100% - NUR FÃœR circle-btn, NICHT quarter-circle */
.circle-btn.fill-0:not(.quarter-circle) {
background: var(--bg-secondary);
}

.circle-btn.fill-25:not(.quarter-circle)::before {
content: '';
position: absolute;
bottom: 0;
left: 0;
right: 0;
height: 25%;
background: var(--blue-secondary);
border-radius: 0 0 50px 50px;
}

.circle-btn.fill-50:not(.quarter-circle)::before {
content: '';
position: absolute;
bottom: 0;
left: 0;
right: 0;
height: 50%;
background: var(--blue-secondary);
border-radius: 0 0 50px 50px;
}

.circle-btn.fill-75:not(.quarter-circle)::before {
content: '';
position: absolute;
bottom: 0;
left: 0;
right: 0;
height: 75%;
background: var(--blue-secondary);
border-radius: 0 0 50px 50px;
}

.circle-btn.fill-100:not(.quarter-circle) {
background: var(--blue-secondary);
}

/* GRÃœNE KREISE FÃœR GRUNDSTUFE - NUR FÃœR circle-btn, NICHT quarter-circle */
.circle-btn.green:not(.quarter-circle) {
border-color: #22c55e;
}

.circle-btn.green.fill-25:not(.quarter-circle)::before {
background: #22c55e;
}

.circle-btn.green.fill-50:not(.quarter-circle)::before {
background: #22c55e;
}

.circle-btn.green.fill-75:not(.quarter-circle)::before {
background: #22c55e;
}

.circle-btn.green.fill-100:not(.quarter-circle) {
background: #22c55e;
}

/* UE-SECTION FÃœR GRUNDSTUFE - TEXT LINKS, KREISE RECHTS */
.ue-section {
margin-bottom: 16px;
display: flex;
justify-content: space-between;
align-items: center;
padding: 8px 0;
}

.ue-title {
font-size: 14px;
font-weight: 500;
color: var(--text-primary);
flex: 1;
text-align: left;
}

.ue-circles {
display: flex;
gap: 6px;
align-items: center;
}

.quarter-circles {
display: flex;
gap: 4px;
margin-left: 8px;
}

.quarter-circle {
width: 20px;
height: 20px;
border-radius: 50%;
border: 2px solid #22c55e;
cursor: pointer;
background: white;
position: relative;
overflow: hidden;
touch-action: manipulation;
}

/* TORTENSTÃœCK-FÃœLLUNG FÃœR QUARTER-CIRCLES - GRAU/GRÃœN STATT WEISS/GRÃœN */
.quarter-circle.pie-0 {
background: var(--bg-secondary);
}

.quarter-circle.pie-25 {
background: conic-gradient(#22c55e 0deg 90deg, var(--bg-secondary) 90deg 360deg);
}

.quarter-circle.pie-50 {
background: conic-gradient(#22c55e 0deg 180deg, var(--bg-secondary) 180deg 360deg);
}

.quarter-circle.pie-75 {
background: conic-gradient(#22c55e 0deg 270deg, var(--bg-secondary) 270deg 360deg);
}

.quarter-circle.pie-100 {
background: #22c55e;
}

.fahrt-status {
margin-left: 12px;
color: #6b7280;
font-size: 14px;
}

/* ADD BUTTONS - BEHALTEN WIR FÃœR ÃœBUNGSSTUNDEN */
.fahrt-btn.add {
background: #2563eb;
color: white;
font-size: 20px;
font-weight: bold;
width: 44px;
height: 44px;
border-radius: 50%;
border: none;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
}

.fahrt-btn.add-green {
background: #22c55e;
color: white;
font-size: 20px;
font-weight: bold;
width: 44px;
height: 44px;
border-radius: 50%;
border: none;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
}

/* AUSBILDUNGSFORTSCHRITT - GENAU WIE IM BILD */
.training-section {
background: var(--bg-secondary);
border-radius: 12px;
margin-bottom: 16px;
overflow: hidden;
box-shadow: 0 1px 3px var(--shadow-color);
}

.training-header {
padding: 20px 24px;
cursor: pointer;
display: flex;
align-items: center;
border-left: 4px solid var(--border-color);
transition: all 0.2s;
touch-action: manipulation;
user-select: none;
-webkit-tap-highlight-color: transparent;
background: var(--bg-secondary);
}

.training-header:hover {
background: var(--bg-secondary);
}

/* BANNER LAYOUT: [Streifen] [Text] [Kreise] ........ [Fortschritt] */
.training-header-content {
display: flex;
align-items: center;
width: 100%;
gap: 16px;
}

.training-header-content .training-info {
flex: 0 0 auto; /* Text nimmt nur benÃ¶tigten Platz */
}

.training-header-content .training-circles-container {
flex: 0 0 auto; /* Kreise direkt nach Text */
display: flex;
flex-direction: column;
gap: 4px;
}

.training-header-content .training-progress {
flex: 0 0 auto; /* Fortschritt */
margin-left: auto; /* Schiebt ihn ganz nach rechts */
display: flex;
align-items: center;
gap: 12px;
}

/* FÃœR KATEGORIEN OHNE KREISE */
.training-info-without-circles {
display: flex;
align-items: center;
flex: 1;
}

.training-info-without-circles .training-info {
flex: 0 0 auto; /* Text nimmt nur benÃ¶tigten Platz */
}

/* FARBIGE SEITENBALKEN - GENAU WIE IM BILD */
.training-header.grundstufe {
border-left-color: #f59e0b;
}

/* BANNER-FARBEN NUR FÃœR KLASSE BE */
body[data-current-class="BE"] .training-header.grundstufe,
[data-class="BE"] .training-header.grundstufe {
border-left-color: #F59E0B !important; /* Braun/Orange - Kennenlernen des AnhÃ¤ngers */
}

body[data-current-class="BE"] .training-header.aufbaustufe,
[data-class="BE"] .training-header.aufbaustufe {
border-left-color: #F59E0B !important; /* Braun/Orange - Verbinden und Trennen */
}

body[data-current-class="BE"] .training-header.leistungsstufe,
[data-class="BE"] .training-header.leistungsstufe {
border-left-color: #F59E0B !important; /* Braun/Orange - Fahrzeugbedienung */
}

body[data-current-class="BE"] .training-header.grundfahraufgaben,
[data-class="BE"] .training-header.grundfahraufgaben {
border-left-color: #22C55E !important; /* GrÃ¼n - Grundfahraufgabe */
}

body[data-current-class="BE"] .training-header.wichtige_fahraufgaben,
[data-class="BE"] .training-header.wichtige_fahraufgaben {
border-left-color: #3B82F6 !important; /* Blau - Wichtige Fahraufgaben */
}

body[data-current-class="BE"] .training-header.uberlandfahrten,
[data-class="BE"] .training-header.uberlandfahrten {
border-left-color: #8B5CF6 !important; /* Lila - Bundes-/LandstraÃŸen */
}

body[data-current-class="BE"] .training-header.dammerung_dunkelheit,
[data-class="BE"] .training-header.dammerung_dunkelheit {
border-left-color: #F97316 !important; /* Orange - DÃ¤mmerung/Dunkelheit */
}

body[data-current-class="BE"] .training-header.autobahn,
[data-class="BE"] .training-header.autobahn {
border-left-color: #06B6D4 !important; /* TÃ¼rkis - Autobahnen */
}

body[data-current-class="BE"] .training-header.reife_teststufe,
[data-class="BE"] .training-header.reife_teststufe {
border-left-color: #EAB308 !important; /* Gelb - RÃ¼ckwÃ¤rtsfahren */
}

/* BANNER-FARBEN FÃœR A-KLASSEN (A, A1, A2, AM) */
body[data-current-class="A"] .training-header.grundstufe,
body[data-current-class="A1"] .training-header.grundstufe,
body[data-current-class="A2"] .training-header.grundstufe,
body[data-current-class="AM"] .training-header.grundstufe,
[data-class="A"] .training-header.grundstufe,
[data-class="A1"] .training-header.grundstufe,
[data-class="A2"] .training-header.grundstufe,
[data-class="AM"] .training-header.grundstufe {
border-left-color: #F59E0B !important; /* Orange/Braun - Grundstufe */
}

body[data-current-class="A"] .training-header.aufbaustufe,
body[data-current-class="A1"] .training-header.aufbaustufe,
body[data-current-class="A2"] .training-header.aufbaustufe,
body[data-current-class="AM"] .training-header.aufbaustufe,
[data-class="A"] .training-header.aufbaustufe,
[data-class="A1"] .training-header.aufbaustufe,
[data-class="A2"] .training-header.aufbaustufe,
[data-class="AM"] .training-header.aufbaustufe {
border-left-color: #F97316 !important; /* Orange-Rot - Aufbaustufe */
}

body[data-current-class="A"] .training-header.leistungsstufe,
body[data-current-class="A1"] .training-header.leistungsstufe,
body[data-current-class="A2"] .training-header.leistungsstufe,
body[data-current-class="AM"] .training-header.leistungsstufe,
[data-class="A"] .training-header.leistungsstufe,
[data-class="A1"] .training-header.leistungsstufe,
[data-class="A2"] .training-header.leistungsstufe,
[data-class="AM"] .training-header.leistungsstufe {
border-left-color: #EF4444 !important; /* Rot - Leistungsstufe */
}

body[data-current-class="A"] .training-header.reifestufe,
body[data-current-class="A1"] .training-header.reifestufe,
body[data-current-class="A2"] .training-header.reifestufe,
body[data-current-class="AM"] .training-header.reifestufe,
[data-class="A"] .training-header.reifestufe,
[data-class="A1"] .training-header.reifestufe,
[data-class="A2"] .training-header.reifestufe,
[data-class="AM"] .training-header.reifestufe {
border-left-color: #22C55E !important; /* GrÃ¼n - Reifestufe */
}

body[data-current-class="A"] .training-header.checkliste,
body[data-current-class="A1"] .training-header.checkliste,
body[data-current-class="A2"] .training-header.checkliste,
body[data-current-class="AM"] .training-header.checkliste,
[data-class="A"] .training-header.checkliste,
[data-class="A1"] .training-header.checkliste,
[data-class="A2"] .training-header.checkliste,
[data-class="AM"] .training-header.checkliste {
border-left-color: #06B6D4 !important; /* TÃ¼rkis - Checkliste */
}

body[data-current-class="A"] .training-header.uberlandfahrten,
body[data-current-class="A1"] .training-header.uberlandfahrten,
body[data-current-class="A2"] .training-header.uberlandfahrten,
body[data-current-class="AM"] .training-header.uberlandfahrten,
[data-class="A"] .training-header.uberlandfahrten,
[data-class="A1"] .training-header.uberlandfahrten,
[data-class="A2"] .training-header.uberlandfahrten,
[data-class="AM"] .training-header.uberlandfahrten {
border-left-color: #EAB308 !important; /* Gelb - Ãœberland */
}

body[data-current-class="A"] .training-header.autobahn,
body[data-current-class="A1"] .training-header.autobahn,
body[data-current-class="A2"] .training-header.autobahn,
body[data-current-class="AM"] .training-header.autobahn,
[data-class="A"] .training-header.autobahn,
[data-class="A1"] .training-header.autobahn,
[data-class="A2"] .training-header.autobahn,
[data-class="AM"] .training-header.autobahn {
border-left-color: #EAB308 !important; /* Gelb - Autobahn */
}

body[data-current-class="A"] .training-header.dammerung_dunkelheit,
body[data-current-class="A1"] .training-header.dammerung_dunkelheit,
body[data-current-class="A2"] .training-header.dammerung_dunkelheit,
body[data-current-class="AM"] .training-header.dammerung_dunkelheit,
[data-class="A"] .training-header.dammerung_dunkelheit,
[data-class="A1"] .training-header.dammerung_dunkelheit,
[data-class="A2"] .training-header.dammerung_dunkelheit,
[data-class="AM"] .training-header.dammerung_dunkelheit {
border-left-color: #EAB308 !important; /* Gelb - DÃ¤mmerung/Dunkelheit */
}

/* EINHEITLICHES TRAINING HEADER LAYOUT FÃœR ALLE KATEGORIEN */
.training-info-with-circles {
display: flex;
align-items: center;
gap: 16px;
flex: 1;
}

.training-info-with-circles .training-info {
flex: 0 0 auto; /* Text nimmt nur benÃ¶tigten Platz */
}

.training-info-with-circles .grundstufe-circles {
flex: 0 0 auto; /* Kreise direkt nach Text */
display: flex;
flex-direction: column;
gap: 4px;
}

/* UNIVERSELLES VERTIKALES DESIGN - FÃœR ALLE BILDSCHIRMGRÃ–SSEN */
/* TRAINING-HEADER IMMER VERTIKAL */
.training-header {
  display: flex !important;
  flex-direction: column !important;
  align-items: stretch !important;
  gap: 0 !important;
  padding: 20px 24px;
}

.training-info-with-circles {
  display: flex !important;
  flex-direction: column !important;
  align-items: stretch !important;
  gap: 0 !important;
  order: 1 !important;
}

.training-info-with-circles .training-info {
  flex: none !important;
  width: 100% !important;
  text-align: center !important;
  margin-bottom: 12px !important;
  padding: 16px !important;
}

.training-info-with-circles .grundstufe-circles {
  flex: none !important;
  width: 100% !important;
  display: flex !important;
  flex-direction: column !important;
  justify-content: center !important;
  align-items: center !important;
  margin-bottom: 12px !important;
  padding: 16px !important;
  gap: 8px !important;
}

/* PROGRESS IMMER ZENTRIERT UNTER SUBTITEL */
.training-header .training-progress {
  order: 2 !important;
  width: 100% !important;
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  margin-left: 0 !important;
  padding: 16px !important;
  gap: 12px !important;
}

/* ALLE TRAINING INFO TEXTE ZENTRIERT */
.training-info h3,
.training-subtitle {
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
  hyphens: auto !important;
  white-space: normal !important;
  text-align: center !important;
}

.training-subtitle {
  max-width: 100% !important;
  padding: 0 8px !important;
  margin-top: 4px !important;
}

/* KREISE IMMER ZENTRIERT */
.circle-row {
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  flex-wrap: wrap !important;
  gap: 8px !important;
  width: 100% !important;
  margin: 6px 0 !important;
}

/* MOBILE SPEZIFISCHE ANPASSUNGEN - NUR FÃœR KLEINERE PADDINGS/FONTS */
@media (max-width: 768px) {
.container {
  padding: 16px;
}

.main-header {
  padding: 16px 20px;
}

.main-header h1 {
  font-size: 24px;
}

.training-header {
  padding: 16px 20px !important;
}

.training-info-with-circles .training-info {
  padding: 12px !important;
  margin-bottom: 8px !important;
}

.training-info-with-circles .grundstufe-circles {
  padding: 12px !important;
  margin-bottom: 8px !important;
}

.training-header .training-progress {
  padding: 12px !important;
  gap: 8px !important;
}
}

.circle-row {
display: flex;
gap: 4px;
align-items: center;
}

.ue-circle {
width: 24px;
height: 24px;
border-radius: 50%;
border: 2px solid var(--green-primary);
background: var(--green-primary);
color: white;
display: flex;
align-items: center;
justify-content: center;
font-size: 10px;
font-weight: bold;
transition: all 0.2s;
touch-action: manipulation;
cursor: pointer;
}

/* LEERE UE-KREISE */
.ue-circle.empty {
background: var(--bg-secondary);
color: var(--green-primary);
}

.ue-circle:hover {
transform: scale(1.1);
}

/* BLAUE KREISE FÃœR ÃœBERLANDFAHRTEN */
.ue-circle.blue-empty {
background: var(--bg-secondary);
border-color: var(--blue-secondary);
color: var(--blue-secondary);
}

.ue-circle.blue-filled {
background: var(--blue-secondary);
border-color: var(--blue-secondary);
color: white;
}

.quarter-circle {
width: 24px;
height: 24px;
border-radius: 50%;
border: 2px solid #22c55e;
background: var(--bg-secondary);
cursor: pointer;
position: relative;
overflow: hidden;
transition: all 0.2s;
touch-action: manipulation;
}

.quarter-circle:hover {
transform: scale(1.1);
}

/* QUARTER-CIRCLE FÃœLLUNGEN - GRÃœN VON UNTEN NACH OBEN */
.quarter-circle.fill-25::before {
content: '';
position: absolute;
bottom: 0;
left: 0;
right: 0;
height: 25%;
background: #22c55e !important;
border-radius: 0 0 20px 20px;
z-index: 1;
}

.quarter-circle.fill-50::before {
content: '';
position: absolute;
bottom: 0;
left: 0;
right: 0;
height: 50%;
background: #22c55e !important;
border-radius: 0 0 20px 20px;
z-index: 1;
}

.quarter-circle.fill-75::before {
content: '';
position: absolute;
bottom: 0;
left: 0;
right: 0;
height: 75%;
background: #22c55e !important;
border-radius: 0 0 20px 20px;
z-index: 1;
}

.quarter-circle.fill-100 {
background: #22c55e !important;
}

.add-circle-btn {
width: 24px;
height: 24px;
border-radius: 50%;
border: 2px solid var(--green-primary);
background: var(--bg-secondary);
color: var(--green-primary);
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
font-size: 16px;
font-weight: bold;
transition: all 0.2s;
touch-action: manipulation;
}

.add-circle-btn:hover {
background: var(--bg-tertiary);
transform: scale(1.1);
}

.training-header.aufbaustufe {
border-left-color: #f97316;
}

.training-header.leistungsstufe {
border-left-color: #ef4444;
}

.training-header.grundfahraufgaben {
border-left-color: #f59e0b;
}

.training-header.uberlandfahrten {
border-left-color: #eab308;
}

.training-header.autobahn {
border-left-color: #eab308;
}

.training-header.dammerung_dunkelheit {
border-left-color: #eab308;
}

.training-header.reife_teststufe {
border-left-color: #22c55e;
}

.training-header.situative_bausteine {
border-left-color: #60a5fa;
}

.training-header.fahrerassistenzsysteme {
border-left-color: #60a5fa;
}

.training-header.beim_fahrer {
border-left-color: #60a5fa;
}

.training-header.heizung_luftung {
border-left-color: #60a5fa;
}

.training-header.betriebs_verkehrssicherheit {
border-left-color: #60a5fa;
}

.training-header.witterung {
border-left-color: #60a5fa;
}

.training-info h3 {
font-size: 22px;
font-weight: 600;
color: var(--text-primary);
margin-bottom: 4px;
}

.training-subtitle {
color: var(--text-secondary);
font-size: 14px;
line-height: 1.4;
}

.training-progress {
display: flex;
align-items: center;
gap: 12px;
}

/* ROTE FORTSCHRITTS-PUNKTE - GENAU WIE IM BILD */
.progress-circle {
width: 12px;
height: 12px;
border-radius: 50%;
background: var(--red-primary);
}

.progress-text {
color: var(--red-primary);
font-weight: 600;
}

.progress-count {
color: var(--text-secondary);
font-size: 13px;
}

/* DROPDOWN-PFEILE */
.dropdown-arrow {
color: #9ca3af;
font-size: 16px;
transition: transform 0.2s;
}

.training-content {
max-height: 0;
overflow: hidden;
transition: max-height 0.3s ease;
}

.training-content.expanded {
max-height: 2500px;
}

.training-content.expanded .dropdown-arrow {
transform: rotate(180deg);
}

.training-items {
padding: 20px 24px;
border-top: 1px solid var(--border-color);
}

.progress-item {
display: flex;
align-items: center;
gap: 12px;
padding: 8px 0;
}

.comment-btn {
background: none;
border: none;
font-size: 16px;
cursor: pointer;
opacity: 0.5;
transition: opacity 0.2s;
padding: 4px;
border-radius: 4px;
margin-left: auto;
}

.comment-btn:hover {
opacity: 1;
background: #f3f4f6;
}

.comment-btn.has-comment {
opacity: 1;
background: #dbeafe;
color: #1d4ed8;
}

.progress-checkbox {
width: 24px;
height: 24px;
border: 2px solid #d1d5db;
border-radius: 4px;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
transition: all 0.2s;
font-size: 14px;
font-weight: bold;
background: white;
touch-action: manipulation;
user-select: none;
-webkit-tap-highlight-color: transparent;
}

.progress-checkbox:hover {
border-color: #9ca3af;
transform: scale(1.05);
}

.progress-checkbox.once {
background: #fef3c7;
color: #a16207;
border-color: #f59e0b;
}

.progress-checkbox.twice {
background: #dbeafe;
color: #1d4ed8;
border-color: #3b82f6;
}

.progress-checkbox.thrice {
background: #dcfce7;
color: #15803d;
border-color: #22c55e;
}

.progress-item-text {
color: var(--text-primary);
font-size: 15px;
line-height: 1.4;
}

/* SECTION DIVIDER FOR TRAINING ITEMS */
.section-divider {
  height: 1px;
  background: linear-gradient(to right, var(--border-color) 50%, transparent 50%);
  background-size: 8px 1px;
  margin: 16px 0;
  opacity: 0.6;
}

/* DIALOG STYLES - NEUER SCHÃœLER */
.dialog-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.5);
display: flex;
align-items: center;
justify-content: center;
z-index: 1000;
opacity: 0;
animation: fadeIn 0.2s ease forwards;
}

@keyframes fadeIn {
to { opacity: 1; }
}

.dialog {
background: var(--bg-secondary);
border-radius: 16px;
padding: 24px;
max-width: 400px;
width: 90%;
max-height: 80vh;
overflow-y: auto;
box-shadow: 0 20px 40px rgba(0,0,0,0.3);
transform: scale(0.9);
animation: scaleIn 0.2s ease forwards;
}

@keyframes scaleIn {
to { transform: scale(1); }
}

.dialog h2 {
margin-bottom: 20px;
color: var(--text-primary);
font-size: 20px;
font-weight: 600;
}

.form-group {
margin-bottom: 16px;
}

.form-group label {
display: block;
margin-bottom: 6px;
font-weight: 500;
color: var(--text-primary);
font-size: 14px;
}

.form-group input {
width: 100%;
padding: 12px;
border: 2px solid var(--border-color);
border-radius: 8px;
font-size: 16px;
transition: border-color 0.2s;
background: var(--bg-tertiary);
color: var(--text-primary);
}

.form-group input[type="checkbox"] {
width: auto;
padding: 0;
margin-right: 8px;
accent-color: var(--blue-primary);
}

.form-group input:focus {
outline: none;
border-color: var(--blue-primary);
}

.dialog-buttons {
display: flex;
gap: 12px;
margin-top: 24px;
}

.btn-secondary {
background: var(--bg-tertiary);
color: var(--text-primary);
padding: 12px 20px;
border: 1px solid var(--border-color);
border-radius: 8px;
cursor: pointer;
flex: 1;
font-weight: 500;
font-size: 16px;
transition: all 0.2s;
}

.btn-secondary:hover {
background: var(--bg-primary);
border-color: var(--text-tertiary);
}

/* LOADING */
.loading {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
min-height: 100vh;
text-align: center;
}

.spinner {
width: 48px;
height: 48px;
border: 4px solid #e5e7eb;
border-left: 4px solid #2563eb;
border-radius: 50%;
animation: spin 1s linear infinite;
margin-bottom: 16px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.loading-title {
font-size: 18px;
font-weight: 500;
color: #6b7280;
margin-bottom: 8px;
}

.loading-subtitle {
font-size: 14px;
color: #9ca3af;
}

/* PRINT-CSS FÃœR PDF-EXPORT - MOBILE OPTIMIERT */
@media print {
  /* Verstecke alle normalen UI-Elemente */
  * {
    -webkit-print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  
  body > *:not(.print-document) {
    display: none !important;
  }
  
  /* Print-Dokument Styling */
  .print-document {
    display: block !important;
    visibility: visible !important;
    margin: 0 !important;
    padding: 15px !important;
    font-family: Arial, sans-serif !important;
    font-size: 11pt !important;
    line-height: 1.3 !important;
    color: black !important;
    background: white !important;
    width: 100% !important;
    min-height: 100vh !important;
  }
  
  .print-header {
    text-align: center;
    margin-bottom: 30px;
    border-bottom: 2px solid black;
    padding-bottom: 15px;
  }
  
  .print-title {
    font-size: 18pt;
    font-weight: bold;
    margin-bottom: 10px;
  }
  
  .print-student-info {
    margin-bottom: 25px;
  }
  
  .print-info-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
  }
  
  .print-info-table td {
    padding: 5px 10px;
    border: 1px solid #ccc;
    vertical-align: top;
  }
  
  .print-info-table .label {
    font-weight: bold;
    background-color: #f5f5f5;
    width: 30%;
  }
  
  .print-category {
    margin-bottom: 20px;
    page-break-inside: avoid;
  }
  
  .print-category-title {
    font-size: 14pt;
    font-weight: bold;
    background-color: #e0f2fe;
    padding: 8px;
    border: 2px solid #0369a1;
    margin-bottom: 10px;
  }
  
  .print-items {
    margin-left: 20px;
    margin-bottom: 15px;
  }
  
  .print-item {
    margin-bottom: 3px;
    display: flex;
    align-items: center;
  }
  
  .print-checkbox {
    width: 15px;
    height: 15px;
    border: 2px solid black;
    margin-right: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 10pt;
  }
  
  .print-checkbox.checked-once { background-color: #fef3c7; }
  .print-checkbox.checked-twice { background-color: #dbeafe; }
  .print-checkbox.checked-thrice { background-color: #dcfce7; }
  
  .print-summary {
    margin-top: 30px;
    page-break-inside: avoid;
  }
  
  .print-summary-title {
    font-size: 14pt;
    font-weight: bold;
    margin-bottom: 15px;
    text-align: center;
    background-color: #f0f9ff;
    padding: 10px;
    border: 2px solid #0369a1;
  }
  
  .print-summary-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
  }
  
  .print-summary-table th,
  .print-summary-table td {
    padding: 8px 12px;
    border: 2px solid black;
    text-align: center;
  }
  
  .print-summary-table th {
    background-color: #f5f5f5;
    font-weight: bold;
  }
  
  .print-signatures {
    margin-top: 40px;
    page-break-inside: avoid;
  }
  
  .print-signature-text {
    margin-bottom: 20px;
    text-align: center;
    font-style: italic;
  }
  
  .print-signature-fields {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
  }
  
  .print-signature-field {
    width: 45%;
    text-align: center;
  }
  
  .print-signature-line {
    border-bottom: 2px solid black;
    height: 40px;
    margin-bottom: 5px;
  }
  
  .print-signature-label {
    font-weight: bold;
  }
  
  .print-date {
    margin-bottom: 20px;
    text-align: right;
  }
  
  .print-date-line {
    display: inline-block;
    border-bottom: 2px solid black;
    width: 150px;
    height: 25px;
  }
}

/* Verstecke Print-Dokument in normaler Ansicht */
.print-document {
  display: none;
}

/* RESPONSIVE */
/* RESPONSIVE - IPHONE & MOBILE OPTIMIERUNGEN */
@media (max-width: 768px) {
.container {
padding: 16px;
}

.main-header {
padding: 16px 20px;
}

.main-header h1 {
font-size: 24px;
}

.detail-header {
padding: 12px 20px;
}

.section {
padding: 20px;
}

/* 3-CONTAINER SYSTEM - WIE IM DIAGRAMM */

/* HAUPT-CONTAINER: TRAINING-HEADER WIRD ZU FLEXBOX */
.training-header-content,
.training-info-with-circles {
  display: flex !important;
  flex-direction: column !important;
  align-items: stretch !important;
  gap: 0 !important;
  width: 100% !important;
}

/* CONTAINER 1: TEXT-BEREICH (TITEL + SUBTITEL) */
.training-header-content .training-info,
.training-info-with-circles .training-info {
  width: 100% !important;
  text-align: center !important;
  padding: 12px !important;
  margin: 0 0 8px 0 !important;
  order: 1 !important;
}

.training-header-content .training-info h3,
.training-info-with-circles .training-info h3 {
  font-size: 20px !important;
  line-height: 1.3 !important;
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
  white-space: normal !important;
  margin: 0 0 4px 0 !important;
  text-align: center !important;
}

.training-header-content .training-subtitle,
.training-info-with-circles .training-subtitle {
  font-size: 13px !important;
  line-height: 1.4 !important;
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
  white-space: normal !important;
  hyphens: auto !important;
  text-align: center !important;
  margin: 0 !important;
}

/* CONTAINER 2: KREISE-BEREICH */
.training-header-content .training-circles-container,
.training-header-content .grundstufe-circles,
.training-info-with-circles .grundstufe-circles {
  width: 100% !important;
  padding: 12px !important;
  margin: 0 0 8px 0 !important;
  order: 2 !important;
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 8px !important;
}

/* KREISE-REIHEN ZENTRIERT */
.circle-row {
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  gap: 8px !important;
  flex-wrap: wrap !important;
  width: 100% !important;
}

/* CONTAINER 3: FORTSCHRITT-BEREICH - MOBILE ZENTRIERT */
.training-header-content .training-progress,
.training-info-with-circles + .training-progress,
.training-header .training-progress {
  width: 100% !important;
  padding: 12px !important;
  margin: 0 !important;
  margin-left: 0 !important;
  order: 3 !important;
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  gap: 8px !important;
}

/* FÃœR KATEGORIEN OHNE KREISE */
.training-info-without-circles {
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  text-align: center !important;
  width: 100% !important;
}

/* ALLE TRAINING-INFO TEXTE RESPONSIVE */
.training-info h3,
.training-subtitle {
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
  hyphens: auto !important;
  white-space: normal !important;
  text-align: center !important;
}

/* SPEZIELLE REGEL FÃœR SEHR LANGE SUBTITEL */
.training-subtitle {
  max-width: 100% !important;
  padding: 0 8px !important;
}

/* NUCLEAR OPTION - HÃ–CHSTE SPEZIFITÃ„T - 3-CONTAINER SYSTEM */
body .training-header {
  display: flex !important;
  flex-direction: column !important;
  align-items: stretch !important;
  gap: 0 !important;
}

body .training-header .training-info-with-circles {
  display: flex !important;
  flex-direction: column !important;
  align-items: stretch !important;
  gap: 0 !important;
  width: 100% !important;
  order: 1 !important;
}

/* CONTAINER 1: TEXT - OHNE BORDER */
body .training-header .training-info-with-circles .training-info {
  width: 100% !important;
  text-align: center !important;
  padding: 12px !important;
  margin: 0 0 8px 0 !important;
  order: 1 !important;
}

/* CONTAINER 2: KREISE - OHNE BORDER */
body .training-header .training-info-with-circles .grundstufe-circles {
  width: 100% !important;
  display: flex !important;
  flex-direction: column !important;
  justify-content: center !important;
  align-items: center !important;
  padding: 12px !important;
  margin: 0 0 8px 0 !important;
  gap: 8px !important;
  order: 2 !important;
}

/* CONTAINER 3: FORTSCHRITT - MOBILE ZENTRIERT */
body .training-header .training-progress {
  width: 100% !important;
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  margin: 0 !important;
  margin-left: 0 !important;
  margin-top: 0 !important;
  padding: 12px !important;
  gap: 8px !important;
  order: 3 !important;
}

/* TABLET PORTRAIT NUCLEAR OPTION */
@media (min-width: 769px) and (max-width: 1024px) and (orientation: portrait) {
body .training-header {
  display: flex !important;
  flex-direction: column !important;
  align-items: stretch !important;
  gap: 0 !important;
  padding: 20px 24px !important;
}

body .training-header .training-info-with-circles {
  display: flex !important;
  flex-direction: column !important;
  align-items: stretch !important;
  gap: 0 !important;
  order: 1 !important;
}

body .training-header .training-info-with-circles .training-info {
  padding: 16px !important;
  margin-bottom: 12px !important;
}

body .training-header .training-info-with-circles .grundstufe-circles {
  padding: 16px !important;
  margin-bottom: 12px !important;
  gap: 10px !important;
}

/* ALLE PROGRESS-ANZEIGEN SICHTBAR UND POSITIONIERT */
body .training-header .training-progress {
  padding: 16px !important;
  gap: 12px !important;
  order: 2 !important;
  width: 100% !important;
  display: flex !important;
  position: relative !important;
  z-index: 10 !important;
  min-height: 40px !important;
}

/* SPEZIFISCHE AUSRICHTUNG DURCH KLASSEN */
body .training-header .training-progress.has-circles {
  justify-content: center !important;
}

body .training-header .training-progress.no-circles {
  justify-content: center !important;
  padding-right: 0 !important;
}
}



/* HAUPT-CONTAINER MUSS VERTICAL FLEX SEIN */
body .training-header .training-info-with-circles {
  display: flex !important;
  flex-direction: column !important;
  align-items: stretch !important;
  width: 100% !important;
  gap: 0 !important;
}

/* KREISE UMBRECHEN LASSEN */
.circle-row {
  justify-content: center !important;
  flex-wrap: wrap !important;
  gap: 8px !important;
}
}

/* TABLET PORTRAIT - NUR FÃœR GRÃ–SSERE SCHRIFT/PADDING */
@media (min-width: 769px) and (max-width: 1024px) and (orientation: portrait) {
.container {
  padding: 24px;
  max-width: 100%;
}

.main-header {
  padding: 20px 24px;
}

.main-header h1 {
  font-size: 26px;
}

.training-header {
  padding: 20px 24px !important;
}

.training-info-with-circles .training-info {
  padding: 16px !important;
  margin-bottom: 12px !important;
}

.training-info-with-circles .grundstufe-circles {
  padding: 16px !important;
  margin-bottom: 12px !important;
  gap: 10px !important;
}

.training-header .training-progress {
  padding: 16px !important;
  gap: 12px !important;
}

/* KREISE GRÃ–ÃŸER FÃœR TABLET */
.ue-circle {
  width: 36px !important;
  height: 36px !important;
  font-size: 12px !important;
}

.quarter-circle {
  width: 32px !important;
  height: 32px !important;
}
}

/* DESKTOP - NUR FÃœR GRÃ–SSERE FONTS UND PADDING */
@media (min-width: 1025px) {
.container {
  padding: 32px;
  max-width: 1200px;
}

.main-header {
  padding: 24px 32px;
}

.main-header h1 {
  font-size: 28px;
}

.training-header {
  padding: 24px 32px !important;
}

.training-info-with-circles .training-info {
  padding: 20px !important;
  margin-bottom: 16px !important;
}

.training-info-with-circles .grundstufe-circles {
  padding: 20px !important;
  margin-bottom: 16px !important;
  gap: 12px !important;
}

.training-header .training-progress {
  padding: 20px !important;
  gap: 16px !important;
}

/* GRÃ–SSERE KREISE FÃœR DESKTOP */
.ue-circle {
  width: 40px !important;
  height: 40px !important;
  font-size: 14px !important;
}

.quarter-circle {
  width: 36px !important;
  height: 36px !important;
}

.training-info h3 {
  font-size: 24px !important;
}

.training-subtitle {
  font-size: 16px !important;
}
}


/* MOBILE QUERFORMAT - NUR FÃœR KLEINE HANDYS */
@media (max-height: 500px) and (orientation: landscape) and (max-width: 900px) {
/* ALLE MOBILE-REGELN ÃœBERNEHMEN */
.container {
padding: 16px;
}

.main-header {
padding: 16px 20px;
}

.main-header h1 {
font-size: 24px;
}

.detail-header {
padding: 12px 20px;
}

.section {
padding: 20px;
}

/* TRAINING-HEADERS AUCH IM QUERFORMAT VERTIKAL */
.training-header {
  display: flex !important;
  flex-direction: column !important;
  align-items: stretch !important;
  gap: 0 !important;
}

.training-info-with-circles {
  display: flex !important;
  flex-direction: column !important;
  align-items: stretch !important;
  gap: 0 !important;
  order: 1 !important;
}

.training-info-with-circles .training-info {
  flex: none !important;
  width: 100% !important;
  margin-bottom: 8px !important;
}

.training-info-with-circles .grundstufe-circles {
  flex: none !important;
  width: 100% !important;
  justify-content: center !important;
  align-items: center !important;
  margin-bottom: 8px !important;
}

.training-header .training-progress {
  order: 2 !important;
  width: 100% !important;
  justify-content: center !important;
  margin-left: 0 !important;
}

/* ALLE MOBILE CSS-REGELN WIEDERHOLEN */
.training-header-content,
.training-info-with-circles {
  display: flex !important;
  flex-direction: column !important;
  align-items: stretch !important;
  gap: 0 !important;
  width: 100% !important;
}

.training-header-content .training-info,
.training-info-with-circles .training-info {
  width: 100% !important;
  text-align: center !important;
  padding: 12px !important;
  margin: 0 0 8px 0 !important;
  order: 1 !important;
}

.training-header-content .training-info h3,
.training-info-with-circles .training-info h3 {
  font-size: 18px !important;
  line-height: 1.3 !important;
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
  white-space: normal !important;
  margin-bottom: 4px !important;
  text-align: center !important;
}

.training-header-content .training-subtitle,
.training-info-with-circles .training-subtitle {
  font-size: 13px !important;
  line-height: 1.4 !important;
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
  white-space: normal !important;
  hyphens: auto !important;
  text-align: center !important;
  margin: 0 !important;
}

.training-header-content .training-circles-container,
.training-header-content .grundstufe-circles,
.training-info-with-circles .grundstufe-circles {
  width: 100% !important;
  padding: 12px !important;
  margin: 0 0 8px 0 !important;
  order: 2 !important;
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 8px !important;
}

.circle-row {
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  gap: 8px !important;
  flex-wrap: wrap !important;
  width: 100% !important;
}

.training-header-content .training-progress,
.training-info-with-circles + .training-progress,
.training-header .training-progress {
  width: 100% !important;
  padding: 12px !important;
  margin: 0 !important;
  order: 3 !important;
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  gap: 8px !important;
}

/* NUCLEAR OPTION FÃœR QUERFORMAT */
body .training-header {
  display: flex !important;
  flex-direction: column !important;
  align-items: stretch !important;
  gap: 0 !important;
}

body .training-header .training-info-with-circles {
  display: flex !important;
  flex-direction: column !important;
  align-items: stretch !important;
  gap: 0 !important;
  width: 100% !important;
  order: 1 !important;
}
}

/* EXTRA KLEINE DISPLAYS (IPHONE PORTRAIT) */
@media (max-width: 393px) {
.container {
  padding: 12px;
}

.main-header {
  padding: 12px 16px;
  flex-direction: column;
  gap: 12px;
  text-align: center;
}

.main-header h1 {
  font-size: 20px;
}

.btn-primary {
  width: 100%;
  min-height: 48px;
}

.training-header {
  padding: 16px 20px;
}

.training-header-content .training-info h3 {
  font-size: 17px !important;
}

.training-header-content .training-subtitle {
  font-size: 12px !important;
  line-height: 1.4 !important;
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
  hyphens: auto !important;
  white-space: normal !important;
}

/* KREISE UND BUTTONS GRÃ–ÃŸER FÃœR TOUCH */
.circle-btn {
  width: 48px !important;
  height: 48px !important;
}

.ue-circle {
  width: 32px !important;
  height: 32px !important;
}

.quarter-circle {
  width: 28px !important;
  height: 28px !important;
}
}
}
</style>
</head>
<body>

<!-- React Mount Point - DISABLED -->
<div id="root" style="display: none !important;"></div>

<div id="app">
<!-- Loading Screen -->
<div id="loading" class="loading">
<div class="spinner"></div>
<div class="loading-title">Deutsche Fahrschul-App wird geladen...</div>
<div class="loading-subtitle">âœ… VollstÃ¤ndig optimierte Version - Alle Features aktiv</div>
</div>

<!-- Main Content -->
<div id="main-content" style="display: none;">
<!-- Content wird hier eingefÃ¼gt -->
</div>
</div>

<script>
// DARK MODE FUNCTIONALITY
const ThemeManager = {
  init() {
    // Theme aus LocalStorage laden oder System-PrÃ¤ferenz nutzen
    const savedTheme = localStorage.getItem('fahrschul-theme');
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initialTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
    
    this.setTheme(initialTheme);
    
    // Warte bis DOM komplett geladen ist, dann Toggle hinzufÃ¼gen
    setTimeout(() => {
      this.createToggleButton();
    }, 500);
    
    // System-PrÃ¤ferenz-Ã„nderungen Ã¼berwachen
    window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
      if (!localStorage.getItem('fahrschul-theme')) {
        this.setTheme(e.matches ? 'dark' : 'light');
      }
    });
  },

  setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('fahrschul-theme', theme);
    this.currentTheme = theme;
    this.updateToggleButton();
  },

  toggleTheme() {
    const newTheme = this.currentTheme === 'light' ? 'dark' : 'light';
    this.setTheme(newTheme);
  },

  createToggleButton() {
    // PrÃ¼fe, ob Toggle bereits existiert
    if (document.querySelector('.theme-toggle')) {
      console.log('Toggle bereits vorhanden');
      return;
    }
    
    const toggleButton = document.createElement('div');
    toggleButton.className = 'theme-toggle';
    toggleButton.innerHTML = `
      <span class="icon">ðŸŒ™</span>
    `;
    toggleButton.addEventListener('click', () => this.toggleTheme());
    
    // Suche nach header-left Container (priorisiert) - fÃ¼r konsistente Position links
    const headerLeft = document.querySelector('.header-left');
    if (headerLeft) {
      // FÃ¼ge als erstes Element in header-left ein
      headerLeft.insertBefore(toggleButton, headerLeft.firstChild);
      console.log('âœ… Toggle oben links in header-left eingefÃ¼gt');
      this.updateToggleButton();
      return;
    }
    
    // Fallback: Suche nach Header und fÃ¼ge links hinzu
    const possibleHeaders = [
      document.querySelector('.main-header'),
      document.querySelector('.detail-header'),
      document.querySelector('header'),
      document.querySelector('[class*="header"]')
    ];
    
    let headerFound = false;
    for (const header of possibleHeaders) {
      if (header) {
        console.log('Header gefunden:', header.className);
        // FÃ¼ge als erstes Element hinzu (ganz links)
        header.insertBefore(toggleButton, header.firstChild);
        headerFound = true;
        console.log('âœ… Toggle als Fallback links zu Header hinzugefÃ¼gt');
        break;
      }
    }
    
    if (!headerFound) {
      // Als letzter Ausweg: Am Anfang der body einfÃ¼gen
      document.body.insertBefore(toggleButton, document.body.firstChild);
      console.log('âš ï¸ Toggle als Fallback zu body hinzugefÃ¼gt');
    }
    
    this.updateToggleButton();
  },

  updateToggleButton() {
    const toggleButton = document.querySelector('.theme-toggle');
    if (toggleButton) {
      const icon = toggleButton.querySelector('.icon');
      
      if (this.currentTheme === 'dark') {
        icon.textContent = 'â˜€ï¸';
      } else {
        icon.textContent = 'ðŸŒ™';
      }
    }
  }
};



// âš ï¸ DEMO-DATEN ENTFERNT - KEINE AUTOMATISCHEN SCHÃœLER MEHR
const DEMO_STUDENTS = [];

// FUNKTION: Kategorien fÃ¼r spezifische Klassen abrufen
function getTrainingCategoriesForClass(className) {
  if (className === 'BE') {
    // BE verwendet B-Struktur, aber mit BE-spezifischen Texten und Inhalten
    return {
      "grundstufe": {
        "name": "Kennenlernen des AnhÃ¤ngers, Zusammenstellen der Kombination",
        "subtitle": "Grundlagen der AnhÃ¤nger-Kombination",
        "color": "#F59E0B",
        "sections": {
          "rundgang_anhanger": {
            "name": "Rundgang um den AnhÃ¤nger",
            "items": ["Rundgang um den AnhÃ¤nger"]
          },
          "zulassigkeit_kombination": {
            "name": "ZulÃ¤ssigkeit der Fahrzeugkombination prÃ¼fen", 
            "items": ["ZulÃ¤ssigkeit der Fahrzeugkombination prÃ¼fen"]
          },
          "sicherheitskontrollen": {
            "name": "Sicherheitskontrollen",
            "items": ["Sicherheitskontrollen"]
          },
          "ladungssicherung": {
            "name": "Ladungssicherung",
            "items": ["Ladungssicherung"]
          },
          "einweisung_zugfahrzeug": {
            "name": "Einweisung ins Zugfahrzeug",
            "items": ["Einweisung ins Zugfahrzeug"]
          }
        }
      },
      "aufbaustufe": {
        "name": "Verbinden und Trennen",
        "subtitle": "Kupplung und Entkupplung",
        "color": "#F59E0B",
        "sections": {
          "anhanger_ankuppeln": {
            "name": "AnhÃ¤nger ankuppeln",
            "items": ["AnhÃ¤nger ankuppeln"]
          },
          "anhanger_abkuppeln": {
            "name": "AnhÃ¤nger abkuppeln", 
            "items": ["AnhÃ¤nger abkuppeln"]
          }
        }
      },
      "leistungsstufe": {
        "name": "Fahrzeugbedienung und -beherrschung",
        "subtitle": "Bedienung der AnhÃ¤nger-Kombination",
        "color": "#F59E0B",
        "sections": {
          "anfahren_beschleunigen": {
            "name": "Anfahren, beschleunigen, schalten, rollen",
            "items": ["Anfahren, beschleunigen, schalten, rollen"]
          },
          "verzogern_bremsen": {
            "name": "VerzÃ¶gern, bremsen, anhalten",
            "items": ["VerzÃ¶gern, bremsen, anhalten"]
          },
          "zielbremsung": {
            "name": "Zielbremsung",
            "items": ["Zielbremsung"]
          },
          "gefahrbremsung": {
            "name": "Gefahrbremsung", 
            "items": ["Gefahrbremsung"]
          },
          "enge_kurven": {
            "name": "Enge Kurven",
            "items": ["Enge Kurven"]
          }
        }
      },
      "grundfahraufgaben": {
        "name": "Grundfahraufgabe",
        "subtitle": "RÃ¼ckwÃ¤rtsfahren um eine Ecke nach links",
        "color": "#22C55E",
        "sections": {
          "ruckwartsfahren_ecke": {
            "name": "RÃ¼ckwÃ¤rtsfahren um eine Ecke nach links",
            "items": ["RÃ¼ckwÃ¤rtsfahren um eine Ecke nach links"]
          }
        }
      },
      "wichtige_fahraufgaben": {
        "name": "Wichtige Fahraufgaben",
        "subtitle": "Spezielle FahrmanÃ¶ver mit AnhÃ¤nger",
        "color": "#3B82F6",
        "sections": {
          "fahren_fahrstreifen": {
            "name": "Fahren in Fahrstreifen, Fahrstreifenwechsel",
            "items": ["Fahren in Fahrstreifen, Fahrstreifenwechsel"]
          },
          "engstellen_hindernisse": {
            "name": "Engstellen und Hindernisse",
            "items": ["Engstellen und Hindernisse"]
          },
          "queren_strassen": {
            "name": "Queren von StraÃŸen",
            "items": ["Queren von StraÃŸen"]
          },
          "freihalten_kreuzungen": {
            "name": "Freihalten von Kreuzungen, Zebrastreifen, BahnÃ¼bergÃ¤ngen",
            "items": ["Freihalten von Kreuzungen, Zebrastreifen, BahnÃ¼bergÃ¤ngen"]
          },
          "kreuzung_ampelregelung": {
            "name": "Kreuzung mit Ampelregelung",
            "items": ["Kreuzung mit Ampelregelung"]
          },
          "fahrbahmarkierungen": {
            "name": "Fahrbahmarkierungen, SperrflÃ¤chen",
            "items": ["Fahrbahmarkierungen, SperrflÃ¤chen"]
          },
          "abbiegen_links": {
            "name": "Abbiegen nach links",
            "items": ["Abbiegen nach links"]
          },
          "abbiegen_rechts": {
            "name": "Abbiegen nach rechts",
            "items": ["Abbiegen nach rechts"]
          },
          "mehrspuriges_abbiegen": {
            "name": "Mehrspuriges Abbiegen",
            "items": ["Mehrspuriges Abbiegen"]
          },
          "kreisverkehr": {
            "name": "Kreisverkehr",
            "items": ["Kreisverkehr"]
          },
          "anfahren_steigung": {
            "name": "Anfahren in der Steigung",
            "items": ["Anfahren in der Steigung"]
          },
          "umkehren": {
            "name": "Umkehren",
            "items": ["Umkehren"]
          },
          "benutzen_geschwindigkeitsregelanlage": {
            "name": "Benutzen der Geschwindigkeitsregelanlage",
            "items": ["Benutzen der Geschwindigkeitsregelanlage"]
          }
        }
      },
      "uberlandfahrten": {
        "name": "Ausbildung auf Bundes- oder LandstraÃŸen",
        "subtitle": "Geschwindigkeit und Abstand, Befahren unterschiedlich breiter AuÃŸerortsstraÃŸen",
        "color": "#8B5CF6",
        "sections": {
          "geschwindigkeit_abstand": {
            "name": "Geschwindigkeit und Abstand",
            "items": ["Geschwindigkeit und Abstand"]
          },
          "befahren_unterschiedlich": {
            "name": "Befahren unterschiedlich breiter AuÃŸerortsstraÃŸen",
            "items": ["Befahren unterschiedlich breiter AuÃŸerortsstraÃŸen"]
          },
          "kurvenreiche_strecken": {
            "name": "Kurvenreiche Strecken",
            "items": ["Kurvenreiche Strecken"]
          },
          "linksabbiegen": {
            "name": "Linksabbiegen",
            "items": ["Linksabbiegen"]
          },
          "queren_vorfahrtstrassen": {
            "name": "Queren von VorfahrtstraÃŸen",
            "items": ["Queren von VorfahrtstraÃŸen"]
          },
          "abbiegen_vorfahrtstrassen": {
            "name": "Abbiegen in VorfahrtstraÃŸen",
            "items": ["Abbiegen in VorfahrtstraÃŸen"]
          },
          "uberholen": {
            "name": "Ãœberholen",
            "items": ["Ãœberholen"]
          },
          "einfahren_ortschaft": {
            "name": "Einfahren in eine Ortschaft",
            "items": ["Einfahren in eine Ortschaft"]
          },
          "einfahren_ortsspur": {
            "name": "EinfÃ¤delungsspur",
            "items": ["EinfÃ¤delungsspur"]
          },
          "gefalle": {
            "name": "GefÃ¤lle",
            "items": ["GefÃ¤lle"]
          },
          "steigung": {
            "name": "Steigung",
            "items": ["Steigung"]
          },
          "bahnubergang": {
            "name": "BahnÃ¼bergang",
            "items": ["BahnÃ¼bergang"]
          },
          "umkehren": {
            "name": "Umkehren",
            "items": ["Umkehren"]
          }
        }
      },
      "dammerung_dunkelheit": {
        "name": "Ausbildung bei DÃ¤mmerung oder Dunkelheit",
        "subtitle": "Bedienung und ÃœberprÃ¼fung der Fahrzeugbeleuchtung",
        "color": "#F97316",
        "sections": {
          "bedienung_beleuchtung": {
            "name": "Bedienung und ÃœberprÃ¼fung der Fahrzeugbeleuchtung",
            "items": ["Bedienung und ÃœberprÃ¼fung der Fahrzeugbeleuchtung"]
          },
          "einschatzen_entfernungen": {
            "name": "EinschÃ¤tzen der Fahrzeugabmessungen",
            "items": ["EinschÃ¤tzen der Fahrzeugabmessungen"]
          },
          "fahrstreifenwechsel": {
            "name": "Fahrstreifenwechsel, Einordnen",
            "items": ["Fahrstreifenwechsel, Einordnen"]
          },
          "verhalten_engstellen": {
            "name": "Verhalten an Engstellen",
            "items": ["Verhalten an Engstellen"]
          },
          "queren_abbiegen": {
            "name": "Queren und Abbiegen",
            "items": ["Queren und Abbiegen"]
          },
          "kurvenreiche_strecke": {
            "name": "Kurvenreiche Strecke",
            "items": ["Kurvenreiche Strecke"]
          },
          "problematik_ruckwartsfahren": {
            "name": "Problematik des RÃ¼ckwÃ¤rtsfahrens",
            "items": ["Problematik des RÃ¼ckwÃ¤rtsfahrens"]
          }
        }
      },
      "autobahn": {
        "name": "Ausbildung auf Autobahnen",
        "subtitle": "Einfahren in die Autobahn",
        "color": "#06B6D4",
        "sections": {
          "einfahren_autobahn": {
            "name": "Einfahren in die Autobahn",
            "items": ["Einfahren in die Autobahn"]
          },
          "geschwindigkeit": {
            "name": "Geschwindigkeit",
            "items": ["Geschwindigkeit"]
          },
          "blickwechsel": {
            "name": "Blickwechsel",
            "items": ["Blickwechsel"]
          },
          "entfernungs_abstandschatzungen": {
            "name": "Entfernungs-/AbstandschÃ¤tzungen",
            "items": ["Entfernungs-/AbstandschÃ¤tzungen"]
          },
          "uberholen": {
            "name": "Ãœberholen",
            "items": ["Ãœberholen"]
          },
          "verhalten_einfahrten": {
            "name": "Verhalten an Einfahrten",
            "items": ["Verhalten an Einfahrten"]
          },
          "baustellen": {
            "name": "Baustellen",
            "items": ["Baustellen"]
          },
          "annaherung_stau": {
            "name": "AnnÃ¤herung an einen Stau",
            "items": ["AnnÃ¤herung an einen Stau"]
          },
          "ausfahren_autobahn": {
            "name": "Ausfahren aus der Autobahn",
            "items": ["Ausfahren aus der Autobahn"]
          }
        }
      },
      "reife_teststufe": {
        "name": "RÃ¼ckwÃ¤rtsfahren, Einparken",
        "subtitle": "Ãœbungen zum RÃ¼ckwÃ¤rtsfahren",
        "color": "#EAB308",
        "sections": {
          "ubungen_ruckwartsfahren": {
            "name": "Ãœbungen zum RÃ¼ckwÃ¤rtsfahren",
            "items": ["Ãœbungen zum RÃ¼ckwÃ¤rtsfahren"]
          },
          "ruckwarts_einparken": {
            "name": "RÃ¼ckwÃ¤rts einparken",
            "items": ["RÃ¼ckwÃ¤rts einparken"]
          }
        }
      }
    };
  }
  
  if (className === 'AM') {
    // AM-Klasse (Moped/Leichtmofa) - OHNE besondere Ausbildungsfahrten
    return {
      "grundstufe": {
        "name": "Grundstufe",
        "subtitle": "Balance-Ãœbungen und Grundlagen", 
        "color": "#F59E0B",
        "sections": {
          "balance_uebungen": {
            "name": "Balance-Ãœbungen",
            "items": ["Im Stand", "Schieben", "Schieben und dosiertes Bremsen", "Schieben einer Links- und Rechtskurve", "RÃ¼ckwÃ¤rtsschieben", "Auf- und Abbocken", "SeitenstÃ¤nder", "Auf- und Absteigen"]
          },
          "sitzposition": {
            "name": "Sitzposition",
            "items": ["KÃ¶rperhaltung, FuÃŸstellung, Handstellung, Spiegeleinstellung"]
          },
          "handhabung": {
            "name": "Handhabung",
            "items": ["Starten", "1. Gang, Spiegel, Schulterblick, Blinker"]
          },
          "anfahrt_anhalte": {
            "name": "Anfahrt- und AnhalteÃ¼bungen",
            "items": ["Anfahren bis 2. Gang", "Anhalten/Leerlauf"]
          }
        }
      },
      
      "aufbaustufe": {
        "name": "Aufbaustufe",
        "subtitle": "Ãœbungen im instabilen und eigenstabilen Bereich",
        "color": "#F97316",
        "sections": {
          "instabil_uebungen": {
            "name": "Ãœbungen im Instabilen Bereich",
            "items": ["Schrittgeschwindigkeit (GF)", "Stop and Go (GF)", "Slalom in Schrittgeschwindigkeit (GF)", "Anfahren links/rechts mit Lenkeinschlag", "Wenden"]
          },
          "eigenstabil_uebungen": {
            "name": "Ãœbungen im eigenstabilen Bereich",
            "items": ["Slalom Gleich (GF)", "Slalom ungleich (GF)", "Kreisfahren"]
          },
          "bremsen_30": {
            "name": "Bremsen 30 km/h",
            "items": ["FuÃŸbremse", "Handbremse", "Hand u. FuÃŸbremse"]
          },
          "bremsen": {
            "name": "Bremsen",
            "items": ["Zunehmende Kraft", "Hinten blockiert (30 km/h)"]
          },
          "beschleunigen_schalten": {
            "name": "Beschleunigen - Schalten",
            "items": ["Hoch/runter", "Durchschalten/Stopp", "Durchschalten/Weiterfahren"]
          },
          "vollbremsung": {
            "name": "Vollbremsung",
            "items": ["50 km/h (M) 40 km/h (GF)"]
          },
          "ausweichen": {
            "name": "Ausweichen",
            "items": ["ohne Bremsen (GF)", "nach Bremsen (GF)"]
          },
          "steigung_gefaelle": {
            "name": "Steigung und GefÃ¤lle",
            "items": ["Anfahren", "bremsen", "Wenden", "Schalten"]
          }
        }
      },
      
      "leistungsstufe": {
        "name": "Leistungsstufe",
        "subtitle": "Verkehrsverhalten und besondere Situationen",
        "color": "#EF4444",
        "sections": {
          "an_einfahren": {
            "name": "An- und Einfahren",
            "items": ["Fahrstreifenbenutzung", "Umweltschonendes Fahren"]
          },
          "geschwindigkeit_abstaende": {
            "name": "Anpassen der Geschwindigkeit",
            "items": ["Anpassen der Geschwindigkeit"]
          },
          "sicherheitsabstaende": {
            "name": "SicherheitsabstÃ¤nde",
            "items": ["SicherheitsabstÃ¤nde"]
          },
          "verkehrsbeobachtung": {
            "name": "Verkehrsbeobachtung",
            "items": ["Verkehrsbeobachtung"]
          },
          "fahrstreifenwechsel": {
            "name": "Fahrstreifenwechsel",
            "items": ["Fahrstreifenwechsel"]
          },
          "kreuzungen_einmuendungen": {
            "name": "Kreuzungen/EinmÃ¼ndungen",
            "items": ["heranfahren und Ã¼berqueren"]
          },
          "einordnen_abbiegen": {
            "name": "Einordnen/Abbiegen",
            "items": ["nach rechts", "nach links", "Abknickende Vorfahrt", "EinbahnstraÃŸe"]
          },
          "besondere_situationen": {
            "name": "Besondere Verkehrssituationen",
            "items": ["BahnÃ¼bergang", "Ã–ffentliche Verkehrsmittel", "30 - Zonen", "FuÃŸgÃ¤ngerÃ¼berwege", "Kinder, Behinderte, Ã„ltere"]
          }
        }
      },
      
      "reifestufe": {
        "name": "Reifestufe",
        "subtitle": "Testfahrt und PrÃ¼fungsvorbereitung",
        "color": "#22C55E",
        "sections": {
          "testfahrt_pruefung": {
            "name": "Testfahrt unter PrÃ¼fungsbedingungen",
            "items": ["mit Einbeziehung der Grundfahraufgaben"]
          },
          "gezielte_uebungen": {
            "name": "Gezielte Ãœbungen und Korrekturen",
            "items": ["nach dem Ergebnis der Testfahrt"]
          },
          "beruecksichtigung_fahrweise": {
            "name": "BerÃ¼cksichtigung",
            "items": ["der umweltschonenden, verantwortungsbewussten und partnerschaftlichen Fahrweise"]
          },
          "fahrtechnische_vorbereitung": {
            "name": "Fahrtechnische Vorbereitung",
            "items": ["Fahrtechnische Vorbereitung"]
          },
          "sicherheitskontrolle": {
            "name": "Sicherheitskontrolle",
            "items": ["Sicherheitskontrolle"]
          }
        }
      },
      
      "checkliste": {
        "name": "Checkliste zur fahrtechnischen Vorbereitung",
        "subtitle": "Sicherheitskontrollen vor Fahrtbeginn",
        "color": "#06B6D4",
        "sections": {
          "beim_fahrzeug": {
            "name": "BEIM FAHRZEUG",
            "items": ["ÃœberprÃ¼fung des ordnungsgemÃ¤ÃŸen Zustandes der Reifen", "VerschleiÃŸ (z.B. BeschÃ¤digungen, Profiltiefe)", "Reifendruck"]
          },
          "scheinwerfer_leuchten": {
            "name": "Scheinwerfer, Leuchten, Blinker, Hupe",
            "items": ["Ein- und Ausschalten"]
          },
          "funktion_pruefen": {
            "name": "Funktion prÃ¼fen von",
            "items": ["Standlicht", "Abblendlicht", "Fernlicht", "Nebelschlussleuchte", "Warnblinkanlage", "Blinker", "Hupe"]
          },
          "kontrollleuchten": {
            "name": "Kontrollleuchten benennen",
            "items": ["Kontrollleuchten benennen"]
          },
          "rueckstrahler": {
            "name": "RÃ¼ckstrahler",
            "items": ["Vorhandensein", "BeschÃ¤digung"]
          },
          "lenkung": {
            "name": "Lenkung",
            "items": ["Lenkschloss entriegeln", "Erkennen des Lenkspiels"]
          },
          "bremsen_pruefen": {
            "name": "FunktionsprÃ¼fung der Bremsen",
            "items": ["Handbremse", "FuÃŸbremse"]
          },
          "beim_fahrer": {
            "name": "BEIM FAHRER (vor Fahrtbeginn)",
            "items": ["Richtige Positionierung", "Einstellung der RÃ¼ckspiegel", "Tragen des Schutzhelms"]
          },
          "zusaetzliche_kontrollen": {
            "name": "ZUSÃ„TZLICHE KONTROLLEN AM FAHRZEUG (nicht prÃ¼fungsrelevant)",
            "items": ["FlÃ¼ssigkeitsstÃ¤nde kontrollieren"]
          },
          "fluessigkeiten": {
            "name": "FlÃ¼ssigkeitsstÃ¤nde",
            "items": ["KÃ¼hlwasser", "Bremse", "Kupplung", "MotorÃ¶l", "Kraftstoff", "Batterie"]
          },
          "spiegel_bowdenzuege": {
            "name": "Weitere Kontrollen",
            "items": ["Spiegel", "BowdenzÃ¼ge"]
          },
          "lager": {
            "name": "Lager",
            "items": ["Lenkkopflager", "Schwingenlager", "Radlager"]
          },
          "antrieb": {
            "name": "Kette/Zahnriemen",
            "items": ["Kette/Zahnriemen"]
          },
          "kennzeichen": {
            "name": "Kennzeichen/PrÃ¼fplakette",
            "items": ["Kennzeichen/PrÃ¼fplakette"]
          }
        }
      }
    };
  }
  
  if (className === 'A' || className === 'A1' || className === 'A2') {
    // A-Klassen (Motorrad) mit exakten Kategorien aus Ausbildungsdiagramm
    return {
      "grundstufe": {
        "name": "Grundstufe",
        "subtitle": "Balance-Ãœbungen und Grundlagen", 
        "color": "#F59E0B",
        "sections": {
          "balance_uebungen": {
            "name": "Balance-Ãœbungen",
            "items": ["Im Stand", "Schieben", "Schieben und dosiertes Bremsen", "Schieben einer Links- und Rechtskurve", "RÃ¼ckwÃ¤rtsschieben", "Auf- und Abbocken", "SeitenstÃ¤nder", "Auf- und Absteigen"]
          },
          "sitzposition": {
            "name": "Sitzposition",
            "items": ["KÃ¶rperhaltung, FuÃŸstellung, Handstellung, Spiegeleinstellung"]
          },
          "handhabung": {
            "name": "Handhabung",
            "items": ["Starten", "1. Gang, Spiegel, Schulterblick, Blinker"]
          },
          "anfahrt_anhalte": {
            "name": "Anfahrt- und AnhalteÃ¼bungen",
            "items": ["Anfahren bis 2. Gang", "Anhalten/Leerlauf"]
          }
        }
      },
      
      "aufbaustufe": {
        "name": "Aufbaustufe",
        "subtitle": "Ãœbungen im instabilen und eigenstabilen Bereich",
        "color": "#F97316",
        "sections": {
          "instabil_uebungen": {
            "name": "Ãœbungen im Instabilen Bereich",
            "items": ["Schrittgeschwindigkeit (GF)", "Stop and Go (GF)", "Slalom in Schrittgeschwindigkeit (GF)", "Anfahren links/rechts mit Lenkeinschlag", "Wenden"]
          },
          "eigenstabil_uebungen": {
            "name": "Ãœbungen im eigenstabilen Bereich",
            "items": ["Slalom Gleich (GF)", "Slalom ungleich (GF)", "Kreisfahren"]
          },
          "bremsen_30": {
            "name": "Bremsen 30 km/h",
            "items": ["FuÃŸbremse", "Handbremse", "Hand u. FuÃŸbremse"]
          },
          "bremsen": {
            "name": "Bremsen",
            "items": ["Zunehmende Kraft", "Hinten blockiert (30 km/h)"]
          },
          "beschleunigen_schalten": {
            "name": "Beschleunigen - Schalten",
            "items": ["Hoch/runter", "Durchschalten/Stopp", "Durchschalten/Weiterfahren"]
          },
          "vollbremsung": {
            "name": "Vollbremsung",
            "items": ["50 km/h (M) 40 km/h (GF)"]
          },
          "ausweichen": {
            "name": "Ausweichen",
            "items": ["ohne Bremsen (GF)", "nach Bremsen (GF)"]
          },
          "steigung_gefaelle": {
            "name": "Steigung und GefÃ¤lle",
            "items": ["Anfahren", "bremsen", "Wenden", "Schalten"]
          }
        }
      },
      
      "leistungsstufe": {
        "name": "Leistungsstufe",
        "subtitle": "Verkehrsverhalten und besondere Situationen",
        "color": "#EF4444",
        "sections": {
          "an_einfahren": {
            "name": "An- und Einfahren",
            "items": ["Fahrstreifenbenutzung", "Umweltschonendes Fahren"]
          },
          "geschwindigkeit_abstaende": {
            "name": "Anpassen der Geschwindigkeit",
            "items": ["Anpassen der Geschwindigkeit"]
          },
          "sicherheitsabstaende": {
            "name": "SicherheitsabstÃ¤nde",
            "items": ["SicherheitsabstÃ¤nde"]
          },
          "verkehrsbeobachtung": {
            "name": "Verkehrsbeobachtung",
            "items": ["Verkehrsbeobachtung"]
          },
          "fahrstreifenwechsel": {
            "name": "Fahrstreifenwechsel",
            "items": ["Fahrstreifenwechsel"]
          },
          "kreuzungen_einmuendungen": {
            "name": "Kreuzungen/EinmÃ¼ndungen",
            "items": ["heranfahren und Ã¼berqueren"]
          },
          "einordnen_abbiegen": {
            "name": "Einordnen/Abbiegen",
            "items": ["nach rechts", "nach links", "Abknickende Vorfahrt", "EinbahnstraÃŸe"]
          },
          "besondere_situationen": {
            "name": "Besondere Verkehrssituationen",
            "items": ["BahnÃ¼bergang", "Ã–ffentliche Verkehrsmittel", "30 - Zonen", "FuÃŸgÃ¤ngerÃ¼berwege", "Kinder, Behinderte, Ã„ltere"]
          }
        }
      },
      
      "reifestufe": {
        "name": "Reifestufe",
        "subtitle": "Testfahrt und PrÃ¼fungsvorbereitung",
        "color": "#22C55E",
        "sections": {
          "testfahrt_pruefung": {
            "name": "Testfahrt unter PrÃ¼fungsbedingungen",
            "items": ["mit Einbeziehung der Grundfahraufgaben, Autobahn und LandstraÃŸe"]
          },
          "gezielte_uebungen": {
            "name": "Gezielte Ãœbungen und Korrekturen",
            "items": ["nach dem Ergebnis der Testfahrt"]
          },
          "beruecksichtigung_fahrweise": {
            "name": "BerÃ¼cksichtigung",
            "items": ["der umweltschonenden, verantwortungsbewussten und partnerschaftlichen Fahrweise"]
          },
          "fahrtechnische_vorbereitung": {
            "name": "Fahrtechnische Vorbereitung",
            "items": ["Fahrtechnische Vorbereitung"]
          },
          "sicherheitskontrolle": {
            "name": "Sicherheitskontrolle",
            "items": ["Sicherheitskontrolle"]
          }
        }
      },
      
      "uberlandfahrten": {
        "name": "Ãœberlandfahrt",
        "subtitle": "Besondere Ausbildungsfahrten",
        "color": "#EAB308",
        "sections": {
          "ueberlandfahrt": {
            "name": "Ãœberlandfahrt",
            "items": ["Geschwindigkeit, Abstand, Blickschulung", "Kreuzungen/EinmÃ¼ndungen a.g.O.", "Kurven", "Ãœberholen", "Steigungen", "GefÃ¤lle", "Einfahren i.g.O.", "Fahren nach Wegweiser", "Umweltschonende Fahrweise"]
          }
        },
        "psCircles": 5
      },
      
      "autobahn": {
        "name": "Autobahnfahrt",
        "subtitle": "Besondere Ausbildungsfahrten",
        "color": "#EAB308",
        "sections": {
          "autobahnfahrt": {
            "name": "Autobahnfahrt",
            "items": ["Einfahren Beschleunigungsstreifen", "Abstand", "Fahrstreifenwechsel", "Ãœberholen", "Richtgeschwindigkeit", "Park-/RastplÃ¤tze", "Verhalten bei UnfÃ¤llen/NotrufssÃ¤ule", "Umweltschonendes Fahren", "Verhalten bei dichtem Verkehr", "Verlassen/VerzÃ¶gerungsstreifen"]
          }
        },
        "psCircles": 4
      },
      
      "dammerung_dunkelheit": {
        "name": "Nachtfahrt",
        "subtitle": "Besondere Ausbildungsfahrten",
        "color": "#EAB308",
        "sections": {
          "nachtfahrt": {
            "name": "Nachtfahrt",
            "items": ["Beleuchtungseinrichtungen", "Fahren i.g.O.", "Fahren a.g.O.", "Parken", "Auf-/Abblenden", "Schwelle - Fahrgeschwindigkeit", "LÃ¤rmschutz"]
          }
        },
        "psCircles": 3
      },
      
      "checkliste": {
        "name": "Checkliste zur fahrtechnischen Vorbereitung",
        "subtitle": "Sicherheitskontrollen vor Fahrtbeginn",
        "color": "#06B6D4",
        "sections": {
          "beim_fahrzeug": {
            "name": "BEIM FAHRZEUG",
            "items": ["ÃœberprÃ¼fung des ordnungsgemÃ¤ÃŸen Zustandes der Reifen", "VerschleiÃŸ (z.B. BeschÃ¤digungen, Profiltiefe)", "Reifendruck"]
          },
          "scheinwerfer_leuchten": {
            "name": "Scheinwerfer, Leuchten, Blinker, Hupe",
            "items": ["Ein- und Ausschalten"]
          },
          "funktion_pruefen": {
            "name": "Funktion prÃ¼fen von",
            "items": ["Standlicht", "Abblendlicht", "Fernlicht", "Nebelschlussleuchte", "Warnblinkanlage", "Blinker", "Hupe"]
          },
          "kontrollleuchten": {
            "name": "Kontrollleuchten benennen",
            "items": ["Kontrollleuchten benennen"]
          },
          "rueckstrahler": {
            "name": "RÃ¼ckstrahler",
            "items": ["Vorhandensein", "BeschÃ¤digung"]
          },
          "lenkung": {
            "name": "Lenkung",
            "items": ["Lenkschloss entriegeln", "Erkennen des Lenkspiels"]
          },
          "bremsen_pruefen": {
            "name": "FunktionsprÃ¼fung der Bremsen",
            "items": ["Handbremse", "FuÃŸbremse"]
          },
          "beim_fahrer": {
            "name": "BEIM FAHRER (vor Fahrtbeginn)",
            "items": ["Richtige Positionierung", "Einstellung der RÃ¼ckspiegel", "Tragen des Schutzhelms"]
          },
          "zusaetzliche_kontrollen": {
            "name": "ZUSÃ„TZLICHE KONTROLLEN AM FAHRZEUG (nicht prÃ¼fungsrelevant)",
            "items": ["FlÃ¼ssigkeitsstÃ¤nde kontrollieren"]
          },
          "fluessigkeiten": {
            "name": "FlÃ¼ssigkeitsstÃ¤nde",
            "items": ["KÃ¼hlwasser", "Bremse", "Kupplung", "MotorÃ¶l", "Kraftstoff", "Batterie"]
          },
          "spiegel_bowdenzuege": {
            "name": "Weitere Kontrollen",
            "items": ["Spiegel", "BowdenzÃ¼ge"]
          },
          "lager": {
            "name": "Lager",
            "items": ["Lenkkopflager", "Schwingenlager", "Radlager"]
          },
          "antrieb": {
            "name": "Kette/Zahnriemen",
            "items": ["Kette/Zahnriemen"]
          },
          "kennzeichen": {
            "name": "Kennzeichen/PrÃ¼fplakette",
            "items": ["Kennzeichen/PrÃ¼fplakette"]
          }
        }
      }
    };
  }
  
  // FÃ¼r alle anderen Klassen die Standard-Kategorien
  return TRAINING_CATEGORIES;
}

// SICHERE MIGRATION: Entferne NUR spezifische Demo-Daten (EINMALIG)
function removeOldDemoData() {
  // PrÃ¼fe ob bereits bereinigt wurde
  const cleanupDone = localStorage.getItem('fahrschul_demo_cleanup_done');
  if (cleanupDone) {
    console.log('âœ… Demo-Daten bereits bereinigt - Ã¼berspringe');
    return;
  }
  
  console.log('ðŸ§¹ Einmalige Demo-Daten-Bereinigung...');
  
  const classes = ['B', 'BE', 'AM', 'A1', 'A2', 'A', 'C1', 'C1E', 'C', 'CE'];
  let removedCount = 0;
  
  classes.forEach(className => {
    const students = StorageManager.getStudents(className);
    // NUR spezifische Demo-Daten entfernen
    const filtered = students.filter(student => 
      !(student.id === 'daniel-daft-001' || 
        (student.name === 'Daniel' && student.surname === 'Daft' && 
         student.address === 'Friedrich-Engels-Str. 2' && student.postal_code === '10785'))
    );
    
    if (filtered.length !== students.length) {
      StorageManager.saveStudents(filtered, className);  // Korrekte Parameter-Reihenfolge
      removedCount += (students.length - filtered.length);
      console.log(`ðŸ—‘ï¸ ${students.length - filtered.length} spezifische Demo-SchÃ¼ler aus ${className} entfernt`);
    }
  });
  
  // Markiere Bereinigung als abgeschlossen
  localStorage.setItem('fahrschul_demo_cleanup_done', 'true');
  
  if (removedCount > 0) {
    console.log(`âœ… ${removedCount} Demo-EintrÃ¤ge entfernt (einmalig)`);
  } else {
    console.log('âœ… Keine spezifischen Demo-Daten gefunden');
  }
}

// Training Categories (VOLLSTÃ„NDIG aus Backend)
const TRAINING_CATEGORIES = {
  "grundstufe": {
    "name": "Grundstufe",
    "subtitle": "Einweisung und Bedienung",
    "color": "#F59E0B",
    "sections": {
      "besonderheiten_einsteigen": {
        "name": "Besonderheiten beim Einsteigen",
        "items": ["Besonderheiten beim Einsteigen"]
      },
      "einstellen": {
        "name": "Einstellen",
        "items": ["Sitz", "Spiegel", "Lenkrad", "KopfstÃ¼tze"]
      },
      "lenkradhaltung": {
        "name": "Lenkradhaltung",
        "items": ["Lenkradhaltung"]
      },
      "pedale": {
        "name": "Pedale",
        "items": ["Pedale"]
      },
      "gurt_anlegen": {
        "name": "Gurt anlegen/anpassen",
        "items": ["Gurt anlegen/anpassen"]
      },
      "schalt_wahlhebel": {
        "name": "Schalt-/WÃ¤hlhebel",
        "items": ["Schalt-/WÃ¤hlhebel"]
      },
      "zundschloss": {
        "name": "ZÃ¼ndschloss",
        "items": ["ZÃ¼ndschloss"]
      },
      "motor_anlassen": {
        "name": "Motor anlassen",
        "items": ["Motor anlassen"]
      },
      "anfahren": {
        "name": "Anfahren/AnhalteÃ¼bungen",
        "items": ["Anfahren/AnhalteÃ¼bungen"]
      },
      "schaltubungen": {
        "name": "SchaltÃ¼bungen (umweltschonend)",
        "items": ["hoch: 1-2", "2-3", "3-4", "...", "runter: 4-3", "3-2", "2-1", "...", "runter: 4-2", "4-1", "3-1"]
      },
      "lenkubungen": {
        "name": "LenkÃ¼bungen",
        "items": ["LenkÃ¼bungen"]
      }
    }
  },
  "aufbaustufe": {
    "name": "Aufbaustufe",
    "subtitle": "Umweltschonendes, vorausschauendes Fahren, Blickschulung",
    "color": "#F97316",
    "sections": {
      "rollen_schalten": {
        "name": "Rollen und Schalten",
        "items": ["Rollen und Schalten"]
      },
      "abbremsen_schalten": {
        "name": "Abbremsen und Schalten",
        "items": ["Abbremsen und Schalten"]
      },
      "bremsubungen": {
        "name": "BremsÃ¼bungen",
        "items": ["degressiv", "Zielbremsungen", "Gefahrsituationen"]
      },
      "gefalle": {
        "name": "GefÃ¤lle",
        "items": ["Anhalten", "Anfahren", "RÃ¼ckwÃ¤rts", "Sichern", "Schalten"]
      },
      "steigung": {
        "name": "Steigung",
        "items": ["Anhalten", "Anfahren", "RÃ¼ckwÃ¤rts", "Sichern", "Schalten"]
      },
      "tastgeschwindigkeit": {
        "name": "Tastgeschwindigkeit",
        "items": ["Tastgeschwindigkeit"]
      },
      "bedienungs_kontrolleinrichtungen": {
        "name": "Bedienungs- und Kontrolleinrichtungen",
        "items": ["Bedienungs- und Kontrolleinrichtungen"]
      },
      "ortliche_besonderheiten": {
        "name": "Ã–rtliche Besonderheiten",
        "items": ["Ã–rtliche Besonderheiten"]
      }
    }
  },
  "leistungsstufe": {
    "name": "Leistungsstufe",
    "subtitle": "Schwierige Verkehrssituationen, umweltschonendes, vorausschauendes Fahren, Blickschulung/Bremsbereitschaft",
    "color": "#EF4444",
    "sections": {
      "fahrbahnabutzung": {
        "name": "Fahrbahnbenutzung",
        "items": ["Einordnen", "Markierungen"]
      },
      "fahrstreifenwechsel": {
        "name": "Fahrstreifenwechsel",
        "items": ["links", "rechts"]
      },
      "vorbeifahren": {
        "name": "Vorbeifahren/Ãœberholen",
        "items": ["Vorbeifahren/Ãœberholen"]
      },
      "abbiegen": {
        "name": "Abbiegen",
        "items": ["rechts", "links", "mehrspurig", "Radweg", "Sonderstreifen", "StraÃŸenbahnen", "EinbahnstraÃŸen"]
      },
      "vorfahrt": {
        "name": "Vorfahrt",
        "items": ["rechts vor links", "GrÃ¼npfeil", "Polizeibeamte", "GrÃ¼npfeil-Schild"]
      },
      "geschwindigkeit_abstand": {
        "name": "Geschwindigkeit/Abstand",
        "items": ["Geschwindigkeit/Abstand"]
      },
      "situationen_verkehrsteilnehmer": {
        "name": "Situationen mit anderen Verkehrsteilnehmern",
        "items": ["FuÃŸgÃ¤ngerÃ¼berwege", "Kinder", "Ã–ffentl. Verkehrsmittel", "Schulbus", "Ã„ltere/Behinderte", "Radfahrer/Mofa", "Einbahnstr./Radfahrer", "Verk.-beruh. Bereich"]
      },
      "schwierige_verkehrsfuhrung": {
        "name": "Schwierige VerkehrsfÃ¼hrung",
        "items": ["Schwierige VerkehrsfÃ¼hrung"]
      },
      "engpass": {
        "name": "Engpass",
        "items": ["Engpass"]
      },
      "kreisverkehr": {
        "name": "Kreisverkehr",
        "items": ["Kreisverkehr"]
      },
      "bahnubergang": {
        "name": "BahnÃ¼bergang (warten)",
        "items": ["BahnÃ¼bergang (warten)"]
      },
      "kritische_verkehrssituationen": {
        "name": "Kritische Verkehrssituationen",
        "items": ["Hauptverkehrszeiten", "Partnerschaftliches Verhalten (Kommunikation, Verzicht auf Vorfahrt)", "Schwung nutzen"]
      },
      "fussganger_schutzbereich": {
        "name": "FuÃŸgÃ¤nger Schutzbereich",
        "items": ["FuÃŸgÃ¤nger Schutzbereich"]
      }
    }
  },
  "grundfahraufgaben": {
    "name": "Grundfahraufgaben",
    "color": "#F59E0B",
    "sections": {
      "ruckwartsfahren": {
        "name": "RÃ¼ckwÃ¤rtsfahren",
        "items": ["RÃ¼ckwÃ¤rtsfahren"]
      },
      "umkehren": {
        "name": "Umkehren",
        "items": ["Umkehren"]
      },
      "gefahrbremsung": {
        "name": "Gefahrbremsung",
        "items": ["Gefahrbremsung"]
      },
      "einparken_langs": {
        "name": "Einparken lÃ¤ngs",
        "items": ["vorwÃ¤rts rechts", "vorwÃ¤rts links", "rÃ¼ckwÃ¤rts rechts", "rÃ¼ckwÃ¤rts links"]
      },
      "einparken_quer": {
        "name": "Einparken quer",
        "items": ["vorwÃ¤rts rechts", "vorwÃ¤rts links", "rÃ¼ckwÃ¤rts rechts", "rÃ¼ckwÃ¤rts links"]
      }
    }
  },
  "uberlandfahrten": {
    "name": "Ãœberlandfahrten",
    "subtitle": "Sicheres und umweltschonendes Fahren auÃŸerhalb geschlossener Ortschaften",
    "color": "#EAB308",
    "sections": {
      "geschwindigkeit_gangwahl": {
        "name": "Angepasste Geschwindigkeit/Gangwahl (alle GÃ¤nge)",
        "items": ["Angepasste Geschwindigkeit/Gangwahl (alle GÃ¤nge)"]
      },
      "abstand": {
        "name": "Abstand",
        "items": ["vorne", "hinten", "seitlich"]
      },
      "beobachtung_spiegel": {
        "name": "Beobachtung/Spiegel",
        "items": ["Beobachtung/Spiegel"]
      },
      "verkehrszeichen": {
        "name": "Verkehrszeichen",
        "items": ["Verkehrszeichen"]
      },
      "kreuzungen_einmuendungen": {
        "name": "Kreuzungen/EinmÃ¼ndungen",
        "items": ["Kreuzungen/EinmÃ¼ndungen"]
      },
      "kurven": {
        "name": "Kurven",
        "items": ["Kurven"]
      },
      "steigungen": {
        "name": "Steigungen",
        "items": ["Steigungen"]
      },
      "gefaelle": {
        "name": "GefÃ¤lle",
        "items": ["GefÃ¤lle"]
      },
      "alleen": {
        "name": "Alleen",
        "items": ["Alleen"]
      },
      "ueberholen": {
        "name": "Ãœberholen",
        "items": ["Ãœberholen"]
      },
      "besondere_situationen": {
        "name": "Besondere Situationen",
        "items": ["Liegenbleiben u. Absichern", "FuÃŸgÃ¤nger", "Einfahren in Ortschaften", "Wild/Tiere"]
      },
      "besondere_anforderungen": {
        "name": "Besondere Anforderungen",
        "items": ["Leistungsgrenze", "Ablenkung z.B. Radio", "Orientierung"]
      }
    }
  },
  "autobahn": {
    "name": "Autobahnfahrten",
    "subtitle": "Sicheres Fahren auf Autobahnen und KraftfahrstraÃŸen",
    "color": "#EAB308",
    "sections": {
      "fahrtplanung": {
        "name": "Fahrtplanung",
        "items": ["Fahrtplanung"]
      },
      "einfahren_bab": {
        "name": "Einfahren in BAB",
        "items": ["Einfahren in BAB"]
      },
      "fahrstreifenwahl": {
        "name": "Fahrstreifenwahl",
        "items": ["Fahrstreifenwahl"]
      },
      "geschwindigkeit": {
        "name": "Geschwindigkeit",
        "items": ["Geschwindigkeit"]
      },
      "abstand": {
        "name": "Abstand",
        "items": ["vorne", "hinten", "seitlich"]
      },
      "ueberholen": {
        "name": "Ãœberholen",
        "items": ["Ãœberholen"]
      },
      "schilder_markierungen": {
        "name": "Schilder/Markierungen",
        "items": ["Schilder/Markierungen"]
      },
      "vorbeifahren_anschlussstellen": {
        "name": "Vorbeifahren/Anschlussstellen",
        "items": ["Vorbeifahren/Anschlussstellen"]
      },
      "rast_parkplaetze": {
        "name": "Rast-/ParkplÃ¤tze, Tankstellen",
        "items": ["Rast-/ParkplÃ¤tze, Tankstellen"]
      },
      "verhalten_unfaelle": {
        "name": "Verhalten bei UnfÃ¤llen",
        "items": ["Verhalten bei UnfÃ¤llen"]
      },
      "dichter_verkehr": {
        "name": "Dichter Verkehr/Stau",
        "items": ["Dichter Verkehr/Stau"]
      },
      "besondere_situationen": {
        "name": "Besondere Situationen",
        "items": ["Besondere Situationen"]
      },
      "besondere_anforderungen": {
        "name": "Besondere Anforderungen",
        "items": ["Leistungsgrenze", "Ablenkung", "Konfliktsituationen"]
      },
      "verlassen_bab": {
        "name": "Verlassen der BAB",
        "items": ["Verlassen der BAB"]
      }
    }
  },
  "dammerung_dunkelheit": {
    "name": "DÃ¤mmerung/Dunkelheit",
    "subtitle": "Fahren bei schlechten SichtverhÃ¤ltnissen",
    "color": "#EAB308",
    "sections": {
      "beleuchtung": {
        "name": "Beleuchtung",
        "items": ["Kontrolle", "Benutzung", "Einstellen", "Fernlicht"]
      },
      "beleuchtete_strassen": {
        "name": "Beleuchtete StraÃŸen",
        "items": ["Beleuchtete StraÃŸen"]
      },
      "unbeleuchtete_strassen": {
        "name": "Unbeleuchtete StraÃŸen",
        "items": ["Unbeleuchtete StraÃŸen"]
      },
      "parken": {
        "name": "Parken",
        "items": ["Parken"]
      },
      "besondere_situationen": {
        "name": "Besondere Situationen",
        "items": ["Schlechte Witterung", "BahnÃ¼bergÃ¤nge", "Tiere", "Unbeleuchtete Verkehrsteilnehmer"]
      },
      "besondere_anforderungen": {
        "name": "Besondere Anforderungen",
        "items": ["Blendung", "Orientierung"]
      },
      "abschlussbesprechung": {
        "name": "Abschlussbesprechung",
        "items": ["Abschlussbesprechung"]
      }
    }
  },
  "reife_teststufe": {
    "name": "Reife- und Teststufe",
    "subtitle": "Vorbereitung auf die praktische PrÃ¼fung",
    "color": "#22C55E",
    "sections": {
      "selbststaendiges_fahren": {
        "name": "SelbststÃ¤ndiges Fahren",
        "items": ["Innerorts", "AuÃŸerorts"]
      },
      "verantwortungsbewusstes_fahren": {
        "name": "Verantwortungsbewusstes Fahren",
        "items": ["Verantwortungsbewusstes Fahren"]
      },
      "testfahrt_pruefungsbedingungen": {
        "name": "Testfahrt unter PrÃ¼fungsbedingungen",
        "items": ["FAKT", "Andere"]
      },
      "wiederholung_vertiefung": {
        "name": "Wiederholung/Vertiefung",
        "items": ["Wiederholung/Vertiefung"]
      },
      "leistungsbewertung": {
        "name": "Leistungsbewertung",
        "items": ["Leistungsbewertung"]
      }
    }
  },
  "situative_bausteine": {
    "name": "Situative Bausteine",
    "subtitle": "Checkliste zur fahrtechnischen Sicherheit",
    "color": "#60A5FA",
    "sections": {
      "beim_fahrzeug": {
        "name": "Beim Fahrzeug",
        "items": ["Beim Fahrzeug"]
      },
      "reifen": {
        "name": "Reifen (z.B. BeschÃ¤digungen, Profiltiefe, Reifendruck)",
        "items": ["Reifen (z.B. BeschÃ¤digungen, Profiltiefe, Reifendruck)"]
      },
      "scheinwerfer_leuchten": {
        "name": "Scheinwerfer, Leuchten, Blinker, Hupe Ein- und Ausschalten",
        "items": ["Scheinwerfer, Leuchten, Blinker, Hupe Ein- und Ausschalten"]
      },
      "funktion_pruefen": {
        "name": "Funktion prÃ¼fen",
        "items": ["Standlicht", "Abblendlicht", "Fernlicht", "Schlussleuchten m. Kennzeichenbeleuchtung", "Nebelschlussleuchte", "Warnblinkanlage", "Blinker", "Hupe", "Bremsleuchte"]
      },
      "kontrollleuchten_benennen": {
        "name": "Kontrollleuchten benennen",
        "items": ["Kontrollleuchten benennen"]
      },
      "rueckstrahler": {
        "name": "RÃ¼ckstrahler",
        "items": ["Vorhandensein", "BeschÃ¤digung"]
      },
      "lenkung": {
        "name": "Lenkung",
        "items": ["Lenkschloss entriegeln", "ÃœberprÃ¼fen des Lenkspiels"]
      },
      "funktionspruefung_bremsen": {
        "name": "FunktionsprÃ¼fung der Bremsen",
        "items": ["Betriebsbremse", "Feststellbremse"]
      }
    }
  },
  "fahrerassistenzsysteme": {
    "name": "Fahrerassistenzsysteme",
    "subtitle": "Moderne Assistenzsysteme verstehen und nutzen",
    "color": "#60A5FA",
    "sections": {
      "ein_ausschalten": {
        "name": "Ein- und Ausschalten",
        "items": ["Ein- und Ausschalten"]
      },
      "anwendung": {
        "name": "Anwendung",
        "items": ["Anwendung"]
      }
    }
  },
  "beim_fahrer": {
    "name": "Beim Fahrer",
    "subtitle": "Richtige Sitzposition und Fahrzeugbedienung",
    "color": "#60A5FA",
    "sections": {
      "sitzeinstellung": {
        "name": "Sitzeinstellung",
        "items": ["SitzhÃ¶he", "Sitzabstand", "RÃ¼ckenlehne", "KopfstÃ¼tze"]
      },
      "fahrzeugbedienung": {
        "name": "Fahrzeugbedienung",
        "items": ["Lenkradhaltung"]
      }
    }
  },
  "heizung_luftung": {
    "name": "Heizung und LÃ¼ftung",
    "subtitle": "Klimatechnik im Fahrzeug",
    "color": "#60A5FA",
    "sections": {
      "bedienen_aggregate": {
        "name": "Bedienen der Aggregate",
        "items": ["Heizung", "LÃ¼ftung", "Klimaanlage", "Heckscheibenheizung", "Beheizte Sonderausstattungen"]
      },
      "energiesparende_nutzung": {
        "name": "Energiesparende Nutzung",
        "items": ["Keine unnÃ¶tigen Verbraucher", "Rechtzeitiges Abschalten"]
      }
    }
  },
  "betriebs_verkehrssicherheit": {
    "name": "Betriebs- und Verkehrssicherheit",
    "subtitle": "Technische ÃœberprÃ¼fungen des Fahrzeugs",
    "color": "#60A5FA",
    "sections": {
      "motorraum_fluessigkeitsstaende": {
        "name": "Motorraum/FlÃ¼ssigkeitsstÃ¤nde",
        "items": ["MotorÃ¶l", "KÃ¼hlmittel", "ScheibenwaschflÃ¼ssigkeit"]
      },
      "tanken": {
        "name": "Tanken",
        "items": ["Tanken"]
      },
      "sicherungsmittel": {
        "name": "Sicherungsmittel",
        "items": ["Warndreieck", "Verbandskasten", "Bordwerkzeug", "ZusÃ¤tzliche AusrÃ¼stung"]
      },
      "aussenkontrolle": {
        "name": "AuÃŸenkontrolle (SchÃ¤den, Sauberkeit)",
        "items": ["Scheiben/Wischer", "Spiegel", "Kennzeichen (HU)", "Beleuchtung"]
      },
      "bremsen": {
        "name": "Bremsen",
        "items": ["Bremsen"]
      },
      "ladung": {
        "name": "Ladung",
        "items": ["Sicherung", "Kenntlichmachung"]
      }
    }
  },
  "witterung": {
    "name": "Witterung",
    "subtitle": "Fahren bei verschiedenen Wetterbedingungen",
    "color": "#60A5FA",
    "sections": {
      "fahren_schlechter_witterung": {
        "name": "Fahren bei schlechter Witterung",
        "items": ["LÃ¼ftung", "Beleuchtung", "Scheibenwischer/-wasser", "Regen, SprÃ¼hnebel", "Wasserlachen, Aquaplaning", "Wind, Sturm, BÃ¶en", "Schnee und Matsch", "Eis"]
      }
    }
  }
};

// Storage Manager - MULTI-KLASSEN-SYSTEM
const StorageManager = {
  // Klassenspezifische SchÃ¼ler-Verwaltung
  getStudents(className = 'BE') {
    const stored = localStorage.getItem(`fahrschul_students_${className}`);
    return stored ? JSON.parse(stored) : [];
  },

  saveStudents(students, className = 'BE') {
    try {
      const key = `fahrschul_students_${className}`;
      const studentsJson = JSON.stringify(students);
      localStorage.setItem(key, studentsJson);
      
      // Debug-Log fÃ¼r Persistierung
      console.log(`ðŸ’¾ ${students.length} SchÃ¼ler in ${className} gespeichert (localStorage: ${key})`);
      
      // Verifikation dass gespeichert wurde
      const verification = localStorage.getItem(key);
      if (verification) {
        console.log(`âœ… Speicherung verifiziert fÃ¼r ${className}`);
      } else {
        console.error(`âŒ Speicherung fehlgeschlagen fÃ¼r ${className}`);
      }
    } catch (error) {
      console.error(`âŒ Fehler beim Speichern der SchÃ¼ler in ${className}:`, error);
    }
  },

  getStudentById(id, className = 'BE') {
    const students = this.getStudents(className);
    return students.find(s => s.id === id);
  },

  updateStudent(updatedStudent, className = 'BE') {
    const students = this.getStudents(className);
    const index = students.findIndex(s => s.id === updatedStudent.id);
    if (index !== -1) {
      students[index] = { ...updatedStudent, updated_at: new Date().toISOString() };
      this.saveStudents(students, className);
    }
  },

  deleteStudent(id, className = 'BE') {
    const students = this.getStudents(className);
    const filtered = students.filter(s => s.id !== id);
    this.saveStudents(filtered, className);
  },

  getProgressForStudent(studentId, className = 'BE') {
    const stored = localStorage.getItem(`fahrschul_progress_${className}`);
    const allProgress = stored ? JSON.parse(stored) : {};
    return allProgress[studentId] || {};
  },

  saveProgressForStudent(studentId, progress, className = 'BE') {
    const stored = localStorage.getItem(`fahrschul_progress_${className}`);
    const allProgress = stored ? JSON.parse(stored) : {};
    allProgress[studentId] = progress;
    localStorage.setItem(`fahrschul_progress_${className}`, JSON.stringify(allProgress));
  },

  initDemoData() {
    const existing = this.getStudents('BE');
    if (existing.length === 0) {
      this.saveStudents(DEMO_STUDENTS, 'BE');
    }
  },

  // Migration: Alte Daten nach B verschieben
  migrateOldData() {
    const oldStudents = localStorage.getItem('fahrschul_students_professional');
    const oldProgress = localStorage.getItem('fahrschul_progress_professional');
    
    if (oldStudents && !localStorage.getItem('fahrschul_students_B')) {
      localStorage.setItem('fahrschul_students_B', oldStudents);
      console.log('ðŸ”„ SchÃ¼ler nach B-Klasse migriert');
    }
    
    if (oldProgress && !localStorage.getItem('fahrschul_progress_B')) {
      localStorage.setItem('fahrschul_progress_B', oldProgress);
      console.log('ðŸ”„ Fortschritte nach B-Klasse migriert');
    }
  },

  // Alle Klassen und deren SchÃ¼leranzahl
  getAllClassesData() {
    const classes = ['AM', 'B', 'BE', 'A1', 'A2', 'A', 'C', 'CE', 'C1', 'C1E'];
    return classes.map(className => ({
      name: className,
      displayName: className,
      studentCount: this.getStudents(className).length,
      students: this.getStudents(className)
    }));
  },

  // ðŸ”„ BACKUP-FUNKTIONEN (PWA-KOMPATIBEL)
  exportBackup() {
    try {
      const classesData = this.getAllClassesData();
      const backupData = {
        version: '3.0',
        timestamp: new Date().toISOString(),
        exportDate: new Date().toLocaleString('de-DE'),
        totalStudents: classesData.reduce((sum, cls) => sum + cls.studentCount, 0),
        app: 'Deutsche Fahrschul-App Multi-Klassen PWA',
        classes: {}
      };

      // Alle Klassen-Daten sammeln
      classesData.forEach(classInfo => {
        if (classInfo.studentCount > 0) {
          const allProgress = JSON.parse(localStorage.getItem(`fahrschul_progress_${classInfo.name}`) || '{}');
          backupData.classes[classInfo.name] = {
            students: classInfo.students,
            progress: allProgress,
            studentCount: classInfo.studentCount
          };
        }
      });

      const jsonString = JSON.stringify(backupData, null, 2);
      const filename = `fahrschule-backup-${new Date().toISOString().split('T')[0]}.json`;
      
      // Erkenne PWA vs Browser (Verbesserte iOS-Erkennung)
      const isPWA = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 0);

      // PWA-SPEZIFISCHE DOWNLOAD-METHODEN
      if (isPWA) {
        // IN PWA: Verwende aggressive Share/Copy-Methoden
        this.downloadInPWA(jsonString, filename, backupData.totalStudents);
        // Backup-Zeitstempel speichern
        this.saveBackupTimestamp();
        return { success: true, filename, totalStudents: backupData.totalStudents, method: 'PWA' };
      } 
      else if (isIOS) {
        // IM BROWSER: Normale iOS-Methode
        this.downloadForIOS(jsonString, filename);
        // Backup-Zeitstempel speichern
        this.saveBackupTimestamp();
        return { success: true, filename, totalStudents: backupData.totalStudents, method: 'iOS-Browser' };
      } 
      else {
        // DESKTOP: Normale Download-Methode
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        // Backup-Zeitstempel speichern
        this.saveBackupTimestamp();
        return { success: true, filename, totalStudents: backupData.totalStudents, method: 'Desktop' };
      }
    } catch (error) {
      return { success: false, error: error.message };
    }
  },

  // ðŸ“… BACKUP-TRACKING FUNKTIONEN
  saveBackupTimestamp() {
    const now = new Date();
    localStorage.setItem('fahrschul_last_backup', now.toISOString());
    console.log('âœ… Backup-Zeitstempel gespeichert:', now.toLocaleString('de-DE'));
  },

  getLastBackupDate() {
    const timestamp = localStorage.getItem('fahrschul_last_backup');
    if (!timestamp) return null;
    return new Date(timestamp);
  },

  getLastBackupText() {
    const lastBackup = this.getLastBackupDate();
    if (!lastBackup) return 'Noch kein Backup erstellt';
    
    const daysDiff = Math.floor((new Date() - lastBackup) / (1000 * 60 * 60 * 24));
    const dateStr = lastBackup.toLocaleDateString('de-DE');
    
    if (daysDiff === 0) return `Letztes Backup: Heute (${dateStr})`;
    if (daysDiff === 1) return `Letztes Backup: Gestern (${dateStr})`;
    if (daysDiff <= 7) return `Letztes Backup: vor ${daysDiff} Tagen (${dateStr})`;
    return `Letztes Backup: ${dateStr} (vor ${daysDiff} Tagen)`;
  },

  shouldShowBackupReminder() {
    // PrÃ¼fe ob Erinnerung verschoben wurde
    const dismissedUntil = localStorage.getItem('fahrschul_backup_reminder_dismissed');
    if (dismissedUntil) {
      const dismissDate = new Date(dismissedUntil);
      if (new Date() < dismissDate) {
        return false; // Noch in der "verschoben"-Phase
      }
    }
    
    const lastBackup = this.getLastBackupDate();
    if (!lastBackup) return true; // Noch nie ein Backup gemacht
    
    const daysSinceBackup = Math.floor((new Date() - lastBackup) / (1000 * 60 * 60 * 24));
    return daysSinceBackup >= 7; // Erinnerung nach 7 Tagen
  },

  // ðŸŽ¯ KLASSEN-MANAGEMENT-SYSTEM
  getClassSettings() {
    const defaultSettings = {
      B: { visible: true, enabled: true, order: 1 },
      BE: { visible: true, enabled: true, order: 2 },
      AM: { visible: false, enabled: false, order: 3 }, // StandardmÃ¤ÃŸig versteckt
      A1: { visible: true, enabled: true, order: 4 },
      A2: { visible: false, enabled: false, order: 5 }, // StandardmÃ¤ÃŸig versteckt
      A: { visible: true, enabled: true, order: 6 },
      C1: { visible: false, enabled: false, order: 7 }, // StandardmÃ¤ÃŸig versteckt
      C1E: { visible: false, enabled: false, order: 8 }, // StandardmÃ¤ÃŸig versteckt
      C: { visible: true, enabled: true, order: 9 },
      CE: { visible: true, enabled: true, order: 10 }
    };
    
    const saved = localStorage.getItem('fahrschul_class_settings');
    if (saved) {
      try {
        return { ...defaultSettings, ...JSON.parse(saved) };
      } catch (e) {
        console.log('âš ï¸ Fehler beim Laden der Klassen-Einstellungen, verwende Standard');
        return defaultSettings;
      }
    }
    return defaultSettings;
  },

  saveClassSettings(settings) {
    localStorage.setItem('fahrschul_class_settings', JSON.stringify(settings));
    console.log('âœ… Klassen-Einstellungen gespeichert');
  },

  getVisibleClasses() {
    const settings = this.getClassSettings();
    const allClasses = ['B', 'BE', 'AM', 'A1', 'A2', 'A', 'C1', 'C1E', 'C', 'CE'];
    return allClasses.filter(className => settings[className]?.visible);
  },

  getHiddenClasses() {
    const settings = this.getClassSettings();
    const allClasses = ['B', 'BE', 'AM', 'A1', 'A2', 'A', 'C1', 'C1E', 'C', 'CE'];
    return allClasses.filter(className => !settings[className]?.visible);
  },

  // PWA-SPEZIFISCHE DOWNLOAD-METHODE (iOS-OPTIMIERT - GARANTIERT NUR EINE DATEI)
  downloadInPWA(content, filename, totalStudents) {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 0);
    const isPWA = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
    
    console.log(`ðŸ” Detailed PWA Debug: isIOS=${isIOS}, isPWA=${isPWA}, platform=${navigator.platform}, maxTouchPoints=${navigator.maxTouchPoints}`);
    
    // iOS: Verwende das native Share API (STRIKT NUR EINE DATEI!)
    if (isIOS && navigator.share) {
      console.log('ðŸŽ iOS + Share API detected - attempting file share only');
      
      try {
        // Erstelle die Backup-Datei
        const blob = new Blob([content], { type: 'application/json' });
        const file = new File([blob], filename, { 
          type: 'application/json',
          lastModified: Date.now()
        });
        
        // PrÃ¼fe File-Share-UnterstÃ¼tzung VOR dem Share-Aufruf
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          console.log('âœ… File Share confirmed - sharing single file');
          
          // GARANTIERT NUR FILE SHARE - KEIN TEXT, KEINE ZUSÃ„TZLICHEN PROPERTIES
          navigator.share({
            files: [file]  // NUR files - NICHTS ANDERES!
          }).then(() => {
            console.log('âœ… iOS File Share completed successfully - one file only');
            // RETURN HIER - KEINE WEITEREN AKTIONEN
            return;
          }).catch((error) => {
            console.log('âŒ iOS File Share failed:', error);
            console.log('ðŸ”„ Fallback to clipboard');
            this.downloadInPWAFallback(content, filename, totalStudents);
          });
          
          // RETURN HIER UM SICHERZUSTELLEN DASS KEINE WEITEREN METHODEN AUSGEFÃœHRT WERDEN
          return;
        } else {
          console.log('âš ï¸ File Share not supported - using clipboard fallback');
          this.downloadInPWAFallback(content, filename, totalStudents);
          return;
        }
      } catch (error) {
        console.log('âŒ iOS Share setup error:', error);
        this.downloadInPWAFallback(content, filename, totalStudents);
        return;
      }
    }
    
    // Andere Plattformen: Clipboard-Methode
    if (navigator.clipboard && navigator.clipboard.writeText) {
      console.log('ðŸ’» Non-iOS platform - using clipboard');
      navigator.clipboard.writeText(content)
        .then(() => {
          console.log('âœ… Clipboard successful');
        })
        .catch(() => {
          this.downloadInPWAFallback(content, filename, totalStudents);
        });
      return;
    } 
    
    // Final fallback
    console.log('âš ï¸ No share/clipboard available - using manual fallback');
    this.downloadInPWAFallback(content, filename, totalStudents);
  },

  // IOS SHARE ALS TEXT (Entfernt - nicht mehr nÃ¶tig)
  // shareAsTextIOS entfernt um doppelte Dateien zu vermeiden

  // PWA FALLBACK-METHODE (KEIN ZUSÃ„TZLICHER DOWNLOAD)
  downloadInPWAFallback(content, filename, totalStudents) {
    console.log('âš ï¸ PWA Fallback called - using clipboard only');
    
    // NUR ZWISCHENABLAGE - KEINE ZUSÃ„TZLICHEN DATEIEN/WINDOWS
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(content)
          .then(() => {
            alert(`âœ… PWA-Backup in Zwischenablage!\n\nðŸ“„ ${filename}\nðŸ‘¥ ${totalStudents} SchÃ¼ler\n\nâœ¨ Backup ist in der Zwischenablage!\n\nðŸ“ NÃ¤chste Schritte:\n1. Notiz-App Ã¶ffnen\n2. Neue Notiz erstellen\n3. EinfÃ¼gen (Ctrl+V oder lange drÃ¼cken)\n4. Als "${filename}" speichern`);
            console.log('âœ… PWA Fallback: Clipboard successful');
          })
          .catch(() => {
            // Nur ein Alert ohne zusÃ¤tzliche Dateien
            alert(`âš ï¸ Backup erstellt aber Zwischenablage nicht verfÃ¼gbar\n\nðŸ“„ ${filename}\nðŸ‘¥ ${totalStudents} SchÃ¼ler\n\nDie Backup-Daten wurden in der Browser-Konsole ausgegeben.\nÃ–ffne Entwicklertools > Konsole um sie zu finden.`);
            console.log('PWA BACKUP DATA:', content);
          });
      } else {
        // Nur Console-Log, keine zusÃ¤tzlichen Windows/Dateien
        alert(`âš ï¸ Backup erstellt aber Zwischenablage nicht verfÃ¼gbar\n\nðŸ“„ ${filename}\nðŸ‘¥ ${totalStudents} SchÃ¼ler\n\nDie Backup-Daten wurden in der Browser-Konsole ausgegeben.\nÃ–ffne Entwicklertools > Konsole um sie zu finden.`);
        console.log('PWA BACKUP DATA:', content);
      }
    } catch (error) {
      // Nur Console-Log, keine zusÃ¤tzlichen Windows/Dateien
      console.log('PWA BACKUP DATA:', content);
      alert(`âš ï¸ Backup erstellt aber Zwischenablage nicht verfÃ¼gbar\n\nðŸ“„ ${filename}\nðŸ‘¥ ${totalStudents} SchÃ¼ler\n\nDie Backup-Daten wurden in der Browser-Konsole ausgegeben.\nÃ–ffne Entwicklertools > Konsole um sie zu finden.`);
    }
  },



  // IOS BROWSER METHODE (unverÃ¤nderter Original-Code)
  downloadForIOS(jsonString, filename) {
    const newWindow = window.open('', '_blank');
    if (newWindow) {
      newWindow.document.write(`
        <html><head><title>Backup: ${filename}</title>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <style>body{font-family:-apple-system,sans-serif;padding:20px;background:#f5f5f5}
        .container{background:white;padding:20px;border-radius:10px;max-width:600px;margin:0 auto}
        .btn{background:#007AFF;color:white;padding:12px 20px;border-radius:8px;border:none;font-size:16px;margin:10px 5px;cursor:pointer}
        .backup-data{background:#f8f9fa;padding:15px;border-radius:5px;font-family:monospace;font-size:12px;word-break:break-all;max-height:300px;overflow-y:auto}
        </style></head><body><div class="container">
        <h2>ðŸ“± Backup: ${filename}</h2>
        <p><strong>iOS-Anleitung:</strong></p>
        <ol><li>Tippe "In Zwischenablage"</li><li>Ã–ffne Notiz-App</li><li>FÃ¼ge Text ein</li><li>Speichere als "${filename}"</li></ol>
        <button class="btn" onclick="navigator.clipboard.writeText(\`${jsonString.replace(/`/g, '\\`')}\`).then(()=>alert('âœ… Kopiert! Ã–ffne jetzt die Notiz-App.'))">ðŸ“„ In Zwischenablage</button>
        <div class="backup-data">${jsonString.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
        </div></body></html>
      `);
    }
  },

  // ðŸ“‚ BACKUP-IMPORT (100% OFFLINE-KOMPATIBEL)
  async importBackup(fileInput) {
    return new Promise((resolve) => {
      try {
        const file = fileInput.files[0];
        if (!file) {
          resolve({ success: false, error: 'Keine Datei ausgewÃ¤hlt' });
          return;
        }

        console.log('ðŸ“‚ Starte OFFLINE Backup-Import...', file.name);

        // Verwende nur FileReader - keine Netzwerk-AbhÃ¤ngigkeiten
        const reader = new FileReader();
        
        reader.onload = (e) => {
          try {
            console.log('ðŸ“– Datei gelesen, parse JSON...');
            const backupData = JSON.parse(e.target.result);
            
            // Validierung ohne externe Calls
            if (!backupData || typeof backupData !== 'object') {
              throw new Error('UngÃ¼ltiges Backup-Format');
            }

            console.log('âœ… JSON geparst, starte Wiederherstellung...');
            
            // Multi-Klassen-Backup erkennen
            if (backupData.version && backupData.classes) {
              console.log('ðŸ”„ Multi-Klassen-Backup erkannt');
              this.restoreMultiClassBackup(backupData);
              resolve({ 
                success: true, 
                isMultiClass: true, 
                totalStudents: Object.values(backupData.classes).reduce((sum, cls) => sum + (cls.students?.length || 0), 0),
                version: backupData.version
              });
            }
            // Legacy Single-Class Backup
            else if (Array.isArray(backupData)) {
              console.log('ðŸ”„ Legacy Single-Class-Backup erkannt');
              this.saveStudents('BE', backupData); // Legacy zu BE migrieren
              resolve({ 
                success: true, 
                isLegacy: true, 
                studentsCount: backupData.length 
              });
            }
            // Unbekanntes Format
            else {
              throw new Error('Unbekanntes Backup-Format');
            }
          } catch (parseError) {
            console.error('âŒ JSON Parse Error:', parseError);
            resolve({ success: false, error: `Backup-Datei beschÃ¤digt: ${parseError.message}` });
          }
        };

        reader.onerror = (error) => {
          console.error('âŒ FileReader Error:', error);
          resolve({ success: false, error: 'Fehler beim Lesen der Datei' });
        };

        // Starte das Lesen - rein lokal, keine Netzwerk-Calls
        reader.readAsText(file);
        
      } catch (error) {
        console.error('âŒ Import Setup Error:', error);
        resolve({ success: false, error: `Import-Fehler: ${error.message}` });
      }
    });
  },

  // ðŸ”„ MULTI-KLASSEN-BACKUP WIEDERHERSTELLEN
  restoreMultiClassBackup(backupData) {
    try {
      console.log('ðŸ”„ Starte Multi-Klassen-Backup-Wiederherstellung...');
      
      if (!backupData.classes || typeof backupData.classes !== 'object') {
        throw new Error('UngÃ¼ltiges Multi-Klassen-Backup-Format');
      }
      
      // Wiederherstellen fÃ¼r jede Klasse
      Object.keys(backupData.classes).forEach(className => {
        const classData = backupData.classes[className];
        
        if (classData.students && Array.isArray(classData.students)) {
          console.log(`ðŸ“ Stelle ${classData.students.length} SchÃ¼ler fÃ¼r Klasse ${className} wieder her`);
          this.saveStudents(classData.students, className);
        }
        
        if (classData.progress && typeof classData.progress === 'object') {
          console.log(`ðŸ“Š Stelle Fortschritte fÃ¼r Klasse ${className} wieder her`);
          localStorage.setItem(`fahrschul_progress_${className}`, JSON.stringify(classData.progress));
        }
      });
      
      // Backup-Verlauf aktualisieren falls vorhanden
      if (backupData.backupHistory && Array.isArray(backupData.backupHistory)) {
        localStorage.setItem('fahrschul_backup_history', JSON.stringify(backupData.backupHistory));
        console.log('ðŸ“‹ Backup-Verlauf wiederhergestellt');
      }
      
      console.log('âœ… Multi-Klassen-Backup erfolgreich wiederhergestellt');
      
    } catch (error) {
      console.error('âŒ Fehler bei Multi-Klassen-Wiederherstellung:', error);
      throw error;
    }
  }
};

// Hilfsfunktionen fÃ¼r Klassen
function getClassIcon(className) {
  switch(className) {
    case 'AM': return 'ðŸ›µ';       // Roller/Mofa
    case 'B': return 'ðŸš—';        // Auto (PKW)
    case 'BE': return 'ðŸš—ðŸš›';      // Auto mit AnhÃ¤nger
    case 'A1': return 'ðŸï¸';       // Leichtkraftrad
    case 'A2': return 'ðŸï¸';       // Mittleres Motorrad
    case 'A': return 'ðŸï¸';        // Schweres Motorrad
    case 'C': return 'ðŸš›';        // LKW
    case 'CE': return 'ðŸš›ðŸš›';      // LKW mit AnhÃ¤nger
    case 'C1': return 'ðŸšš';       // Kleinerer LKW
    case 'C1E': return 'ðŸššðŸš›';     // Kleinerer LKW mit AnhÃ¤nger
    default: return 'ðŸš—';
  }
}

function getClassDescription(className) {
  switch(className) {
    case 'AM': return 'Leichtmofas und Roller bis 45 km/h';
    case 'B': return 'Personenkraftwagen bis 3,5t';
    case 'BE': return 'PKW mit AnhÃ¤nger bis 750kg';
    case 'A1': return 'LeichtkraftrÃ¤der bis 125ccm';
    case 'A2': return 'KraftrÃ¤der bis 35kW';
    case 'A': return 'KraftrÃ¤der ohne BeschrÃ¤nkung';
    case 'C': return 'LKW Ã¼ber 3,5t';
    case 'CE': return 'LKW mit schwerem AnhÃ¤nger';
    case 'C1': return 'LKW bis 7,5t';
    case 'C1E': return 'LKW bis 7,5t mit AnhÃ¤nger';
    default: return '';
  }
}

// Navigation zwischen Views
function selectClass(className) {
  currentClass = className;
  currentView = 'studentList';
  
  // ðŸŽ¨ Setze data-current-class fÃ¼r klassenspezifische CSS-Styles
  document.body.setAttribute('data-current-class', className);
  
  renderStudentList();
}

function goToClassSelection() {
  currentView = 'classSelection';
  renderClassSelection();
}

function openStudentDetail(studentId) {
  selectedStudent = StorageManager.getStudentById(studentId, currentClass);
  currentView = 'studentDetail';
  renderStudentDetail(studentId);
}

// ðŸ” HAMBURGER-MENÃœ FUNKTIONEN
function toggleHamburgerMenu() {
  const menu = document.getElementById('hamburgerMenu');
  if (menu.classList.contains('active')) {
    closeHamburgerMenu();
  } else {
    openHamburgerMenu();
  }
}

function openHamburgerMenu() {
  const menu = document.getElementById('hamburgerMenu');
  menu.classList.add('active');
  menu.style.display = 'flex';
  
  // Theme-Icon beim Ã–ffnen aktualisieren
  updateHamburgerThemeIcon();
  
  // Event listener fÃ¼r Escape-Taste
  document.addEventListener('keydown', handleMenuEscape);
}

function closeHamburgerMenu() {
  const menu = document.getElementById('hamburgerMenu');
  const menuContent = menu.querySelector('.hamburger-menu');
  
  // SchlieÃŸ-Animation fÃ¼r Overlay und MenÃ¼ starten
  menu.classList.add('closing');
  menuContent.classList.add('closing');
  
  // Nach Animation das Overlay entfernen
  setTimeout(() => {
    menu.classList.remove('active', 'closing');
    menu.style.display = 'none';
    menuContent.classList.remove('closing');
  }, 300);
  
  // Event listener entfernen
  document.removeEventListener('keydown', handleMenuEscape);
}

function handleMenuEscape(event) {
  if (event.key === 'Escape') {
    closeHamburgerMenu();
  }
}

// ðŸŒ™ TOUCH-OPTIMIERTE THEME-TOGGLE FUNKTION (REPARIERT)
function handleThemeToggle(event) {
  // Stoppe alle Event-Propagation sofort
  if (event) {
    event.preventDefault();
    event.stopPropagation();
    event.stopImmediatePropagation();
  }
  
  // Verhindere mehrfaches Triggern mit stÃ¤rkerem Debouncing
  if (window.themeToggleInProgress) {
    console.log('ðŸš« Theme toggle bereits in Bearbeitung - ignoriere');
    return;
  }
  
  window.themeToggleInProgress = true;
  
  console.log('ðŸŒ™ Theme toggle gestartet');
  
  // Sofortiger Theme-Wechsel (kein setTimeout)
  toggleDarkMode();
  
  // Kurzes Timeout um mehrfache Klicks zu blockieren
  setTimeout(() => {
    window.themeToggleInProgress = false;
    console.log('âœ… Theme toggle freigegeben');
  }, 500); // 500ms statt 150ms
}

function toggleDarkMode() {
  console.log('ðŸ”„ toggleDarkMode aufgerufen');
  
  // Verwende den vorhandenen ThemeManager
  if (typeof ThemeManager !== 'undefined' && ThemeManager.toggleTheme) {
    console.log('âœ… Verwende ThemeManager.toggleTheme');
    ThemeManager.toggleTheme();
  } else {
    console.log('âš ï¸ ThemeManager nicht verfÃ¼gbar, nutze Fallback');
    // Fallback fÃ¼r den Fall, dass ThemeManager nicht verfÃ¼gbar ist
    const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
    
    if (currentTheme === 'dark') {
      document.body.classList.remove('dark-mode');
      document.documentElement.setAttribute('data-theme', 'light');
      localStorage.setItem('fahrschul-theme', 'light');
      console.log('ðŸŒž Switched to light mode');
    } else {
      document.body.classList.add('dark-mode');
      document.documentElement.setAttribute('data-theme', 'dark');
      localStorage.setItem('fahrschul-theme', 'dark');
      console.log('ðŸŒ™ Switched to dark mode');
    }
  }
  
  // Aktualisiere das Hamburger-MenÃ¼ Icon sofort
  setTimeout(() => updateHamburgerThemeIcon(), 100);
}

function updateHamburgerThemeIcon() {
  const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
  const themeIcon = document.getElementById('themeIcon');
  const themeText = document.getElementById('themeText');
  
  if (themeIcon && themeText) {
    if (currentTheme === 'dark') {
      themeIcon.textContent = 'â˜€ï¸';
      themeText.textContent = 'Light Mode';
    } else {
      themeIcon.textContent = 'ðŸŒ™';
      themeText.textContent = 'Dark Mode';
    }
  }
}

function handleThemeToggleSimple() {
  console.log('ðŸŒ™ Simple theme toggle started');
  
  // Verhindere mehrfaches gleichzeitiges Triggern
  if (window.themeToggleActive) {
    console.log('ðŸš« Theme toggle bereits aktiv');
    return;
  }
  
  window.themeToggleActive = true;
  
  try {
    // Verwende ThemeManager falls verfÃ¼gbar
    if (typeof ThemeManager !== 'undefined' && ThemeManager.toggleTheme) {
      console.log('âœ… Verwende ThemeManager');
      ThemeManager.toggleTheme();
    } else {
      // Manueller Toggle als Fallback
      console.log('âš ï¸ ThemeManager nicht verfÃ¼gbar, manueller Toggle');
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      
      if (currentTheme === 'dark') {
        // Zu Light Mode wechseln
        document.body.classList.remove('dark-mode');
        document.documentElement.setAttribute('data-theme', 'light');
        localStorage.setItem('fahrschul-theme', 'light');
        console.log('â˜€ï¸ Manuell zu Light Mode gewechselt');
      } else {
        // Zu Dark Mode wechseln
        document.body.classList.add('dark-mode');
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('fahrschul-theme', 'dark');
        console.log('ðŸŒ™ Manuell zu Dark Mode gewechselt');
      }
    }
    
    // Hamburger-MenÃ¼ Icon aktualisieren
    setTimeout(() => updateHamburgerThemeIcon(), 50);
    
    // Hamburger-MenÃ¼ schlieÃŸen
    setTimeout(() => closeHamburgerMenu(), 100);
    
  } catch (error) {
    console.error('âŒ Theme toggle Fehler:', error);
  } finally {
    // Theme toggle freigeben nach kurzer VerzÃ¶gerung
    setTimeout(() => {
      window.themeToggleActive = false;
      console.log('âœ… Theme toggle freigegeben');
    }, 300);
  }
}

// PWA Cache Update Function - AGGRESSIVE VERSION
function updatePWACache() {
  alert('ðŸ”„ PWA wird komplett neu geladen...\n\nDies kann einen Moment dauern.');
  
  // 1. Unregister ALL service workers
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(registrations => {
      const unregisterPromises = registrations.map(registration => {
        console.log('ðŸ—‘ï¸ Unregistering SW:', registration.scope);
        return registration.unregister();
      });
      
      return Promise.all(unregisterPromises);
    }).then(() => {
      // 2. Clear all caches
      return caches.keys();
    }).then(cacheNames => {
      const deletePromises = cacheNames.map(cacheName => {
        console.log('ðŸ—‘ï¸ Deleting cache:', cacheName);
        return caches.delete(cacheName);
      });
      
      return Promise.all(deletePromises);
    }).then(() => {
      // 3. Clear localStorage (optional, but thorough)
      console.log('ðŸ—‘ï¸ Clearing localStorage');
      
      // 4. Force reload with cache bypass
      console.log('ðŸ”„ Force reloading with cache bypass');
      window.location.reload(true);
    }).catch(error => {
      console.error('âŒ Cache clear error:', error);
      // Fallback: just force reload
      window.location.reload(true);
    });
  } else {
    // No service worker support, just reload
    window.location.reload(true);
  }
}

// Helper Functions
function formatGermanDate(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleDateString('de-DE');
}

// ANZAHL BEHANDELTER ITEMS BERECHNEN (ohne Gewichtung - nur zÃ¤hlen)
function calculateTreatedItems(student) {
  let treatedItems = 0;

  const progress = StorageManager.getProgressForStudent(student.id, currentClass);
  
  Object.keys(getTrainingCategoriesForClass(currentClass)).forEach(categoryKey => {
    const category = getTrainingCategoriesForClass(currentClass)[categoryKey];
    const categoryProgress = progress[categoryKey] || {};

    function countTreatedItems(sections) {
      Object.entries(sections).forEach(([sectionKey, section]) => {
        if (section.sections) {
          countTreatedItems(section.sections);
        } else if (section.items) {
          section.items.forEach(item => {
            const status = categoryProgress[sectionKey] && categoryProgress[sectionKey][item];
            // EINFACHE ZÃ„HLUNG: Wurde das Item Ã¼berhaupt behandelt?
            if (status === 'once' || status === 'twice' || status === 'thrice') {
              treatedItems++; // +1 fÃ¼r jedes behandelte Item, egal welche Stufe
            }
          });
        }
      });
    }

    countTreatedItems(category.sections);
  });

  return treatedItems; // Einfache Anzahl
}

// TATSÃ„CHLICH ABGESCHLOSSENE ITEMS BERECHNEN (mit 3-Stufen-System)
function calculateActualCompletedItems(student) {
  let completedItems = 0;

  const progress = StorageManager.getProgressForStudent(student.id);
  
  Object.keys(getTrainingCategoriesForClass(currentClass)).forEach(categoryKey => {
    const category = getTrainingCategoriesForClass(currentClass)[categoryKey];
    const categoryProgress = progress[categoryKey] || {};

    function countCompletedItems(sections) {
      Object.entries(sections).forEach(([sectionKey, section]) => {
        if (section.sections) {
          countCompletedItems(section.sections);
        } else if (section.items) {
          section.items.forEach(item => {
            const status = categoryProgress[sectionKey] && categoryProgress[sectionKey][item];
            // KORRIGIERTE 3-STUFEN-BERECHNUNG
            if (status === 'once') {
              completedItems += 0.33; // ðŸ”´ ROT (/) = 33%
            } else if (status === 'twice') {
              completedItems += 0.66; // ðŸŸ¡ GELB (Ã—) = 66%
            } else if (status === 'thrice') {
              completedItems += 1.0;  // ðŸŸ¢ GRÃœN (âŠ—) = 100%
            }
          });
        }
      });
    }

    countCompletedItems(category.sections);
  });

  return Math.round(completedItems * 10) / 10; // Auf 1 Dezimalstelle runden
}

function calculateOverallProgress(student) {
  let totalItems = 0;
  let weightedCompletedPoints = 0; // Gewichtete Punkte statt einfache ZÃ¤hlung

  Object.keys(getTrainingCategoriesForClass(currentClass)).forEach(categoryKey => {
    const category = getTrainingCategoriesForClass(currentClass)[categoryKey];
    totalItems += countTotalItems(category.sections);
  });

  const progress = StorageManager.getProgressForStudent(student.id, currentClass);
  
  Object.keys(getTrainingCategoriesForClass(currentClass)).forEach(categoryKey => {
    const category = getTrainingCategoriesForClass(currentClass)[categoryKey];
    const categoryProgress = progress[categoryKey] || {};

    function countWeightedProgress(sections) {
      Object.entries(sections).forEach(([sectionKey, section]) => {
        if (section.sections) {
          countWeightedProgress(section.sections);
        } else if (section.items) {
          section.items.forEach(item => {
            const status = categoryProgress[sectionKey] && categoryProgress[sectionKey][item];
            
            // 3-STUFEN GEWICHTUNG:
            if (status === 'once') {
              weightedCompletedPoints += 0.3333; // / = 33,33%
            } else if (status === 'twice') {
              weightedCompletedPoints += 0.6667; // X = 66,67%
            } else if (status === 'thrice') {
              weightedCompletedPoints += 1.0;    // âŠ— = 100%
            }
            // 'not_started' = 0% (nichts addieren)
          });
        }
      });
    }

    countWeightedProgress(category.sections);
  });

  return totalItems > 0 ? Math.round((weightedCompletedPoints / totalItems) * 100) : 0;
}

// Gesamtanzahl Items rekursiv zÃ¤hlen
function countTotalItems(sections) {
  let total = 0;
  Object.values(sections).forEach(section => {
    if (section.sections) {
      total += countTotalItems(section.sections);
    } else if (section.items) {
      total += section.items.length;
    }
  });
  return total;
}

// App State - MULTI-KLASSEN-SYSTEM
let currentView = 'classSelection'; // 'classSelection', 'studentList', 'studentDetail'
let selectedStudent = null;
let currentClass = 'B'; // Aktuelle FÃ¼hrerscheinklasse

// Render Functions

// ðŸŽ¯ KLASSENAUSWAHL-HAUPTSEITE - MIT KLASSEN-MANAGEMENT
function renderClassSelection() {
  console.log('ðŸ”„ Rendering Klassen mit Management-System...');
  
  const visibleClasses = StorageManager.getVisibleClasses();
  const hiddenClasses = StorageManager.getHiddenClasses();
  
  let html = `
    <div class="main-header">
      <div class="header-left">
        <!-- Theme Toggle wird hier automatisch eingefÃ¼gt -->
      </div>
      <div class="header-center">
        <h1>FsV</h1>
      </div>
      <div class="header-right">
        <button class="hamburger-menu-btn" onclick="toggleHamburgerMenu()" title="MenÃ¼">
          <span class="hamburger-icon">â˜°</span>
        </button>
      </div>
    </div>
    
    <!-- Hamburger-MenÃ¼ Overlay (nur auf Hauptseite) -->
    <div class="hamburger-menu-overlay" id="hamburgerMenu" onclick="closeHamburgerMenu()">
      <div class="hamburger-menu" onclick="event.stopPropagation()">
        <div class="hamburger-header">
          <h3>MenÃ¼</h3>
          <button class="close-btn" onclick="closeHamburgerMenu()">Ã—</button>
        </div>
        <div class="hamburger-items">
          <button class="hamburger-item" onclick="handleExportBackup(); closeHamburgerMenu();">
            <span class="hamburger-item-icon">ðŸ’¾</span>
            <span class="hamburger-item-text">Backup erstellen</span>
          </button>
          <button class="hamburger-item" onclick="handleImportBackup(); closeHamburgerMenu();">
            <span class="hamburger-item-icon">ðŸ“‚</span>
            <span class="hamburger-item-text">Backup laden</span>
          </button>
          <button class="hamburger-item" onclick="openClassManager(); closeHamburgerMenu();">
            <span class="hamburger-item-icon">âš™ï¸</span>
            <span class="hamburger-item-text">Klassen verwalten</span>
          </button>
          <button class="hamburger-item" onclick="updatePWACache(); closeHamburgerMenu();">
            <span class="hamburger-item-icon">ðŸ”„</span>
            <span class="hamburger-item-text">App aktualisieren</span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Klassen-Manager Modal -->
    <div class="class-manager-overlay" id="classManagerModal" onclick="closeClassManager()">
      <div class="class-manager-modal" onclick="event.stopPropagation()">
        <div class="class-manager-header">
          <h3>âš™ï¸ FÃ¼hrerscheinklassen verwalten</h3>
          <button class="close-btn" onclick="closeClassManager()">Ã—</button>
        </div>
        <div class="class-manager-content">
          <p>WÃ¤hlen Sie die FÃ¼hrerscheinklassen aus, die in Ihrer Fahrschule angeboten werden:</p>
          <div class="class-checkboxes">
            ${renderClassCheckboxes()}
          </div>
          <div class="class-manager-actions">
            <button class="btn-elegant secondary" onclick="resetToDefaults()">ðŸ”„ Standard wiederherstellen</button>
            <button class="btn-elegant primary" onclick="saveClassSettings()">âœ… Speichern</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="container">
      <div class="class-selection-grid">`;

  // Render nur sichtbare Klassen
  visibleClasses.forEach(className => {
    html += generateClassCard(className);
  });

  // "Weitere Klassen" Button falls welche versteckt sind
  if (hiddenClasses.length > 0) {
    html += `
        <div class="class-card add-classes-card" onclick="openClassManager()">
          <div class="class-card-header">
            <div class="class-title">+ Weitere Klassen</div>
          </div>
          <div class="class-description">${hiddenClasses.length} weitere Klassen verfÃ¼gbar</div>
          <div class="class-stats">
            <div class="student-count">Klick zum HinzufÃ¼gen</div>
            <div class="add-classes-icon">âš™ï¸</div>
          </div>
        </div>`;
  }

  html += `
      </div>
      
      <!-- Stats -->
      <div class="class-selection-stats">
        <div class="stats-card">
          <div class="stats-icon">ðŸ“Š</div>
          <div class="stats-content">
            <div class="stats-title">Aktive Klassen</div>
            <div class="stats-value">${StorageManager.getAllClassesData().reduce((sum, cls) => sum + cls.studentCount, 0)} SchÃ¼ler gesamt</div>
          </div>
        </div>
        <div class="stats-tip">
          ðŸ’¡ ${StorageManager.getLastBackupText()}
        </div>
      </div>
    </div>
  `;

  document.getElementById('app').innerHTML = html;
  
  // Theme Toggle nach dem Rendering wieder einfÃ¼gen
  setTimeout(() => {
    ThemeManager.createToggleButton();
  }, 100);
}

// Klassen-Statistiken
function renderClassSelectionStats(classesData) {
  const totalStudents = classesData.reduce((sum, cls) => sum + cls.studentCount, 0);
  
  if (totalStudents === 0) {
    return `
      <div class="welcome-banner">
        <div class="welcome-icon">ðŸš—</div>
        <div class="welcome-text">
          <h3>Willkommen in der FsV-App!</h3>
          <p>WÃ¤hle eine FÃ¼hrerscheinklasse aus, um SchÃ¼ler zu verwalten.</p>
        </div>
      </div>
    `;
  }
  
  return `
    <div class="stats-banner">
      <div class="stats-content">
        <div class="stats-main">
          <span class="stats-icon">ðŸ“Š</span>
          <div class="stats-text">
            <strong>Gesamt: ${totalStudents} SchÃ¼ler</strong>
            <span class="stats-subtitle">Letzte Ã„nderung: ${new Date().toLocaleDateString('de-DE')}</span>
          </div>
        </div>
        <div class="stats-tip">
          ðŸ’¡ ${StorageManager.getLastBackupText()}
        </div>
      </div>
    </div>
  `;
}

// ðŸš— KLASSENSPEZIFISCHE SCHÃœLERLISTE
function renderStudentList() {
  const students = StorageManager.getStudents(currentClass);
  const classDisplayName = currentClass;
  
  let html = `
    <div class="main-header">
      <div class="header-left">
        <button class="btn-elegant secondary" onclick="goToClassSelection()" title="ZurÃ¼ck zur Klassenauswahl">
          <span class="icon">â†</span>
          <span class="btn-text">ZurÃ¼ck</span>
        </button>
      </div>
      <div class="header-center">
        <h1>FsV - ${classDisplayName}</h1>
      </div>
      <div class="header-right">
        <button class="btn-elegant primary" onclick="showNewStudentDialog()">
          <span class="icon">âž•</span>
          <span>Neuer SchÃ¼ler</span>
        </button>
      </div>
    </div>
    
    <div class="container">
      <!-- Info-Banner wenn SchÃ¼ler vorhanden -->
      ${students.length > 0 ? `
        <div class="class-info-banner">
          <div class="class-info-content">
            <div class="class-info-main">
              <div class="class-info-text">
                <strong>Klasse ${classDisplayName}: ${students.length} SchÃ¼ler</strong>
                <span class="class-info-subtitle">${getClassDescription(currentClass)}</span>
              </div>
            </div>
          </div>
        </div>
      ` : ''}
      <div class="student-grid">
  `;

  students.forEach(student => {
    const progress = calculateOverallProgress(student);
    const totalItems = Object.values(getTrainingCategoriesForClass(currentClass)).reduce((sum, cat) => sum + countTotalItems(cat.sections), 0);
    const treatedItems = calculateTreatedItems(student); // ANZAHL BEHANDELTER ITEMS (ohne Gewichtung)

    html += `
      <div class="student-card" onclick="openStudentDetail('${student.id}')">
        <button class="delete-btn" onclick="event.stopPropagation(); deleteStudent('${student.id}')" title="SchÃ¼ler lÃ¶schen">
          ðŸ—‘ï¸
        </button>
        <div class="student-info">
          <div class="student-avatar">ðŸ‘¤</div>
          <div class="student-details">
            <div class="student-name">${student.name} ${student.surname}</div>
            ${student.phone ? `<div class="student-phone">ðŸ“ž ${student.phone}</div>` : ''}
            <div class="student-date">Seit ${formatGermanDate(student.start_date)}</div>
            <div class="student-class">Klasse: ${classDisplayName}</div>
          </div>
        </div>
        <div class="student-progress">${progress}% (${treatedItems}/${totalItems})</div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progress}%"></div>
        </div>
      </div>
    `;
  });

  if (students.length === 0) {
    html += `
      <div class="empty-class-state">
        <div class="empty-title">Noch keine SchÃ¼ler in Klasse ${classDisplayName}</div>
        <div class="empty-description">${getClassDescription(currentClass)}</div>
        <button class="btn-elegant primary" onclick="showNewStudentDialog()">
          <span class="icon">âž•</span>
          <span>Ersten SchÃ¼ler hinzufÃ¼gen</span>
        </button>
      </div>
    `;
  }

  html += `
      </div>
    </div>
  `;

  document.getElementById('app').innerHTML = html;
  
  // Theme Toggle nach dem Rendering wieder einfÃ¼gen
  setTimeout(() => {
    ThemeManager.createToggleButton();
  }, 100);
}

function renderStudentDetail(studentId) {
  const student = StorageManager.getStudentById(studentId, currentClass);
  if (!student) {
    renderStudentList();
    return;
  }

  selectedStudent = student;
  
  const classDisplayName = currentClass;

  let html = `
    <div class="detail-header">
      <div class="header-left">
        <button class="back-btn" onclick="renderStudentList()">â†</button>
      </div>
      <div class="header-center">
        <div class="detail-title">${student.name} ${student.surname}</div>
        <div class="detail-subtitle">Klasse ${classDisplayName}</div>
      </div>
      <div class="header-right">
        <button class="btn-elegant pdf" onclick="exportToPDF('${student.id}')">
          <span class="icon">ðŸ“„</span>
          <span>PDF exportieren</span>
        </button>
        <button class="edit-btn" onclick="showEditStudentDialog('${student.id}')" title="Bearbeiten">âœï¸</button>
      </div>
    </div>
    <div class="container">
      ${renderPersonalInfo(student)}
      ${renderFahrtenSection(student)}
      ${renderTrainingProgress(student)}
    </div>
  `;

  document.getElementById('app').innerHTML = html;
  currentView = 'detail';
  
  // Theme Toggle nach dem Rendering wieder einfÃ¼gen
  setTimeout(() => {
    ThemeManager.createToggleButton();
  }, 100);
}

function renderPersonalInfo(student) {
  const comments = getCommentsForStudent(student.id);
  const hasStudentComment = comments['student_general'] && comments['student_general'].trim();

  return `
    <div class="section">
      <div class="section-header">
        <div class="section-icon">ðŸ‘¤</div>
        <div class="section-title">SchÃ¼lerinformationen</div>
        <button class="comment-btn ${hasStudentComment ? 'has-comment' : ''}" onclick="showStudentCommentDialog('${student.id}')" title="${hasStudentComment ? 'Notizen bearbeiten' : 'Notizen hinzufÃ¼gen'}">
          ðŸ’¬
        </button>
      </div>
      <div class="info-grid">
        ${student.phone ? `<div class="info-item">
          <div class="info-icon">ðŸ“ž</div>
          <div class="info-text">Telefon: ${student.phone}</div>
        </div>` : ''}
        
        ${student.address ? `<div class="info-item">
          <div class="info-icon">ðŸ“</div>
          <div class="info-text">Adresse: ${student.address}${student.postal_code ? `, ${student.postal_code}` : ''}${student.city ? ` ${student.city}` : ''}</div>
        </div>` : ''}
        
        ${student.date_of_birth ? `<div class="info-item">
          <div class="info-icon">ðŸŽ‚</div>
          <div class="info-text">Geburtsdatum: ${formatGermanDate(student.date_of_birth)}</div>
        </div>` : ''}
        
        <div class="info-item">
          <div class="info-icon">ðŸ“…</div>
          <div class="info-text">Ausbildungsbeginn: ${formatGermanDate(student.start_date)}</div>
        </div>
        
        ${student.wears_glasses !== null ? `<div class="info-item">
          <div class="info-icon">ðŸ‘“</div>
          <div class="info-text">${student.wears_glasses ? 'BrillentrÃ¤ger' : 'Kein BrillentrÃ¤ger'}</div>
        </div>` : ''}
        
        ${student.theory_exam_date ? `<div class="info-item">
          <div class="info-icon">ðŸ“</div>
          <div class="info-text">TheorieprÃ¼fung: ${formatGermanDate(student.theory_exam_date)}${student.theory_exam_passed ? ' <span style="color: #22c55e; font-weight: 600;">âœ… Bestanden</span>' : ''}</div>
        </div>` : (student.theory_exam_passed ? `<div class="info-item">
          <div class="info-icon">ðŸ“</div>
          <div class="info-text">TheorieprÃ¼fung: <span style="color: #22c55e; font-weight: 600;">âœ… Bestanden</span></div>
        </div>` : '')}
        
        ${student.practical_exam_date ? `<div class="info-item">
          <div class="info-icon">ðŸš—</div>
          <div class="info-text">Praktische PrÃ¼fung: ${formatGermanDate(student.practical_exam_date)}${student.practical_exam_passed ? ' <span style="color: #22c55e; font-weight: 600;">âœ… Bestanden</span>' : ''}</div>
        </div>` : (student.practical_exam_passed ? `<div class="info-item">
          <div class="info-icon">ðŸš—</div>
          <div class="info-text">Praktische PrÃ¼fung: <span style="color: #22c55e; font-weight: 600;">âœ… Bestanden</span></div>
        </div>` : '')}
      </div>
    </div>
  `;
}

function renderFahrtenSection(student) {
  return `
    <div class="section">
      <div class="section-header">
        <div class="section-icon">ðŸš—</div>
        <div class="section-title">Geleistete Fahrten</div>
      </div>
      ${renderGesamtFortschritt(student.id)}
    </div>
  `;
}

// DYNAMISCHE GESAMTÃœBERSICHT ALLER FORTSCHRITTE
function renderGesamtFortschritt(studentId) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  
  // Sammle alle UE-Kreise aus allen Kategorien
  let totalUECircles = 0;
  let allCategories;
  
  // AM-Klasse hat KEINE besonderen Ausbildungsfahrten
  if (currentClass === 'AM') {
    allCategories = ['grundstufe', 'aufbaustufe', 'leistungsstufe', 'grundfahraufgaben', 'reifestufe', 'checkliste'];
  } else {
    allCategories = ['grundstufe', 'aufbaustufe', 'leistungsstufe', 'grundfahraufgaben', 'wichtige_fahraufgaben', 'reifestufe', 'uberlandfahrten', 'autobahn', 'dammerung_dunkelheit', 'checkliste'];
  }
  
  allCategories.forEach(categoryKey => {
    const ueCircles = progress[`${categoryKey}_header_ue`] || [];
    totalUECircles += ueCircles.length;
  });
  
  // Sammle alle Viertel-Kreise aus allen Kategorien und rechne sie korrekt um (15min = 0.333 UE)
  let totalQuarterUE = 0; // Als Dezimalzahl (z.B. 1.75 UE)
  allCategories.forEach(categoryKey => {
    const quarterCircles = progress[`${categoryKey}_header_quarters`] || [];
    quarterCircles.forEach(fillLevel => {
      // fillLevel: 0=0%, 1=25%=15min, 2=50%=30min, 3=75%=45min, 4=100%=60min
      // 15min = 15/45 = 0.333 UE
      totalQuarterUE += fillLevel * (15/45); // 15min pro Schritt Ã· 45min pro UE
    });
  });
  
  // Sammle alle blauen PS-Kreise (nur aus Fahrten-Kategorien)
  let totalBlueCircles = 0;
  const fahrtenCategories = ['uberlandfahrten', 'autobahn', 'dammerung_dunkelheit'];
  
  fahrtenCategories.forEach(categoryKey => {
    const blueCircles = progress[`${categoryKey}_blue_circles`] || [];
    totalBlueCircles += blueCircles.filter(circle => circle === true).length;
  });
  
  return `
    <div style="padding: 20px;">
      <!-- Erste Reihe: GrÃ¼ne UE-Kreise (Gesamtanzahl) -->
      <div class="fahrt-section">
        <div class="fahrt-title">Gesamt UE-Kreise: ${totalUECircles}</div>
        <div class="fahrt-buttons">
          ${Array(totalUECircles).fill(0).map((_, index) => `
            <div class="ue-circle" style="background: #22c55e; border-color: #22c55e; color: white;" title="UE ${index + 1}">
              ${index + 1}
            </div>
          `).join('')}
          <span style="margin-left: 8px; color: #22c55e; font-weight: 600; font-size: 14px;">UE</span>
        </div>
      </div>
      
      <!-- Zweite Reihe: Viertel-Kreise (mit korrekter UE-Berechnung) -->
      <div class="fahrt-section">
        <div class="fahrt-title">Gesamt Viertel-UE: ${totalQuarterUE.toFixed(2).replace('.00', '')}</div>
        <div class="fahrt-buttons">
          ${allCategories.map(categoryKey => {
            const quarterCircles = progress[`${categoryKey}_header_quarters`] || [];
            return quarterCircles.map((fillLevel, index) => `
              <div class="quarter-circle ${getFillLevelClass(fillLevel)}" title="${categoryKey} Viertel ${index + 1} - ${fillLevel * 15}min = ${(fillLevel * (15/45)).toFixed(2)} UE"></div>
            `).join('');
          }).join('')}
          ${totalQuarterUE > 0 ? '<span style="margin-left: 8px; color: #22c55e; font-weight: 600; font-size: 14px;">UE</span>' : ''}
        </div>
      </div>
      
      <!-- Dritte Reihe: Blaue PS-Kreise (nur gefÃ¼llte) -->
      <div class="fahrt-section">
        <div class="fahrt-title">Gesamt PS-Fahrten: ${totalBlueCircles}</div>
        <div class="fahrt-buttons">
          ${Array(totalBlueCircles).fill(0).map((_, index) => `
            <div class="ue-circle blue-filled" title="PS-Fahrt ${index + 1}">
              ${index + 1}
            </div>
          `).join('')}
          ${totalBlueCircles > 0 ? '<span style="margin-left: 8px; color: #3b82f6; font-weight: 600; font-size: 14px;">PS</span>' : ''}
        </div>
      </div>
    </div>
  `;
}

// NEUE FUNKTION: Pflichtfahrten als Kreise mit FÃ¼llstÃ¤nden
function renderPflichtfahrtenWithCircles(student, title, category, maxCount) {
  const fahrten = student[category] || [];
  
  // Erweitere Array auf maxCount mit FÃ¼llstÃ¤nden (0-4)
  const fahrtStands = [];
  for (let i = 0; i < maxCount; i++) {
    fahrtStands[i] = fahrten[i] || 0; // 0 = leer, 1-4 = 25%-100%
  }

  const completedFull = fahrtStands.filter(stand => stand >= 4).length;

  let html = `
    <div class="fahrt-section">
      <div class="fahrt-title">${title}</div>
      <div class="fahrt-buttons" id="buttons-${category}">
  `;

  fahrtStands.forEach((fillLevel, index) => {
    const fillClass = getFillClass(fillLevel);
    html += `
      <button class="circle-btn ${fillClass}" 
              onclick="toggleCircleFill('${student.id}', '${category}', ${index})"
              data-category="${category}" data-index="${index}" title="Fahrt ${index + 1}">
      </button>
    `;
  });

  html += `
        <span class="fahrt-status">(${completedFull}/${maxCount})</span>
      </div>
    </div>
  `;

  return html;
}

function getFillClass(fillLevel) {
  switch (fillLevel) {
    case 0: return 'fill-0';
    case 1: return 'fill-25';
    case 2: return 'fill-50';
    case 3: return 'fill-75';
    case 4: return 'fill-100';
    default: return 'fill-0';
  }
}

function renderFahrtType(student, title, category, maxCount, canAddRemove) {
  const fahrten = student[category] || [];
  const completed = fahrten.filter(Boolean).length;
  const total = fahrten.length;
  const statusText = maxCount ? `(${completed}/${maxCount})` : `(${completed}/${total})`;

  let html = `
    <div class="fahrt-section">
      <div class="fahrt-title">${title}</div>
      <div class="fahrt-buttons" id="buttons-${category}">
  `;

  fahrten.forEach((completed, index) => {
    html += `
      <button class="fahrt-btn ${completed ? 'completed' : 'incomplete'}"
              onclick="toggleFahrt('${student.id}', '${category}', ${index})"
              data-category="${category}" data-index="${index}">
        ${index + 1}  
      </button>
    `;
  });

  if (canAddRemove) {
    const addButtonClass = category === 'uebungsfahrten_halb' ? 'fahrt-btn add-green' : 'fahrt-btn add';
    html += `
      <button class="${addButtonClass}" onclick="addFahrt('${student.id}', '${category}')">
        +
      </button>
    `;
  }

  html += `
        <span class="fahrt-status">${statusText}</span>
      </div>
    </div>
  `;

  return html;
}

function renderTrainingProgress(student) {
  let html = `
    <div class="section">
      <div class="section-header">
        <div class="section-icon">ðŸ“‹</div>
        <div class="section-title">Ausbildungsfortschritt</div>
      </div>
    </div>
  `;

  Object.entries(getTrainingCategoriesForClass(currentClass)).forEach(([key, category]) => {
    const progress = StorageManager.getProgressForStudent(student.id, currentClass);
    const categoryProgress = progress[key] || {};
    
    let completedItems = 0; // Gewichtete Punkte fÃ¼r Prozentberechnung
    let treatedItems = 0;   // Einfache Anzahl behandelter Items fÃ¼r Klammer-Anzeige
    const totalItems = countTotalItems(category.sections);

    function countCompletedItems(sections) {
      Object.entries(sections).forEach(([sectionKey, section]) => {
        if (section.sections) {
          countCompletedItems(section.sections);
        } else if (section.items) {
          section.items.forEach(item => {
            const status = categoryProgress[sectionKey] && categoryProgress[sectionKey][item];
            // KORRIGIERTE 3-STUFEN-BERECHNUNG fÃ¼r Prozente
            if (status === 'once') {
              completedItems += 0.33; // ðŸ”´ ROT (/) = 33%
              treatedItems++; // +1 behandeltes Item
            } else if (status === 'twice') {
              completedItems += 0.66; // ðŸŸ¡ GELB (Ã—) = 66%
              treatedItems++; // +1 behandeltes Item
            } else if (status === 'thrice') {
              completedItems += 1.0;  // ðŸŸ¢ GRÃœN (âŠ—) = 100%
              treatedItems++; // +1 behandeltes Item
            }
          });
        }
      });
    }

    countCompletedItems(category.sections);

    const percentage = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
    const expanded = key === 'grundstufe';

    html += `
      <div class="training-section">
        <div class="training-header ${key}" onclick="toggleTrainingSection('${key}')">
          ${renderCategoryHeader(student.id, category, key, percentage, treatedItems, totalItems)}
        </div>
        <div id="section-${key}" class="training-content ${expanded ? 'expanded' : ''}">
          <div class="training-items">
            ${renderTrainingItems(category.sections, key, student.id)}
          </div>
        </div>
      </div>
    `;
  });

  return html;
}

function renderTrainingItems(sections, categoryKey, studentId) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  const categoryProgress = progress[categoryKey] || {};
  const comments = getCommentsForStudent(studentId);
  
  // Hole die Kategorie-Farbe
  const category = getTrainingCategoriesForClass(currentClass)[categoryKey];
  const categoryColor = category ? category.color : '#6b7280';

  function renderSection(sections, level = 0) {
    return Object.entries(sections).map(([sectionKey, section], index) => {
      if (section.sections) {
        return `
          <div class="mb-4 ${level > 0 ? 'ml-4' : ''}">
            ${section.name ? `<h4 class="font-medium text-gray-700 mb-2">${section.name}</h4>` : ''}
            ${renderSection(section.sections, level + 1)}
          </div>
        `;
      } else if (section.items) {
        const sectionProgress = categoryProgress[sectionKey] || {};

        // PrÃ¼fe ob es sich um redundante Ãœberschrift handelt (nur 1 Item mit gleichem Namen)
        const isRedundantHeader = section.items.length === 1 && section.items[0] === section.name;
        
        if (isRedundantHeader) {
          // Render direkt als Checkbox ohne Ãœberschrift
          const item = section.items[0];
          const status = sectionProgress[item] || 'not_started';
          const symbol = getStatusSymbol(status);
          const statusClass = status !== 'not_started' ? status : '';
          const commentKey = `${categoryKey}_${sectionKey}_${item}`;
          const hasComment = comments[commentKey] && comments[commentKey].trim();

          return `
            <div class="mb-4 ${level > 0 ? 'ml-4' : ''}">
              <div class="progress-item">
                <div class="progress-checkbox ${statusClass}" 
                     onclick="toggleProgressItem('${studentId}', '${categoryKey}', '${sectionKey}', '${item}', event)"
                     data-category="${categoryKey}" data-item="${item}">
                  ${symbol}
                </div>
                <span class="progress-item-text">${item}</span>
                <button class="comment-btn ${hasComment ? 'has-comment' : ''}" onclick="showCommentDialog('${studentId}', '${categoryKey}', '${sectionKey}', '${item}', event)" title="${hasComment ? 'Kommentar bearbeiten' : 'Kommentar hinzufÃ¼gen'}">
                  ðŸ’¬
                </button>
              </div>
              ${index < Object.entries(sections).length - 1 ? `<div class="section-divider" style="background: linear-gradient(to right, ${categoryColor} 50%, transparent 50%); background-size: 8px 1px;"></div>` : ''}
            </div>
          `;
        } else {
          // Normale Sektion mit Ãœberschrift und mehreren Items
          return `
            <div class="mb-4 ${level > 0 ? 'ml-4' : ''}">
              ${section.name ? `<h4 class="font-medium text-gray-700 mb-2">${section.name}</h4>` : ''}
              ${section.items.map(item => {
                const status = sectionProgress[item] || 'not_started';
                const symbol = getStatusSymbol(status);
                const statusClass = status !== 'not_started' ? status : '';
                const commentKey = `${categoryKey}_${sectionKey}_${item}`;
                const hasComment = comments[commentKey] && comments[commentKey].trim();

                return `
                  <div class="progress-item">
                    <div class="progress-checkbox ${statusClass}" 
                         onclick="toggleProgressItem('${studentId}', '${categoryKey}', '${sectionKey}', '${item}', event)"
                         data-category="${categoryKey}" data-item="${item}">
                      ${symbol}
                    </div>
                    <span class="progress-item-text">${item}</span>
                    <button class="comment-btn ${hasComment ? 'has-comment' : ''}" onclick="showCommentDialog('${studentId}', '${categoryKey}', '${sectionKey}', '${item}', event)" title="${hasComment ? 'Kommentar bearbeiten' : 'Kommentar hinzufÃ¼gen'}">
                      ðŸ’¬
                    </button>
                  </div>
                `;
              }).join('')}
              ${index < Object.entries(sections).length - 1 ? `<div class="section-divider" style="background: linear-gradient(to right, ${categoryColor} 50%, transparent 50%); background-size: 8px 1px;"></div>` : ''}
            </div>
          `;
        }
      }
      
      return '';
    }).join('');
  }
  
  return renderSection(sections);
}

// SPEZIAL-RENDERING FÃœR GRUNDSTUFE MIT UE-KREISEN
function renderGrundstufeItem(studentId, sectionKey, item, hasComment) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  const ueProgress = progress.grundstufe_ue || {};
  const quarterProgress = progress.grundstufe_quarters || {};
  
  const ueKey = `${sectionKey}_${item}`;
  const currentUE = ueProgress[ueKey] || 0; // Anzahl volle UE-Kreise
  const quarters = quarterProgress[ueKey] || [false, false, false, false]; // 4 Viertel-Kreise

  return `
    <div class="ue-section">
      <div class="ue-title">${item}</div>
      <div style="display: flex; gap: 8px; align-items: center;">
        <div class="ue-circles">
          ${renderUECircles(studentId, ueKey, currentUE)}
          <button class="circle-btn green fill-0" onclick="addUECircle('${studentId}', '${ueKey}')" title="UE hinzufÃ¼gen">+</button>
        </div>
        <div class="quarter-circles">
          ${quarters.map((filled, qIndex) => `
            <div class="quarter-circle ${getQuarterFillClass(quarters, qIndex)}" 
                 onclick="toggleQuarterCircle('${studentId}', '${ueKey}', ${qIndex})"
                 title="Viertel ${qIndex + 1}"></div>
          `).join('')}
        </div>
        <button class="comment-btn ${hasComment ? 'has-comment' : ''}" onclick="showCommentDialog('${studentId}', 'grundstufe', '${sectionKey}', '${item}', event)" title="Kommentar">ðŸ’¬</button>
      </div>
    </div>
  `;
}

function getQuarterFillClass(quarters, index) {
  const filledCount = quarters.slice(0, index + 1).filter(q => q).length;
  if (!quarters[index]) return '';

  switch (filledCount) {
    case 1: return 'fill-25';
    case 2: return 'fill-50';
    case 3: return 'fill-75';
    case 4: return 'fill-100';
    default: return 'filled';
  }
}

function renderUECircles(studentId, ueKey, count) {
  let html = '';
  for (let i = 0; i < count; i++) {
    html += `<button class="circle-btn green fill-100" onclick="removeUECircle('${studentId}', '${ueKey}', ${i})" title="UE ${i + 1} - Klick zum Entfernen"></button>`;
  }
  return html;
}

// NEUE FUNKTIONEN FÃœR KREIS-SYSTEM

// Pflichtfahrten-Kreise togglen (0-4 FÃ¼llstÃ¤nde)
function toggleCircleFill(studentId, category, index) {
  const student = StorageManager.getStudentById(studentId, currentClass);
  if (!student) return;

  // Stelle sicher, dass fahrten als Array von Zahlen (0-4) existiert
  let updatedFahrten = [...(student[category] || [])];
  
  // Erweitere Array falls nÃ¶tig
  while (updatedFahrten.length <= index) {
    updatedFahrten.push(0);
  }

  // Zyklisch durch FÃ¼llstÃ¤nde: 0 -> 1 -> 2 -> 3 -> 4 -> 0
  updatedFahrten[index] = (updatedFahrten[index] + 1) % 5;

  const updatedStudent = {
    ...student,
    [category]: updatedFahrten
  };

  StorageManager.updateStudent(updatedStudent, currentClass);

  // Nur den geklickten Button aktualisieren
  const button = document.querySelector(`button[data-category="${category}"][data-index="${index}"]`);
  if (button) {
    const newFillClass = getFillClass(updatedFahrten[index]);
    button.className = `circle-btn ${newFillClass}`;
  }

  // Status Text aktualisieren
  const statusSpan = document.querySelector(`#buttons-${category} .fahrt-status`);
  if (statusSpan) {
    const completedFull = updatedFahrten.filter(level => level >= 4).length;
    const maxCount = category === 'ueberlandfahrten' ? 5 : category === 'autobahnfahrten' ? 4 : 3;
    statusSpan.textContent = `(${completedFull}/${maxCount})`;
  }
}

// UE-Kreis hinzufÃ¼gen (Grundstufe)
function addUECircle(studentId, ueKey) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  if (!progress.grundstufe_ue) progress.grundstufe_ue = {};
  
  progress.grundstufe_ue[ueKey] = (progress.grundstufe_ue[ueKey] || 0) + 1;
  
  StorageManager.saveProgressForStudent(studentId, progress, currentClass);
  
  // Grundstufe-Bereich neu rendern
  renderStudentDetail(studentId);
}

// UE-Kreis entfernen (Grundstufe)
function removeUECircle(studentId, ueKey, index) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);  
  if (!progress.grundstufe_ue) progress.grundstufe_ue = {};
  
  if (progress.grundstufe_ue[ueKey] > 0) {
    progress.grundstufe_ue[ueKey]--;
    if (progress.grundstufe_ue[ueKey] === 0) {
      delete progress.grundstufe_ue[ueKey];
    }
  }
  
  StorageManager.saveProgressForStudent(studentId, progress, currentClass);
  
  // Grundstufe-Bereich neu rendern
  renderStudentDetail(studentId);
}

// Viertel-Kreis togglen (Grundstufe)
function toggleQuarterCircle(studentId, ueKey, quarterIndex) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  if (!progress.grundstufe_quarters) progress.grundstufe_quarters = {};
  if (!progress.grundstufe_quarters[ueKey]) progress.grundstufe_quarters[ueKey] = [false, false, false, false];
  
  progress.grundstufe_quarters[ueKey][quarterIndex] = !progress.grundstufe_quarters[ueKey][quarterIndex];
  
  StorageManager.saveProgressForStudent(studentId, progress, currentClass);
  
  // Nur das angeklickte Viertel aktualisieren
  const quarterElement = event.target;
  if (progress.grundstufe_quarters[ueKey][quarterIndex]) {
    quarterElement.classList.add('filled');
  } else {
    quarterElement.classList.remove('filled');
  }
}

function getStatusSymbol(status) {
  switch (status) {
    case 'once': return '/';
    case 'twice': return 'Ã—';
    case 'thrice': return 'âŠ—';
    default: return '';
  }
}

function getNextStatus(currentStatus) {
  const statusCycle = ['not_started', 'once', 'twice', 'thrice'];
  const currentIndex = statusCycle.indexOf(currentStatus || 'not_started');
  return statusCycle[(currentIndex + 1) % statusCycle.length];
}

// GENERALISIERTE HEADER MIT KREISEN - KORRIGIERT WIE ÃœBERLANDFAHRTEN
function renderCategoryHeaderWithCircles(studentId, category, categoryKey, percentage, completedItems, totalItems) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  const ueCircles = progress[`${categoryKey}_header_ue`] || [];
  const quarterCircles = progress[`${categoryKey}_header_quarters`] || [];

  return `
    <div class="training-info-with-circles">
      <div class="training-info">
        <h3>${category.name}</h3>
        ${category.subtitle ? `<div class="training-subtitle">${category.subtitle}</div>` : ''}
      </div>
      <div class="grundstufe-circles" onclick="event.stopPropagation()">
        <div class="circle-row">
          ${ueCircles.map((circle, index) => `
            <div class="ue-circle" onclick="event.stopPropagation(); removeCategoryUECircle('${studentId}', '${categoryKey}', ${index})" title="UE ${index + 1} - Klick zum Entfernen">
              ${index + 1}
            </div>
          `).join('')}
          <div class="add-circle-btn" onclick="event.stopPropagation(); addCategoryUECircle('${studentId}', '${categoryKey}')" title="UE hinzufÃ¼gen">+</div>
          ${ueCircles.length > 0 ? '<span style="margin-left: 8px; color: #22c55e; font-weight: 600; font-size: 14px;">UE</span>' : ''}
        </div>
        <div class="circle-row">
          ${quarterCircles.map((fillLevel, index) => `
            <div class="quarter-circle ${getFillLevelClass(fillLevel)}"
                 onclick="event.stopPropagation(); toggleCategoryQuarterCircle('${studentId}', '${categoryKey}', ${index})"
                 title="Klicken: 0% â†’ 25% â†’ 50% â†’ 75% â†’ LÃ¶schen"></div>
          `).join('')}
          <div class="add-circle-btn" onclick="event.stopPropagation(); addCategoryQuarterCircle('${studentId}', '${categoryKey}')" title="Viertel-Kreis hinzufÃ¼gen">+</div>
          ${quarterCircles.length > 0 ? '<span style="margin-left: 8px; color: #22c55e; font-weight: 600; font-size: 14px;">UE</span>' : ''}
        </div>
      </div>
    </div>
    <div class="training-progress">
      <div class="progress-circle"></div>
      <div class="progress-text">${percentage}%</div>
      <div class="progress-count">(${completedItems}/${totalItems})</div>
      <div class="dropdown-arrow">â–¼</div>
    </div>
  `;
}

// GENERALISIERTE HEADER FÃœR SPEZIAL-FAHRTEN (ÃœBERLAND, AUTOBAHN, NACHT)
function renderSpecialFahrtenHeader(studentId, category, categoryKey, percentage, completedItems, totalItems, blueCircleCount) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  const blueCircles = progress[`${categoryKey}_blue_circles`] || Array(blueCircleCount).fill(false);
  const quarterCircles = progress[`${categoryKey}_header_quarters`] || [];

  return `
    <div class="training-info-with-circles">
      <div class="training-info">
        <h3>${category.name}</h3>
        ${category.subtitle ? `<div class="training-subtitle">${category.subtitle}</div>` : ''}
      </div>
      <div class="grundstufe-circles" onclick="event.stopPropagation()">
        <div class="circle-row">
          ${blueCircles.map((filled, index) => `
            <div class="ue-circle ${filled ? 'blue-filled' : 'blue-empty'}" onclick="event.stopPropagation(); toggleBlueCircle('${studentId}', '${categoryKey}', ${index})" title="${category.name} ${index + 1} - Klick zum FÃ¼llen/Leeren">
              ${index + 1}
            </div>
          `).join('')}
          <span style="margin-left: 8px; color: #3b82f6; font-weight: 600; font-size: 14px;">PS</span>
        </div>
        <div class="circle-row">
          ${quarterCircles.map((fillLevel, index) => `
            <div class="quarter-circle ${getFillLevelClass(fillLevel)}"
                 onclick="event.stopPropagation(); toggleCategoryQuarterCircle('${studentId}', '${categoryKey}', ${index})"
                 title="Klicken: 0% â†’ 25% â†’ 50% â†’ 75% â†’ LÃ¶schen"></div>
          `).join('')}
          <div class="add-circle-btn" onclick="event.stopPropagation(); addCategoryQuarterCircle('${studentId}', '${categoryKey}')" title="Viertel-Kreis hinzufÃ¼gen">+</div>
          ${quarterCircles.length > 0 ? '<span style="margin-left: 8px; color: #22c55e; font-weight: 600; font-size: 14px;">UE</span>' : ''}
        </div>
      </div>
    </div>
    <div class="training-progress">
      <div class="progress-circle"></div>
      <div class="progress-text">${percentage}%</div>
      <div class="progress-count">(${completedItems}/${totalItems})</div>
      <div class="dropdown-arrow">â–¼</div>
    </div>
  `;
}

// SPEZIELLE HEADER FÃœR ÃœBERLANDFAHRTEN MIT BLAUEN UND GRÃœNEN KREISEN (fÃ¼r RÃ¼ckwÃ¤rtskompatibilitÃ¤t)
function renderUberlandfahrtenHeader(studentId, category, categoryKey, percentage, completedItems, totalItems) {
  return renderSpecialFahrtenHeader(studentId, category, categoryKey, percentage, completedItems, totalItems, 5);
}

function getFillLevelClass(fillLevel) {
  switch (fillLevel) {
    case 1: return 'pie-25';
    case 2: return 'pie-50';
    case 3: return 'pie-75';
    case 4: return 'pie-100';
    default: return 'pie-0';
  }
}

// LIVE-UPDATE DER GESAMTÃœBERSICHT
function updateGesamtFortschritt(studentId) {
  // Finde die "Geleistete Fahrten" Sektion
  const sectionTitles = document.querySelectorAll('.section-title');
  let gesamtSection = null;
  
  sectionTitles.forEach(title => {
    if (title.textContent.includes('Geleistete Fahrten')) {
      gesamtSection = title.closest('.section');
    }
  });
  
  if (!gesamtSection) return;
  
  // Finde das Content-Element (alles nach dem section-header)
  const sectionHeader = gesamtSection.querySelector('.section-header');
  const contentElement = sectionHeader.nextElementSibling;
  
  if (contentElement) {
    // Generiere neuen Inhalt und entferne die Ã¤uÃŸeren div-Tags
    const newContent = renderGesamtFortschritt(studentId);
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = newContent;
    const innerContent = tempDiv.firstElementChild;
    
    // Ersetze den Inhalt
    contentElement.innerHTML = innerContent.innerHTML;
  }
}

// GENERISCHE KATEGORIE HEADER FUNKTIONEN FÃœR ALLE KATEGORIEN (mit Live-Update)
function addCategoryUECircle(studentId, categoryKey) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  const headerKey = `${categoryKey}_header_ue`;
  if (!progress[headerKey]) progress[headerKey] = [];
  
  progress[headerKey].push(true);
  
  StorageManager.saveProgressForStudent(studentId, progress, currentClass);
  updateCategoryHeaderOnly(studentId, categoryKey);
  updateGesamtFortschritt(studentId); // Live-Update!
}

function removeCategoryUECircle(studentId, categoryKey, index) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  const headerKey = `${categoryKey}_header_ue`;
  if (!progress[headerKey]) return;
  
  progress[headerKey].splice(index, 1);
  
  StorageManager.saveProgressForStudent(studentId, progress, currentClass);
  updateCategoryHeaderOnly(studentId, categoryKey);
  updateGesamtFortschritt(studentId); // Live-Update!
}

function addCategoryQuarterCircle(studentId, categoryKey) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  const headerKey = `${categoryKey}_header_quarters`;
  if (!progress[headerKey]) progress[headerKey] = [];
  
  progress[headerKey].push(0);
  
  StorageManager.saveProgressForStudent(studentId, progress, currentClass);
  updateCategoryHeaderOnly(studentId, categoryKey);
  updateGesamtFortschritt(studentId); // Live-Update!
}

function toggleCategoryQuarterCircle(studentId, categoryKey, index) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  const headerKey = `${categoryKey}_header_quarters`;
  
  if (!progress[headerKey]) return;
  
  const currentLevel = progress[headerKey][index];
  
  if (currentLevel === 4) { 
    // Bei 100% (4. Klick): NÃ¤chster Klick lÃ¶scht den Kreis komplett
    progress[headerKey].splice(index, 1); // Viertel-Kreis komplett entfernen
  } else { 
    // Normal: 0 â†’ 1 (25%) â†’ 2 (50%) â†’ 3 (75%) â†’ 4 (100%), dann LÃ¶schen
    progress[headerKey][index] = currentLevel + 1;
  }
  
  StorageManager.saveProgressForStudent(studentId, progress, currentClass);
  updateCategoryHeaderOnly(studentId, categoryKey);
  updateGesamtFortschritt(studentId); // Live-Update!
}

function updateCategoryHeaderOnly(studentId, categoryKey) {
  const category = getTrainingCategoriesForClass(currentClass)[categoryKey];
  if (!category) return;
  
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  const [completedItems, totalItems] = [0, 0]; // Dummy values fÃ¼r Header
  const percentage = 0; // Dummy value fÃ¼r Header
  
  // ðŸ“± AUCH HIER: REINER ROUTER FÃœR UPDATES - KEINE EIGENE LOGIK!
  switch(currentClass) {
    case 'B':
      headerHtml = renderBCategoryHeader(studentId, category, categoryKey, percentage, completedItems, totalItems);
      break;
    case 'A':
    case 'A1':
    case 'A2':
      headerHtml = renderACategoryHeader(studentId, category, categoryKey, percentage, completedItems, totalItems);
      break;
    case 'BE':
      headerHtml = renderBECategoryHeader(studentId, category, categoryKey, percentage, completedItems, totalItems);
      break;
    case 'C':
    case 'C1':
    case 'C1E':
      headerHtml = renderCCategoryHeader(studentId, category, categoryKey, percentage, completedItems, totalItems);
      break;
    case 'CE':
      headerHtml = renderCECategoryHeader(studentId, category, categoryKey, percentage, completedItems, totalItems);
      break;
    default:
      // Fallback
      headerHtml = renderBCategoryHeader(studentId, category, categoryKey, percentage, completedItems, totalItems);
      break;
  }
  
  const headerElement = document.querySelector(`.training-header.${categoryKey}`);
  if (headerElement) {
    headerElement.innerHTML = headerHtml;
  }
}

// GRUNDSTUFE HEADER FUNKTIONEN (fÃ¼r RÃ¼ckwÃ¤rtskompatibilitÃ¤t) - mit Live-Update
function addGrundstufeUECircle(studentId) {
  addCategoryUECircle(studentId, 'grundstufe');
}

function removeGrundstufeUECircle(studentId, index) {
  removeCategoryUECircle(studentId, 'grundstufe', index);
}

function addGrundstufeQuarterCircle(studentId) {
  addCategoryQuarterCircle(studentId, 'grundstufe');
}

function toggleGrundstufeQuarterCircle(studentId, index) {
  toggleCategoryQuarterCircle(studentId, 'grundstufe', index);
}

function removeGrundstufeQuarterCircle(studentId, index) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  if (!progress.grundstufe_header_quarters) return;
  
  progress.grundstufe_header_quarters.splice(index, 1);
  
  StorageManager.saveProgressForStudent(studentId, progress, currentClass);
  updateCategoryHeaderOnly(studentId, 'grundstufe');
  updateGesamtFortschritt(studentId); // Live-Update!
}

// FUNKTIONEN FÃœR BLAUE KREISE (ÃœBERLAND, AUTOBAHN, NACHT) - mit Live-Update
function toggleBlueCircle(studentId, categoryKey, index) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  const blueKey = `${categoryKey}_blue_circles`;
  
  // ðŸ”§ KLASSENSPEZIFISCHE KREIS-ANZAHL BESTIMMUNG
  let circleCount = 5; // Standard fÃ¼r B-Klassen
  
  if (currentClass === 'BE') {
    // BE-spezifische Zahlen
    if (categoryKey === 'uberlandfahrten') circleCount = 3;        // BE: 3 statt 5
    else if (categoryKey === 'autobahn') circleCount = 1;          // BE: 1 statt 4  
    else if (categoryKey === 'dammerung_dunkelheit') circleCount = 1; // BE: 1 statt 3
  } else {
    // Alle anderen Klassen (B, A, C, etc.): Original-Zahlen
    if (categoryKey === 'uberlandfahrten') circleCount = 5;
    else if (categoryKey === 'autobahn') circleCount = 4;
    else if (categoryKey === 'dammerung_dunkelheit') circleCount = 3;
  }
  
  if (!progress[blueKey]) progress[blueKey] = Array(circleCount).fill(false);
  
  // Toggle den Kreis
  progress[blueKey][index] = !progress[blueKey][index];
  
  StorageManager.saveProgressForStudent(studentId, progress, currentClass);
  updateCategoryHeaderOnly(studentId, categoryKey);
  updateGesamtFortschritt(studentId); // Live-Update!
}

// GRUNDSTUFE HEADER MIT KREISEN (fÃ¼r RÃ¼ckwÃ¤rtskompatibilitÃ¤t)
function renderGrundstufeHeader(studentId, category, percentage, completedItems, totalItems) {
  return renderCategoryHeaderWithCircles(studentId, category, 'grundstufe', percentage, completedItems, totalItems);
}

// PDF-EXPORT FUNKTIONEN (EINFACH FÃœR MOBILE)
function exportToPDF(studentId) {
  // Hole die aktuellsten Daten direkt aus dem Storage
  const student = StorageManager.getStudentById(studentId, currentClass);
  if (!student) {
    alert('SchÃ¼ler nicht gefunden!');
    return;
  }

  // Debug: Zeige die aktuellen Daten
  console.log('PDF-Export fÃ¼r:', student.name, student.surname);
  console.log('TheorieprÃ¼fung:', student.theory_exam_date, student.theory_exam_passed);
  console.log('Praktische PrÃ¼fung:', student.practical_exam_date, student.practical_exam_passed);

  // Erstelle Print-Dokument mit aktuellen Daten
  const printDocument = createPrintDocument(student);
  
  // FÃ¼ge es zum Body hinzu
  document.body.appendChild(printDocument);
  
  // Einfacher Ansatz fÃ¼r Mobile - lÃ¤ngere Wartezeit
  setTimeout(() => {
    try {
      window.print();
    } catch (error) {
      alert('PDF-Export fehlgeschlagen. Versuchen Sie es erneut.');
      console.error('PDF-Export Fehler:', error);
    }
    
    // Cleanup
    setTimeout(() => {
      if (document.body.contains(printDocument)) {
        document.body.removeChild(printDocument);
      }
    }, 3000);
  }, 1000);
}

function createPrintDocument(student) {
  const progress = StorageManager.getProgressForStudent(student.id);
  
  const printDiv = document.createElement('div');
  printDiv.className = 'print-document';
  
  printDiv.innerHTML = `
    <!-- HEADER -->
    <div class="print-header">
      <div class="print-title">FAHRSCHUL-AUSBILDUNGSNACHWEIS</div>
      <div>VollstÃ¤ndige Dokumentation der Ausbildungsinhalte</div>
    </div>
    
    <!-- SCHÃœLERINFORMATIONEN -->
    <div class="print-student-info">
      <table class="print-info-table">
        <tr>
          <td class="label">Name:</td>
          <td>${student.name} ${student.surname}</td>
          <td class="label">Geburtsdatum:</td>
          <td>${formatGermanDate(student.date_of_birth) || 'Nicht angegeben'}</td>
        </tr>
        <tr>
          <td class="label">Adresse:</td>
          <td colspan="3">${formatFullAddress(student)}</td>
        </tr>
        <tr>
          <td class="label">Telefon:</td>
          <td>${student.phone || 'Nicht angegeben'}</td>
          <td class="label">BrillentrÃ¤ger:</td>
          <td>${student.wears_glasses ? 'Ja' : 'Nein'}</td>
        </tr>
        <tr>
          <td class="label">Ausbildungsbeginn:</td>
          <td>${formatGermanDate(student.start_date)}</td>
          <td class="label">TheorieprÃ¼fung:</td>
          <td>${student.theory_exam_date ? formatGermanDate(student.theory_exam_date) : 'Nicht absolviert'}${student.theory_exam_passed ? ' âœ… Bestanden' : ''}</td>
        </tr>
        <tr>
          <td class="label">Praktische PrÃ¼fung:</td>
          <td colspan="3">${student.practical_exam_date ? formatGermanDate(student.practical_exam_date) : 'Nicht absolviert'}${student.practical_exam_passed ? ' âœ… Bestanden' : ''}</td>
        </tr>
      </table>
    </div>
    
    <!-- AUSBILDUNGSINHALTE -->
    <div class="print-categories">
      ${generatePrintCategories(student.id)}
    </div>
    
    <!-- GESAMTÃœBERSICHT -->
    <div class="print-summary">
      <div class="print-summary-title">GESAMTÃœBERSICHT GELEISTETER STUNDEN</div>
      ${generatePrintSummary(student.id)}
    </div>
    
    <!-- UNTERSCHRIFTEN -->
    <div class="print-signatures">
      <div class="print-date">
        Datum: <span class="print-date-line"></span>
      </div>
      
      <div class="print-signature-text">
        Mit meiner Unterschrift bestÃ¤tige ich, dass alle aufgefÃ¼hrten Ausbildungsinhalte ordnungsgemÃ¤ÃŸ mit mir durchgefÃ¼hrt wurden.
      </div>
      
      <div class="print-signature-fields">
        <div class="print-signature-field">
          <div class="print-signature-line"></div>
          <div class="print-signature-label">FahrschÃ¼ler/in<br>${student.name} ${student.surname}</div>
        </div>
        <div class="print-signature-field">
          <div class="print-signature-line"></div>
          <div class="print-signature-label">Fahrlehrer/in</div>
        </div>
      </div>
    </div>
  `;
  
  return printDiv;
}

function formatFullAddress(student) {
  let address = student.address || '';
  if (student.postal_code) address += (address ? ', ' : '') + student.postal_code;
  if (student.city) address += (address ? ' ' : '') + student.city;
  return address || 'Nicht angegeben';
}

function generatePrintCategories(studentId) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  
  return Object.entries(getTrainingCategoriesForClass(currentClass)).map(([categoryKey, category]) => {
    const categoryProgress = progress[categoryKey] || {};
    
    return `
      <div class="print-category">
        <div class="print-category-title">${category.name.toUpperCase()}</div>
        ${generatePrintSections(category.sections, categoryKey, categoryProgress)}
      </div>
    `;
  }).join('');
}

function generatePrintSections(sections, categoryKey, categoryProgress) {
  function renderSection(sections, level = 0) {
    return Object.entries(sections).map(([sectionKey, section]) => {
      if (section.sections) {
        return `
          <div style="margin-left: ${level * 20}px;">
            ${section.name ? `<div style="font-weight: bold; margin: 10px 0 5px 0;">${section.name}</div>` : ''}
            ${renderSection(section.sections, level + 1)}
          </div>
        `;
      } else if (section.items) {
        const sectionProgress = categoryProgress[sectionKey] || {};
        
        return `
          <div style="margin-left: ${level * 20}px;">
            ${section.name ? `<div style="font-weight: bold; margin: 10px 0 5px 0;">${section.name}</div>` : ''}
            <div class="print-items">
              ${section.items.map(item => {
                const status = sectionProgress[item] || 'not_started';
                const symbol = getStatusSymbol(status);
                const statusClass = status !== 'not_started' ? `checked-${status}` : '';
                
                return `
                  <div class="print-item">
                    <div class="print-checkbox ${statusClass}">${symbol}</div>
                    <span>${item}</span>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }
      return '';
    }).join('');
  }
  
  return renderSection(sections);
}

function generatePrintSummary(studentId) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  
  // Sammle alle UE-Kreise
  let totalUECircles = 0;
  let allCategories;
  
  // AM-Klasse hat KEINE besonderen Ausbildungsfahrten
  if (currentClass === 'AM') {
    allCategories = ['grundstufe', 'aufbaustufe', 'leistungsstufe', 'grundfahraufgaben', 'reifestufe', 'checkliste'];
  } else {
    allCategories = ['grundstufe', 'aufbaustufe', 'leistungsstufe', 'grundfahraufgaben', 'wichtige_fahraufgaben', 'reifestufe', 'uberlandfahrten', 'autobahn', 'dammerung_dunkelheit', 'checkliste'];
  }
  
  allCategories.forEach(categoryKey => {
    const ueCircles = progress[`${categoryKey}_header_ue`] || [];
    totalUECircles += ueCircles.length;
  });
  
  // Sammle alle Viertel-Kreise und rechne sie korrekt um (15min-Schritte)
  let totalQuarterUE = 0;
  allCategories.forEach(categoryKey => {
    const quarterCircles = progress[`${categoryKey}_header_quarters`] || [];
    quarterCircles.forEach(fillLevel => {
      // 15min pro Schritt Ã· 45min pro UE = 0.333 UE pro Schritt
      totalQuarterUE += fillLevel * (15/45);
    });
  });
  
  // Sammle alle blauen PS-Kreise
  let totalBlueCircles = 0;
  const fahrtenCategories = ['uberlandfahrten', 'autobahn', 'dammerung_dunkelheit'];
  
  fahrtenCategories.forEach(categoryKey => {
    const blueCircles = progress[`${categoryKey}_blue_circles`] || [];
    totalBlueCircles += blueCircles.filter(circle => circle === true).length;
  });
  
  return `
    <table class="print-summary-table">
      <thead>
        <tr>
          <th>Art der Stunden</th>
          <th>Anzahl</th>
          <th>Bemerkung</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>UE-Stunden gesamt</td>
          <td><strong>${totalUECircles}</strong></td>
          <td>VollstÃ¤ndige Unterrichtseinheiten</td>
        </tr>
        <tr>
          <td>Viertel-UE gesamt</td>
          <td><strong>${totalQuarterUE.toFixed(2).replace('.00', '')}</strong></td>
          <td>15-Minuten-Einheiten (15min = 0.33 UE)</td>
        </tr>
        <tr>
          <td>PS-Fahrten gesamt</td>
          <td><strong>${totalBlueCircles}</strong></td>
          <td>Pflichtfahrten (Ãœberland, Autobahn, Nacht)</td>
        </tr>
      </tbody>
    </table>
  `;
}

// Event Handlers (optimiert ohne Blinken)
function openStudentDetail(studentId) {
  renderStudentDetail(studentId);
}

function deleteStudent(studentId) {
  const student = StorageManager.getStudentById(studentId, currentClass);
  if (student && confirm(`${student.name} ${student.surname} wirklich lÃ¶schen?`)) {
    StorageManager.deleteStudent(studentId, currentClass);
    renderStudentList();
  }
}

function toggleFahrt(studentId, category, index) {
  const student = StorageManager.getStudentById(studentId, currentClass);
  if (!student) return;

  const updatedFahrten = [...student[category]];
  
  // Wenn es eine Ãœbungsfahrt ist und bereits completed ist, dann lÃ¶schen
  if ((category === 'uebungsfahrten_ganz' || category === 'uebungsfahrten_halb') && updatedFahrten[index]) {
    // LÃ¶schen statt toggle
    updatedFahrten.splice(index, 1);
  } else {
    // Normales Toggle fÃ¼r Pflichtfahrten oder leere Ãœbungsfahrten
    updatedFahrten[index] = !updatedFahrten[index];
  }

  const updatedStudent = {
    ...student,
    [category]: updatedFahrten
  };

  StorageManager.updateStudent(updatedStudent, currentClass);

  // Bereich neu rendern fÃ¼r Ãœbungsfahrten, nur Button updaten fÃ¼r Pflichtfahrten
  if (category === 'uebungsfahrten_ganz' || category === 'uebungsfahrten_halb') {
    renderStudentDetail(studentId);
  } else {
    // Nur den Button aktualisieren - KEIN BLINKEN!
    const button = document.querySelector(`button[data-category="${category}"][data-index="${index}"]`);
    if (button) {
      if (updatedFahrten[index]) {
        button.className = 'fahrt-btn completed';
      } else {
        button.className = 'fahrt-btn incomplete';
      }
    }
  }
}

function addFahrt(studentId, category) {
  const student = StorageManager.getStudentById(studentId, currentClass);
  if (!student) return;

  const updatedFahrten = [...(student[category] || []), false];

  const updatedStudent = {
    ...student,
    [category]: updatedFahrten
  };

  StorageManager.updateStudent(updatedStudent, currentClass);

  // Nur den Fahrt-Bereich neu rendern
  const buttonsContainer = document.getElementById(`buttons-${category}`);
  if (buttonsContainer) {
    const newIndex = updatedFahrten.length - 1;
    const addButton = buttonsContainer.querySelector('.add, .add-green');
    const statusSpan = buttonsContainer.querySelector('.fahrt-status');

    const newButton = document.createElement('button');
    newButton.className = 'fahrt-btn incomplete';
    newButton.onclick = () => toggleFahrt(studentId, category, newIndex);
    newButton.setAttribute('data-category', category);
    newButton.setAttribute('data-index', newIndex);
    newButton.textContent = newIndex + 1;

    buttonsContainer.insertBefore(newButton, addButton);

    // Status aktualisieren
    if (statusSpan) {
      const completed = updatedFahrten.filter(Boolean).length;
      statusSpan.textContent = `(${completed}/${updatedFahrten.length})`;
    }
  }
}

function toggleTrainingSection(sectionId) {
  const section = document.getElementById(`section-${sectionId}`);
  const arrow = section.parentElement.querySelector('.dropdown-arrow');
  
  if (section.classList.contains('expanded')) {
    section.classList.remove('expanded');
    arrow.style.transform = 'rotate(0deg)';
  } else {
    section.classList.add('expanded');
    arrow.style.transform = 'rotate(180deg)';
  }
}

function toggleProgressItem(studentId, categoryKey, sectionKey, itemKey, event) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  
  if (!progress[categoryKey]) progress[categoryKey] = {};
  if (!progress[categoryKey][sectionKey]) progress[categoryKey][sectionKey] = {};
  
  const currentStatus = progress[categoryKey][sectionKey][itemKey] || 'not_started';
  const nextStatus = getNextStatus(currentStatus);
  
  progress[categoryKey][sectionKey][itemKey] = nextStatus;
  
  StorageManager.saveProgressForStudent(studentId, progress, currentClass);

  // Nur das angeklickte Element aktualisieren
  const element = event.target;
  const symbol = getStatusSymbol(nextStatus);
  const statusClass = nextStatus !== 'not_started' ? nextStatus : '';
  
  element.textContent = symbol;
  element.className = `progress-checkbox ${statusClass}`;

  // Kategorie-Fortschritt aktualisieren
  updateCategoryProgress(categoryKey, studentId);
}

function updateCategoryProgress(categoryKey, studentId) {
  const category = getTrainingCategoriesForClass(currentClass)[categoryKey];
  if (!category) return;

  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  const categoryProgress = progress[categoryKey] || {};
  
  let completedItems = 0; // Gewichtete Punkte fÃ¼r Prozentberechnung
  let treatedItems = 0;   // Einfache Anzahl behandelter Items fÃ¼r Klammer-Anzeige
  const totalItems = countTotalItems(category.sections);

  function countCompletedItems(sections) {
    Object.entries(sections).forEach(([sectionKey, section]) => {
      if (section.sections) {
        countCompletedItems(section.sections);
      } else if (section.items) {
        section.items.forEach(item => {
          const status = categoryProgress[sectionKey] && categoryProgress[sectionKey][item];
          // KORRIGIERTE 3-STUFEN-BERECHNUNG
          if (status === 'once') {
            completedItems += 0.33; // ðŸ”´ ROT (/) = 33%
            treatedItems++; // +1 behandeltes Item
          } else if (status === 'twice') {
            completedItems += 0.66; // ðŸŸ¡ GELB (Ã—) = 66%
            treatedItems++; // +1 behandeltes Item
          } else if (status === 'thrice') {
            completedItems += 1.0;  // ðŸŸ¢ GRÃœN (âŠ—) = 100%
            treatedItems++; // +1 behandeltes Item
          }
        });
      }
    });
  }

  countCompletedItems(category.sections);

  const percentage = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;

  // UI aktualisieren
  const progressText = document.querySelector(`#section-${categoryKey}`).parentElement.querySelector('.progress-text');
  const progressCount = document.querySelector(`#section-${categoryKey}`).parentElement.querySelector('.progress-count');
  
  if (progressText) progressText.textContent = `${percentage}%`;
  if (progressCount) progressCount.textContent = `(${treatedItems}/${totalItems})`;
}

// Neuer FahrschÃ¼ler Dialog
function showNewStudentDialog() {
  const dialog = document.createElement('div');
  dialog.className = 'dialog-overlay';
  dialog.innerHTML = `
    <div class="dialog">
      <h2>Neuer SchÃ¼ler</h2>
      <div class="form-group">
        <label>Vorname *</label>
        <input type="text" id="new-name" placeholder="z.B. Max" required>
      </div>
      <div class="form-group">
        <label>Nachname *</label>
        <input type="text" id="new-surname" placeholder="z.B. Mustermann" required>
      </div>
      <div class="form-group">
        <label>Telefon</label>
        <input type="tel" id="new-phone" placeholder="01234567890">
      </div>
      <div class="form-group">
        <label>StraÃŸe, Hausnummer</label>
        <input type="text" id="new-address" placeholder="z.B. MusterstraÃŸe 123">
      </div>
      <div class="form-group">
        <label>Postleitzahl</label>
        <input type="text" id="new-postal-code" placeholder="z.B. 12345" maxlength="5">
      </div>
      <div class="form-group">
        <label>Stadt</label>
        <input type="text" id="new-city" placeholder="z.B. Berlin">
      </div>
      <div class="form-group">
        <label>Geburtsdatum</label>
        <input type="date" id="new-birth">
      </div>
      <div class="form-group">
        <label>Ausbildungsbeginn</label>
        <input type="date" id="new-start" value="${new Date().toISOString().split('T')[0]}">
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" id="new-glasses">
          BrillentrÃ¤ger
        </label>
      </div>
      <div class="form-group">
        <label>TheorieprÃ¼fung Datum</label>
        <input type="date" id="new-theory-date">
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" id="new-theory-passed">
          TheorieprÃ¼fung bestanden
        </label>
      </div>
      <div class="form-group">
        <label>Praktische PrÃ¼fung Datum</label>
        <input type="date" id="new-practical-date">
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" id="new-practical-passed">
          Praktische PrÃ¼fung bestanden
        </label>
      </div>
      <div class="dialog-buttons">
        <button class="btn-secondary" onclick="closeNewStudentDialog()">Abbrechen</button>
        <button class="btn-primary" onclick="createNewStudent()">Erstellen</button>
      </div>
    </div>
  `;

  document.body.appendChild(dialog);
  
  // Focus auf erstes Eingabefeld
  setTimeout(() => {
    document.getElementById('new-name').focus();
  }, 100);
}

function closeNewStudentDialog() {
  const dialog = document.querySelector('.dialog-overlay');
  if (dialog) {
    dialog.remove();
  }
}

function createNewStudent() {
  const name = document.getElementById('new-name').value.trim();
  const surname = document.getElementById('new-surname').value.trim();

  if (!name || !surname) {
    alert('Bitte Vor- und Nachname eingeben!');
    return;
  }

  const newStudent = {
    id: 'student-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
    name: name,
    surname: surname,
    date_of_birth: document.getElementById('new-birth').value || null,
    phone: document.getElementById('new-phone').value.trim() || null,
    address: document.getElementById('new-address').value.trim() || null,
    postal_code: document.getElementById('new-postal-code').value.trim() || null,
    city: document.getElementById('new-city').value.trim() || null,
    start_date: document.getElementById('new-start').value || new Date().toISOString().split('T')[0],
    theory_exam_date: document.getElementById('new-theory-date').value || null,
    practical_exam_date: document.getElementById('new-practical-date').value || null,
    theory_exam_passed: document.getElementById('new-theory-passed').checked,
    practical_exam_passed: document.getElementById('new-practical-passed').checked,
    wears_glasses: document.getElementById('new-glasses').checked,
    ueberlandfahrten: [0,0,0,0,0], // 0-4 FÃ¼llstÃ¤nde
    autobahnfahrten: [0,0,0,0], // 0-4 FÃ¼llstÃ¤nde
    nachtfahrten: [0,0,0], // 0-4 FÃ¼llstÃ¤nde
    uebungsfahrten_ganz: [],
    uebungsfahrten_halb: [],
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  };

  const students = StorageManager.getStudents(currentClass);
  students.push(newStudent);
  StorageManager.saveStudents(students, currentClass);

  closeNewStudentDialog();
  renderStudentList();

  // Erfolgsmeldung
  setTimeout(() => {
    alert(`âœ… ${name} ${surname} wurde erfolgreich hinzugefÃ¼gt!`);
  }, 100);
}

function showAlert(message) {
  alert(message);
}

// SCHÃœLER BEARBEITEN FUNKTION
function showEditStudentDialog(studentId) {
  const student = StorageManager.getStudentById(studentId, currentClass);
  if (!student) return;

  const dialogHtml = `
    <div class="dialog-overlay" onclick="closeEditDialog(event)">
      <div class="dialog" onclick="event.stopPropagation()">
        <h2>SchÃ¼ler bearbeiten</h2>
        <form onsubmit="updateStudent(event, '${studentId}')">
          <div class="form-group">
            <label for="edit-name">Vorname *</label>
            <input type="text" id="edit-name" value="${student.name}" required>
          </div>
          <div class="form-group">
            <label for="edit-surname">Nachname *</label>
            <input type="text" id="edit-surname" value="${student.surname}" required>
          </div>
          <div class="form-group">
            <label for="edit-phone">Telefon</label>
            <input type="tel" id="edit-phone" value="${student.phone || ''}" placeholder="01234567890">
          </div>
          <div class="form-group">
            <label for="edit-address">StraÃŸe, Hausnummer</label>
            <input type="text" id="edit-address" value="${student.address || ''}" placeholder="z.B. MusterstraÃŸe 123">
          </div>
          <div class="form-group">
            <label for="edit-postal-code">Postleitzahl</label>
            <input type="text" id="edit-postal-code" value="${student.postal_code || ''}" placeholder="z.B. 12345" maxlength="5">
          </div>
          <div class="form-group">
            <label for="edit-city">Stadt</label>
            <input type="text" id="edit-city" value="${student.city || ''}" placeholder="z.B. Berlin">
          </div>
          <div class="form-group">
            <label for="edit-birth">Geburtsdatum</label>
            <input type="date" id="edit-birth" value="${student.date_of_birth || ''}">
          </div>
          <div class="form-group">
            <label for="edit-start">Ausbildungsbeginn</label>
            <input type="date" id="edit-start" value="${student.start_date || ''}">
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="edit-glasses" ${student.wears_glasses ? 'checked' : ''} style="margin-right: 8px;">
              BrillentrÃ¤ger
            </label>
          </div>
          <div class="form-group">
            <label for="edit-theory-date">TheorieprÃ¼fung Datum</label>
            <input type="date" id="edit-theory-date" value="${student.theory_exam_date || ''}">
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="edit-theory-passed" ${student.theory_exam_passed ? 'checked' : ''} style="margin-right: 8px;">
              TheorieprÃ¼fung bestanden
            </label>
          </div>
          <div class="form-group">
            <label for="edit-practical-date">Praktische PrÃ¼fung Datum</label>
            <input type="date" id="edit-practical-date" value="${student.practical_exam_date || ''}">
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="edit-practical-passed" ${student.practical_exam_passed ? 'checked' : ''} style="margin-right: 8px;">
              Praktische PrÃ¼fung bestanden
            </label>
          </div>
          <div class="dialog-buttons">
            <button type="button" class="btn-secondary" onclick="closeEditDialog()">Abbrechen</button>
            <button type="submit" class="btn-primary">Speichern</button>
          </div>
        </form>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', dialogHtml);
}

function closeEditDialog(event) {
  if (event && event.target !== event.currentTarget) return;
  const dialog = document.querySelector('.dialog-overlay');
  if (dialog) dialog.remove();
}

function updateStudent(event, studentId) {
  event.preventDefault();

  const name = document.getElementById('edit-name').value.trim();
  const surname = document.getElementById('edit-surname').value.trim();
  const phone = document.getElementById('edit-phone').value.trim();
  const address = document.getElementById('edit-address').value.trim();
  const postalCode = document.getElementById('edit-postal-code').value.trim();
  const city = document.getElementById('edit-city').value.trim();
  const dateBirth = document.getElementById('edit-birth').value;
  const startDate = document.getElementById('edit-start').value;
  const wearsGlasses = document.getElementById('edit-glasses').checked;
  const theoryExamDate = document.getElementById('edit-theory-date').value;
  const theoryExamPassed = document.getElementById('edit-theory-passed').checked;
  const practicalExamDate = document.getElementById('edit-practical-date').value;
  const practicalExamPassed = document.getElementById('edit-practical-passed').checked;

  if (!name || !surname) {
    alert('âŒ Vor- und Nachname sind erforderlich!');
    return;
  }

  const student = StorageManager.getStudentById(studentId, currentClass);
  const updatedStudent = {
    ...student,
    name,
    surname,
    phone: phone || null,
    address: address || null,
    postal_code: postalCode || null,
    city: city || null,
    date_of_birth: dateBirth || null,
    start_date: startDate || student.start_date,
    wears_glasses: wearsGlasses,
    theory_exam_date: theoryExamDate || null,
    theory_exam_passed: theoryExamPassed,
    practical_exam_date: practicalExamDate || null,
    practical_exam_passed: practicalExamPassed,
    updated_at: new Date().toISOString()
  };

  StorageManager.updateStudent(updatedStudent, currentClass);
  
  closeEditDialog();
  
  // Ansicht aktualisieren
  if (currentView === 'detail') {
    renderStudentDetail(studentId);
  } else {
    renderStudentList();
  }

  alert(`âœ… ${name} ${surname} wurde erfolgreich aktualisiert!`);
}

// KOMMENTAR-FUNKTIONEN
function showCommentDialog(studentId, categoryKey, sectionKey, itemKey, event) {
  event.stopPropagation();

  const comments = getCommentsForStudent(studentId);
  const commentKey = `${categoryKey}_${sectionKey}_${itemKey}`;
  const existingComment = comments[commentKey] || '';

  const dialogHtml = `
    <div class="dialog-overlay" onclick="closeCommentDialog(event)">
      <div class="dialog" onclick="event.stopPropagation()">
        <h2>Kommentar</h2>
        <p style="margin-bottom: 16px; color: #6b7280;">${itemKey}</p>
        <div class="form-group">
          <label for="comment-text">Notiz / Kommentar:</label>
          <textarea id="comment-text" rows="4" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;">${existingComment}</textarea>
        </div>
        <div class="dialog-buttons">
          <button type="button" class="btn-secondary" onclick="closeCommentDialog()">Abbrechen</button>
          <button type="button" class="btn-primary" onclick="saveComment('${studentId}', '${commentKey}')">Speichern</button>
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', dialogHtml);
}

function showStudentCommentDialog(studentId) {
  const comments = getCommentsForStudent(studentId);
  const existingComment = comments['student_general'] || '';

  const dialogHtml = `
    <div class="dialog-overlay" onclick="closeCommentDialog(event)">
      <div class="dialog" onclick="event.stopPropagation()">
        <h2>SchÃ¼ler-Notizen</h2>
        <p style="margin-bottom: 16px; color: #6b7280;">Allgemeine Notizen zum SchÃ¼ler</p>
        <div class="form-group">
          <label for="comment-text">Notiz / Kommentar:</label>
          <textarea id="comment-text" rows="6" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;">${existingComment}</textarea>
        </div>
        <div class="dialog-buttons">
          <button type="button" class="btn-secondary" onclick="closeCommentDialog()">Abbrechen</button>
          <button type="button" class="btn-primary" onclick="saveComment('${studentId}', 'student_general')">Speichern</button>
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', dialogHtml);
}

function closeCommentDialog(event) {
  if (event && event.target !== event.currentTarget) return;
  const dialog = document.querySelector('.dialog-overlay');
  if (dialog) dialog.remove();
}

function saveComment(studentId, commentKey) {
  const commentText = document.getElementById('comment-text').value.trim();
  const comments = getCommentsForStudent(studentId);

  if (commentText) {
    comments[commentKey] = commentText;
  } else {
    delete comments[commentKey];
  }

  saveCommentsForStudent(studentId, comments);
  closeCommentDialog();

  // Ansicht aktualisieren um Kommentar-Icons zu zeigen
  if (currentView === 'detail') {
    renderStudentDetail(studentId);
  }

  if (commentText) {
    alert('âœ… Kommentar gespeichert!');
  } else {
    alert('âœ… Kommentar gelÃ¶scht!');
  }
}

function getCommentsForStudent(studentId) {
  const stored = localStorage.getItem('fahrschul_comments_professional');
  const allComments = stored ? JSON.parse(stored) : {};
  return allComments[studentId] || {};
}

function saveCommentsForStudent(studentId, comments) {
  const stored = localStorage.getItem('fahrschul_comments_professional');
  const allComments = stored ? JSON.parse(stored) : {};
  allComments[studentId] = comments;
  localStorage.setItem('fahrschul_comments_professional', JSON.stringify(allComments));
}

// ðŸš€ MULTI-KLASSEN-APP INITIALISIERUNG
function initMultiClassApp() {
  // Migration der alten Daten
  StorageManager.migrateOldData();
  
  // Demo-Daten initialisieren (falls keine vorhanden)
  StorageManager.initDemoData();
  
  // WICHTIG: Theme-Zustand aus localStorage laden
  initThemeFromStorage();
  
  // ðŸ§¹ MIGRATIONS UND BEREINIGUNGEN
  StorageManager.migrateOldData();
  removeOldDemoData(); // Entferne Daniel Daft falls vorhanden
  
  // Starte mit Klassenauswahl
  currentView = 'classSelection';
  renderClassSelection();
  
  // LOADING SCREEN AUSBLENDEN - UI STATE MANAGEMENT
  document.getElementById('loading').style.display = 'none';
  document.getElementById('main-content').style.display = 'block';
  
  console.log('âœ… Multi-Klassen-App erfolgreich gestartet');
  
  // ðŸ”” BACKUP-ERINNERUNG PRÃœFEN (nach 3 Sekunden)
  setTimeout(() => {
    if (StorageManager.shouldShowBackupReminder()) {
      showBackupReminder();
    }
  }, 3000);
}

// ðŸŒ™ THEME-INITIALISIERUNG BEIM APP-START
function initThemeFromStorage() {
  try {
    const savedTheme = localStorage.getItem('fahrschul-theme');
    console.log('ðŸ”„ Lade gespeicherten Theme:', savedTheme);
    
    if (savedTheme === 'dark') {
      // Dark Mode aktivieren
      document.body.classList.add('dark-mode');
      document.documentElement.setAttribute('data-theme', 'dark');
      console.log('ðŸŒ™ Dark Mode beim Start aktiviert');
    } else {
      // Light Mode aktivieren (Standard)
      document.body.classList.remove('dark-mode');
      document.documentElement.setAttribute('data-theme', 'light');
      console.log('â˜€ï¸ Light Mode beim Start aktiviert');
    }
    
    // Theme-Manager initialisieren falls vorhanden
    if (typeof ThemeManager !== 'undefined' && ThemeManager.init) {
      ThemeManager.init();
      console.log('âœ… ThemeManager initialisiert');
    }
    
  } catch (error) {
    console.error('âŒ Theme-Initialisierung fehlgeschlagen:', error);
    // Fallback: Light Mode
    document.body.classList.remove('dark-mode');
    document.documentElement.setAttribute('data-theme', 'light');
    localStorage.setItem('fahrschul-theme', 'light');
  }
}



// App Initialization
function initApp() {
  try {
    console.log('ðŸš— Deutsche Fahrschul-App wird initialisiert...');
    
    // SICHERHEITSCHECK: KRITISCHE DOM-ELEMENTE
    const loadingElement = document.getElementById('loading');
    const mainContentElement = document.getElementById('main-content');
    
    if (!loadingElement || !mainContentElement) {
      throw new Error('Kritische DOM-Elemente fehlen: loading oder main-content');
    }
    
    // Demo-Daten initialisieren
    StorageManager.initDemoData();
    console.log('âœ… Demo-Daten geladen');

    // Loading Screen ausblenden
    loadingElement.style.display = 'none';
    mainContentElement.style.display = 'block';

    // Student List anzeigen
    renderStudentList();

    console.log('âœ… Professionelle Version gestartet nach Ihren Bildern!');

  } catch (error) {
    console.error('âŒ Fehler beim Initialisieren:', error);
    const loadingElement = document.getElementById('loading');
    if (loadingElement) {
      loadingElement.innerHTML = `
        <div class="loading-title">Fehler beim Laden</div>
        <div class="loading-subtitle">Bitte Seite neu laden</div>
        <div style="margin-top: 20px; font-size: 12px; color: #ef4444;">
          Fehler: ${error.message}
        </div>
      `;
    }
  }
}

// App starten
// 3-CONTAINER RESPONSIVE LAYOUT-OPTIMIERUNG
function optimizeMobileLayouts() {
  const isTabletPortrait = window.innerWidth >= 769 && window.innerWidth <= 1024 && window.innerHeight > window.innerWidth;
  const isMobile = window.innerWidth <= 768;
  const isMobileLandscape = window.innerHeight <= 500 && window.innerWidth > window.innerHeight && window.innerWidth <= 900;
  
  if (isMobile || isTabletPortrait || isMobileLandscape) {
    let deviceType = 'Mobile';
    if (isTabletPortrait) deviceType = 'Tablet Portrait';
    if (isMobileLandscape) deviceType = 'Mobile Landscape';
    
    console.log(`ðŸ“± Starte ${deviceType} Layout-Optimierung...`);
    console.log('ðŸ“± Starte 3-Container Mobile Layout-Optimierung...');
    
    // TRAINING-HEADERS ZU FLEXBOX MACHEN
    const trainingHeaders = document.querySelectorAll('.training-header');
    trainingHeaders.forEach((header, index) => {
      header.style.display = 'flex';
      header.style.flexDirection = 'column';
      header.style.alignItems = 'stretch';
      header.style.gap = '0';
      
      console.log(`âœ… Training-Header ${index + 1} zu Flexbox gemacht`);
    });
    
    // CONTAINER 1: TEXT-BEREICHE
    const textContainers = document.querySelectorAll('.training-info');
    textContainers.forEach((container, index) => {
      container.style.width = '100%';
      container.style.textAlign = 'center';
      container.style.padding = isTabletPortrait ? '16px' : '12px';
      container.style.margin = isTabletPortrait ? '0 0 12px 0' : '0 0 8px 0';
      
      console.log(`âœ… Text-Container ${index + 1} optimiert fÃ¼r ${deviceType}`);
    });
    
    // CONTAINER 2: KREISE-BEREICHE  
    const circleContainers = document.querySelectorAll('.grundstufe-circles');
    circleContainers.forEach((container, index) => {
      container.style.width = '100%';
      container.style.display = 'flex';
      container.style.flexDirection = 'column';
      container.style.alignItems = 'center';
      container.style.justifyContent = 'center';
      container.style.padding = isTabletPortrait ? '16px' : '12px';
      container.style.margin = isTabletPortrait ? '0 0 12px 0' : '0 0 8px 0';
      container.style.gap = isTabletPortrait ? '10px' : '8px';
      
      // Kreise-Reihen zentrieren
      const circleRows = container.querySelectorAll('.circle-row');
      circleRows.forEach(row => {
        row.style.display = 'flex';
        row.style.justifyContent = 'center';
        row.style.alignItems = 'center';
        row.style.gap = isTabletPortrait ? '12px' : '8px';
        row.style.flexWrap = 'wrap';
        row.style.width = '100%';
        row.style.margin = isTabletPortrait ? '6px 0' : '4px 0';
      });
      
      console.log(`âœ… Kreise-Container ${index + 1} zentriert`);
    });
    
    // CONTAINER 3: FORTSCHRITT-BEREICHE - UNTERSCHIEDLICHE BEHANDLUNG
    const progressElements = document.querySelectorAll('.training-progress');
    progressElements.forEach((progress, index) => {
      progress.style.width = '100%';
      progress.style.display = 'flex';
      progress.style.alignItems = 'center';
      progress.style.padding = isTabletPortrait ? '16px' : '12px';
      progress.style.margin = '0';
      progress.style.marginLeft = '0';
      progress.style.gap = isTabletPortrait ? '12px' : '8px';
      
      // SICHTBARKEIT UND POSITIONIERUNG SICHERSTELLEN
      progress.style.display = 'flex';
      progress.style.width = '100%';
      progress.style.position = 'relative';
      progress.style.zIndex = '10';
      
      // PRÃœFE OB HEADER KREISE HAT
      const parentHeader = progress.closest('.training-header');
      const hasCircles = parentHeader && parentHeader.querySelector('.training-info-with-circles');
      
      if (isTabletPortrait) {
        if (hasCircles) {
          // MIT KREISEN: ZENTRIERT
          progress.style.justifyContent = 'center';
          progress.classList.add('has-circles');
          console.log(`âœ… Progress ${index + 1} MIT Kreisen - zentriert`);
        } else {
          // OHNE KREISE: ZENTRIERT UNTER SUBTITEL  
          progress.style.justifyContent = 'center';
          progress.style.paddingRight = '0';
          progress.classList.add('no-circles');
          console.log(`âœ… Progress ${index + 1} OHNE Kreise - zentriert unter Subtitel`);
        }
      } else {
        // MOBILE: IMMER ZENTRIERT
        progress.style.justifyContent = 'center';
        console.log(`âœ… Progress ${index + 1} Mobile - zentriert`);
      }
      
      console.log(`âœ… Fortschritt-Container ${index + 1} zentriert`);
    });
    
    console.log(`ðŸ“± ${deviceType} Layout-Optimierung abgeschlossen!`);
  }
}

// BEOBACHTER FÃœR DYNAMISCHE INHALTE
function initMobileLayoutObserver() {
  const isTabletPortrait = window.innerWidth >= 769 && window.innerWidth <= 1024 && window.innerHeight > window.innerWidth;
  const isMobile = window.innerWidth <= 768;
  const isMobileLandscape = window.innerHeight <= 500 && window.innerWidth > window.innerHeight && window.innerWidth <= 900;
  
  if (isMobile || isTabletPortrait || isMobileLandscape) {
    const observer = new MutationObserver(function(mutations) {
      let shouldOptimize = false;
      
      mutations.forEach(function(mutation) {
        if (mutation.type === 'childList') {
          const target = mutation.target;
          if (target.classList && target.classList.contains('training-header')) {
            shouldOptimize = true;
          }
        }
      });
      
      if (shouldOptimize) {
        console.log('ðŸ”„ Training-Header verÃ¤ndert, re-optimiere...');
        setTimeout(optimizeMobileLayouts, 50);
      }
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
    
    console.log('ðŸ‘ï¸ Responsive Layout Observer aktiviert fÃ¼r Mobile/Tablet');
  }
}

document.addEventListener('DOMContentLoaded', function() {
  console.log('ðŸ“± DOM geladen, starte professionelle App nach Ihren Bildern...');
  
  // WICHTIG: Theme-Zustand laden (auch fÃ¼r alte Version)
  initThemeFromStorage();
  
  // PWA Service Worker registrieren (iOS & Android) - EMERGENCY VERSION
  if ('serviceWorker' in navigator) {
    // Listen for messages from service worker
    navigator.serviceWorker.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'FORCE_RELOAD') {
        console.log('ðŸ”„ Service Worker requests force reload');
        window.location.reload(true);
      }
    });
    
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        console.log('âœ… PWA: Emergency Service Worker registered', registration);
        
        // PrÃ¼fe auf Updates
        registration.addEventListener('updatefound', () => {
          console.log('ðŸ”„ PWA: Update gefunden!');
          const newWorker = registration.installing;
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // Neue Version ist verfÃ¼gbar
              console.log('âœ… PWA: Neue Version installiert - Cache wird geleert');
              
              // App sofort neu laden um neue Version zu aktivieren
              if (confirm('Neue App-Version verfÃ¼gbar! Jetzt aktualisieren?\n(Behebt Berechnungsprobleme)')) {
                // LÃ¶sche lokalen Storage falls nÃ¶tig
                if ('caches' in window) {
                  caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                  });
                }
                
                // Force reload
                window.location.reload(true);
              }
            }
          });
        });
        
        // iOS Installation Prompt nach App-Start
        setTimeout(() => showIOSInstallPrompt(), 5000);
      })
      .catch((error) => {
        console.log('âŒ PWA: Service Worker registration failed', error);
      });
  }
  
  // Standard Installation Prompt (Android)
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    setTimeout(() => showInstallPrompt(deferredPrompt), 3000);
  });
  
  // DIREKTE LÃ–SUNG: APP SOFORT STARTEN
  const directStart = () => {
    console.log('ðŸš€ Direkter Start der App...');
    
    // Theme Manager initialisieren
    ThemeManager.init();
    
    try {
      // Loading Screen ausblenden und Main Content anzeigen
      const loading = document.getElementById('loading');
      const mainContent = document.getElementById('main-content');
      
      if (loading) loading.style.display = 'none';
      if (mainContent) mainContent.style.display = 'block';
      
      // Einfache Student-Liste ohne komplexe Logik
      if (mainContent && mainContent.innerHTML.trim() === '') {
        mainContent.innerHTML = `
          <div class="container">
            <div class="main-header">
              <h1>Deutsche Fahrschul-App</h1>
              <button class="btn-primary" onclick="alert('PDF Export')">ðŸ“„ PDF Export</button>
            </div>
            <div class="student-grid">
              <div class="student-card" onclick="showTrainingView()">
                <div class="student-info">
                  <h3>Daniel Daft</h3>
                  <p class="student-details">
                    ðŸ“ž 01713071787<br>
                    ðŸ“ Friedrich-Engels-Str. 2, 10785 Berlin<br>
                    ðŸ“… Beginn: 04.09.2025
                  </p>
                </div>
                <div class="student-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: 75%"></div>
                  </div>
                  <div class="progress-text">75% abgeschlossen</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // PROGRESS INDICATOR FIX - DIREKT ANWENDEN
      setTimeout(() => {
        const progressElements = document.querySelectorAll('.training-progress');
        progressElements.forEach((progress, index) => {
          progress.style.display = 'flex';
          progress.style.justifyContent = 'center';
          progress.style.width = '100%';
          progress.style.alignItems = 'center';
          progress.style.gap = '12px';
          progress.style.padding = '16px';
          progress.style.position = 'relative';
          progress.style.zIndex = '10';
          
          console.log(`ðŸ”§ Progress-Indikator ${index + 1} direkt zentriert`);
        });
      }, 100);
      
      console.log('âœ… Direkte App-Initialisierung erfolgreich');
      
    } catch (error) {
      console.error('âŒ Fehler bei direktem Start:', error);
    }
  };
  
  // MEHRFACH-STRATEGIE: Verschiedene AnsÃ¤tze
  
  // Strategie 1: DEAKTIVIERT - Verwende neue Multi-Klassen-App
  // directStart(); - Deaktiviert fÃ¼r Multi-Klassen-System
  
  // Strategie 2: DEAKTIVIERT - Verwende neue Multi-Klassen-App
  setTimeout(() => {
    try {
      // Multi-Klassen-App bereits initialisiert
      console.log('ðŸš€ Alte initApp deaktiviert - Multi-Klassen-App lÃ¤uft bereits');
    } catch (error) {
      console.warn('initApp fehlgeschlagen, nutze direkten Start:', error);
    }
  }, 100);
  
  // Strategie 3: Mobile Layout Optimierung
  setTimeout(() => {
    try {
      if (typeof optimizeMobileLayouts === 'function') {
        optimizeMobileLayouts();
      }
    } catch (error) {
      console.warn('Mobile Layout fehlgeschlagen:', error);
    }
  }, 500);
  
  // Strategie 4: Final Force-Fix
  setTimeout(() => {
    console.log('ðŸ”§ Final Force-Fix fÃ¼r Progress-Indikatoren...');
    
    const progressElements = document.querySelectorAll('.training-progress');
    progressElements.forEach((progress, index) => {
      progress.style.display = 'flex !important';
      progress.style.justifyContent = 'center !important';
      progress.style.width = '100% !important';
      progress.style.alignItems = 'center !important';
      progress.style.gap = '12px !important';
      progress.style.padding = '16px !important';
      progress.style.position = 'relative !important';
      progress.style.zIndex = '10 !important';
      
      console.log(`ðŸ”§ Final Progress-Fix ${index + 1} angewendet`);
    });
    
    console.log('âœ… Final Force-Fix abgeschlossen');
  }, 2000);
  
  // ðŸš€ MULTI-KLASSEN-APP INITIALISIERUNG
  console.log('ðŸš€ Multi-Klassen-App startet...');
  setTimeout(() => {
    initMultiClassApp();
  }, 100);
});

// GLOBALE FUNKTION FÃœR TRAINING VIEW
function showTrainingView() {
  const mainContent = document.getElementById('main-content');
  if (mainContent) {
    mainContent.innerHTML = `
      <div class="container">
        <div class="main-header">
          <button class="btn-primary" onclick="location.reload()">â† ZurÃ¼ck</button>
          <h1>Daniel Daft - Ausbildungsfortschritt</h1>
          <button class="btn-primary">ðŸ“„ PDF</button>
        </div>
        
        <!-- Grundstufe -->
        <div class="training-section">
          <div class="training-header grundstufe">
            <div class="training-info-with-circles">
              <div class="training-info">
                <h3>Grundstufe</h3>
                <div class="training-subtitle">Einweisung und Bedienung</div>
              </div>
              <div class="grundstufe-circles">
                <div class="circle-row">
                  <div class="ue-circle">1</div>
                  <div class="ue-circle">2</div>
                  <div class="add-circle-btn">+</div>
                  <span style="margin-left: 8px; color: #22c55e; font-weight: 600; font-size: 14px;">UE</span>
                </div>
              </div>
            </div>
            <div class="training-progress" style="display: flex; justify-content: center; width: 100%; align-items: center; gap: 12px; padding: 16px;">
              <div class="progress-circle"></div>
              <div class="progress-text">85%</div>
              <div class="progress-count">(11/13)</div>
              <div class="dropdown-arrow">â–¼</div>
            </div>
          </div>
        </div>
        
        <!-- Aufbaustufe -->
        <div class="training-section">
          <div class="training-header aufbaustufe">
            <div class="training-info-with-circles">
              <div class="training-info">
                <h3>Aufbaustufe</h3>
                <div class="training-subtitle">Umweltschonendes, vorausschauendes Fahren, Blickschulung</div>
              </div>
            </div>
            <div class="training-progress" style="display: flex; justify-content: center; width: 100%; align-items: center; gap: 12px; padding: 16px;">
              <div class="progress-circle"></div>
              <div class="progress-text">60%</div>
              <div class="progress-count">(5/8)</div>
              <div class="dropdown-arrow">â–¼</div>
            </div>
          </div>
        </div>
        
        <!-- Leistungsstufe -->
        <div class="training-section">
          <div class="training-header leistungsstufe">
            <div class="training-info-with-circles">
              <div class="training-info">
                <h3>Leistungsstufe</h3>
                <div class="training-subtitle">Schwierige Verkehrssituationen, umweltschonendes, vorausschauendes Fahren, Blickschulung/Bremsbereitschaft</div>
              </div>
            </div>
            <div class="training-progress" style="display: flex; justify-content: center; width: 100%; align-items: center; gap: 12px; padding: 16px;">
              <div class="progress-circle"></div>
              <div class="progress-text">40%</div>
              <div class="progress-count">(6/15)</div>
              <div class="dropdown-arrow">â–¼</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }
}

// PWA iOS Installation Prompt
function showIOSInstallPrompt() {
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const isStandalone = window.navigator.standalone;
  
  if (isIOS && !isStandalone) {
    // PrÃ¼fe ob Benutzer bereits informiert wurde (heute)
    const lastPrompt = localStorage.getItem('ios-install-prompt-date');
    const today = new Date().toDateString();
    
    if (lastPrompt !== today) {
      setTimeout(() => {
        const installMsg = `ðŸ“± Diese Fahrschul-App kann als native App installiert werden!\n\nðŸ‘† Tippe auf das Teilen-Symbol (â¤´ï¸) unten\nðŸ“‹ WÃ¤hle "Zum Home-Bildschirm"\nâœ… Die App funktioniert dann komplett offline!\n\nSoll ich dir das nochmal zeigen?`;
        
        if (confirm(installMsg)) {
          // Detaillierte Anweisungen
          alert(`ðŸ“± INSTALLATION AUF iOS:\n\n1ï¸âƒ£ Tippe unten auf das Teilen-Symbol â¤´ï¸\n2ï¸âƒ£ Scrolle nach unten\n3ï¸âƒ£ Tippe "Zum Home-Bildschirm"\n4ï¸âƒ£ Tippe "HinzufÃ¼gen"\n\nâœ… Fertig! Die App ist jetzt offline verfÃ¼gbar.`);
        }
        
        localStorage.setItem('ios-install-prompt-date', today);
      }, 8000); // Nach 8 Sekunden zeigen
    }
  }
}

// Standard Installation Prompt (Android/Chrome)
function showInstallPrompt(deferredPrompt) {
  const installBanner = document.createElement('div');
  installBanner.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 20px;
    right: 20px;
    background: linear-gradient(135deg, #2563eb, #3b82f6);
    color: white;
    padding: 16px;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 8px 32px rgba(37, 99, 235, 0.3);
    z-index: 1000;
    font-size: 14px;
    font-weight: 600;
    text-align: center;
    animation: slideUp 0.3s ease;
  `;
  
  installBanner.innerHTML = `
    <div style="margin-bottom: 8px;">ðŸ“± Diese App offline installieren?</div>
    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 12px;">Funktioniert ohne Internet!</div>
    <div style="display: flex; gap: 12px; justify-content: center;">
      <button onclick="this.parentElement.parentElement.remove()" style="background: rgba(255,255,255,0.2); border: none; padding: 8px 16px; border-radius: 6px; color: white; cursor: pointer;">SpÃ¤ter</button>
      <button id="install-btn" style="background: white; border: none; padding: 8px 16px; border-radius: 6px; color: #2563eb; font-weight: 600; cursor: pointer;">Installieren</button>
    </div>
  `;
  
  // CSS Animation hinzufÃ¼gen
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(installBanner);
  
  // Install Button Event
  document.getElementById('install-btn').onclick = () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('âœ… PWA wurde installiert');
        }
        installBanner.remove();
      });
    }
  };
  
  // Auto-hide nach 15 Sekunden
  setTimeout(() => {
    if (installBanner.parentNode) {
      installBanner.remove();
    }
  }, 15000);
}

// Offline/Online Status Detection
window.addEventListener('online', () => {
  console.log('ðŸ“¶ App ist wieder online');
  showToast('ðŸ“¶ Verbindung wiederhergestellt', 'success');
});

window.addEventListener('offline', () => {
  console.log('ðŸ“± App ist offline - funktioniert trotzdem!');
  showToast('ðŸ“± Offline-Modus aktiv', 'info');
});

// Toast Notification System
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  const bgColor = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6';
  
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${bgColor};
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    z-index: 1001;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    animation: slideInRight 0.3s ease;
  `;
  
  toast.innerHTML = message;
  
  // Animation CSS
  if (!document.querySelector('#toast-styles')) {
    const toastStyles = document.createElement('style');
    toastStyles.id = 'toast-styles';
    toastStyles.textContent = `
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
    `;
    document.head.appendChild(toastStyles);
  }
  
  document.body.appendChild(toast);
  
  // Auto-remove nach 3 Sekunden
  setTimeout(() => {
    if (toast.parentNode) {
      toast.remove();
    }
  }, 3000);
}

// CACHE-LEER-FUNKTION FÃœR PWA-PROBLEME
window.clearAppCache = function() {
  if (confirm('App-Cache leeren und neu laden?\n(LÃ¶st PWA Offline-Probleme mit veralteten Berechnungen)')) {
    // Service Worker Cache leeren
    if ('caches' in window) {
      caches.keys().then(names => {
        names.forEach(name => {
          console.log('ðŸ—‘ï¸ LÃ¶sche Cache:', name);
          caches.delete(name);
        });
        
        // Local Storage auch leeren (optional)
        if (confirm('Auch alle SchÃ¼lerdaten lÃ¶schen? (Nur bei Problemen nÃ¶tig)')) {
          localStorage.clear();
        }
        
        // Service Worker neu registrieren
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.getRegistrations().then(registrations => {
            registrations.forEach(registration => registration.unregister());
          }).then(() => {
            console.log('ðŸ”„ Service Worker deregistriert, lÃ¤dt neu...');
            window.location.reload(true);
          });
        } else {
          window.location.reload(true);
        }
      });
    } else {
      window.location.reload(true);
    }
  }
};

// DEBUG-FUNKTION - ZEIGE AKTUELLE CACHE-VERSION
window.checkCacheVersion = function() {
  if ('caches' in window) {
    caches.keys().then(names => {
      console.log('ðŸ“¦ Aktuelle Caches:', names);
      alert('Cache-Versionen:\n' + names.join('\n') + '\n\nErwartet: fahrschul-app-v2.0-fixed-calculation');
    });
  }
};

// GLOBALE DEBUG-FUNKTIONEN VERFÃœGBAR MACHEN
window.clearAppCache = clearAppCache;
window.checkCacheVersion = checkCacheVersion;

// ðŸ”„ MULTI-KLASSEN BACKUP-HANDLER-FUNKTIONEN (iOS-OPTIMIERT)
function handleExportBackup() {
  const result = StorageManager.exportBackup();
  if (result.success) {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 0);
    const isPWA = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
    
    console.log(`ðŸ” Export Debug: iOS=${isIOS}, PWA=${isPWA}, Method=${result.method}`);
    console.log(`ðŸ“± User Agent: ${navigator.userAgent}`);
    console.log(`ðŸ“± Platform: ${navigator.platform}, MaxTouchPoints: ${navigator.maxTouchPoints}`);
    console.log(`ðŸ“± Navigator Share Support: ${!!navigator.share}`);
    console.log(`ðŸ“± Navigator canShare Support: ${!!navigator.canShare}`);
    console.log(`ðŸ“± Standalone: ${window.navigator.standalone}`);
    console.log(`ðŸ“± Display Mode: ${window.matchMedia('(display-mode: standalone)').matches}`);
    
    let method = '';
    switch(result.method) {
      case 'PWA': 
        method = isIOS ? 'iOS Share-Dialog' : 'PWA-Zwischenablage'; 
        break;
      case 'iOS-Browser': method = 'iOS-Browser-Tab'; break;
      case 'Desktop': method = 'Desktop-Download'; break;
      default: method = result.method; break;
    }
    
    let message = `âœ… Multi-Klassen-Backup erfolgreich erstellt!\n\nðŸ“ Datei: ${result.filename}\nðŸ‘¥ Gesamt-SchÃ¼ler: ${result.totalStudents}\nðŸ“± Methode: ${method}\n\n`;
    
    if (result.method === 'PWA' && isIOS) {
      message += `ðŸŽ iOS PWA: Das native Share-Dialog sollte sich Ã¶ffnen.\nWÃ¤hle "In Dateien sichern" oder teile per E-Mail/AirDrop!\n\nâ„¹ï¸ Falls das Share-Dialog nicht erscheint, wurde das Backup in die Zwischenablage kopiert.`;
    } else if (result.method === 'PWA') {
      message += `âœ¨ PWA-Modus: Backup wurde in die Zwischenablage kopiert.\nÃ–ffne jetzt eine Notiz-App und fÃ¼ge es ein!`;
    } else if (result.method === 'iOS-Browser') {
      message += `ðŸ“‹ Die Backup-Daten werden in einem neuen Tab geÃ¶ffnet.`;
    } else {
      message += `ðŸ’¾ Die Datei wurde in deinen Downloads gespeichert.`;
    }
    
    alert(message);
  } else {
    alert(`âŒ Backup fehlgeschlagen:\n${result.error}`);
  }
}

function handleImportBackup() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json,text/plain';
  input.style.display = 'none';
  
  input.onchange = async (e) => {
    if (e.target.files.length > 0) {
      const result = await StorageManager.importBackup(e.target);
      
      if (result.success && !result.cancelled) {
        let message = `âœ… Backup erfolgreich wiederhergestellt!\n\n`;
        if (result.isMultiClass) {
          message += `ðŸ‘¥ Gesamt-SchÃ¼ler: ${result.totalStudents}\nðŸ“š Multi-Klassen-Backup wiederhergestellt`;
        } else if (result.isLegacy) {
          message += `ðŸ‘¥ SchÃ¼ler: ${result.studentsCount}\nðŸ“š Legacy-Backup in BE-Klasse importiert`;
        }
        
        // OFFLINE-SICHERES NEULADEN
        message += `\n\nðŸ”„ Daten werden aktualisiert...`;
        alert(message);
        
        // Versuche Neuladen, falls offline dann manuell rendern
        try {
          if (navigator.onLine !== false) {
            // Online oder unbekannt - versuche Reload
            window.location.reload();
          } else {
            // Definitiv offline - manuell rendern
            console.log('ðŸ“± Offline-Modus: Rendere Ansicht manuell neu');
            renderClassSelection(); // Direkte Neu-Renderung
          }
        } catch (reloadError) {
          // Fallback: Manuelles Rendern
          console.log('ðŸ”„ Reload fehlgeschlagen, rendere manuell:', reloadError);
          renderClassSelection();
        }
      } else if (result.cancelled) {
        alert('â„¹ï¸ Wiederherstellung abgebrochen.');
      } else {
        alert(`âŒ Import fehlgeschlagen:\n${result.error}`);
      }
    }
    document.body.removeChild(input);
  };
  
  document.body.appendChild(input);
  input.click();
}

// ðŸ”” BACKUP-ERINNERUNGS-SYSTEM
function showBackupReminder() {
  const lastBackup = StorageManager.getLastBackupDate();
  let message;
  
  if (!lastBackup) {
    message = `ðŸ”” Backup-Erinnerung\n\nâš ï¸ Sie haben noch kein Backup erstellt!\n\nEin regelmÃ¤ÃŸiges Backup schÃ¼tzt Ihre SchÃ¼lerdaten vor Verlust.\n\nðŸ’¡ Tipp: Erstellen Sie jetzt ein Backup Ã¼ber das MenÃ¼ (â˜°) oben rechts.`;
  } else {
    const daysSince = Math.floor((new Date() - lastBackup) / (1000 * 60 * 60 * 24));
    const dateStr = lastBackup.toLocaleDateString('de-DE');
    message = `ðŸ”” Backup-Erinnerung\n\nâ° Ihr letztes Backup ist ${daysSince} Tage alt\nðŸ“… Erstellt am: ${dateStr}\n\nðŸ’¡ Empfehlung: Erstellen Sie wÃ¶chentlich ein neues Backup Ã¼ber das MenÃ¼ (â˜°) oben rechts.`;
  }
  
  const userChoice = confirm(`${message}\n\nðŸ“± MÃ¶chten Sie jetzt ein Backup erstellen?`);
  
  if (userChoice) {
    // Hamburger Menu Ã¶ffnen und Backup-Prozess starten
    toggleHamburgerMenu();
    setTimeout(() => {
      handleExportBackup();
    }, 500);
  } else {
    // SpÃ¤ter erinnern (in 3 Tagen)  
    const nextReminder = new Date();
    nextReminder.setDate(nextReminder.getDate() + 3);
    localStorage.setItem('fahrschul_backup_reminder_dismissed', nextReminder.toISOString());
    console.log('ðŸ“… Backup-Erinnerung verschoben auf:', nextReminder.toLocaleDateString('de-DE'));
  }
}

// ðŸŽ¯ KLASSEN-MANAGEMENT HILFSFUNKTIONEN
function generateClassCard(className) {
  const studentCount = StorageManager.getStudents(className).length;
  const description = getClassDescription(className);
  
  return `
    <div class="class-card" onclick="selectClass('${className}')">
      <div class="class-card-header">
        <div class="class-title">${className}</div>
      </div>
      <div class="class-description">${description}</div>
      <div class="class-stats">
        <div class="student-count">${studentCount} SchÃ¼ler</div>
        ${studentCount > 0 ? '<div class="has-students">â—</div>' : '<div class="no-students">â—‹</div>'}
      </div>
    </div>`;
}

function renderClassCheckboxes() {
  const allClasses = ['B', 'BE', 'AM', 'A1', 'A2', 'A', 'C1', 'C1E', 'C', 'CE'];
  const settings = StorageManager.getClassSettings();
  
  return allClasses.map(className => {
    const description = getClassDescription(className);
    const isChecked = settings[className]?.visible ? 'checked' : '';
    
    return `
      <div class="class-checkbox-item">
        <label class="checkbox-label">
          <input type="checkbox" id="class-${className}" ${isChecked} 
                 onchange="toggleClassVisibility('${className}', this.checked)">
          <span class="checkbox-custom"></span>
          <div class="checkbox-content">
            <div class="checkbox-title">${className}</div>
            <div class="checkbox-description">${description}</div>
          </div>
        </label>
      </div>`;
  }).join('');
}

// ðŸ”§ KLASSEN-MANAGER FUNKTIONEN
function openClassManager() {
  // TemporÃ¤re Einstellungen zurÃ¼cksetzen
  window.tempClassSettings = null;
  
  document.getElementById('classManagerModal').style.display = 'block';
  console.log('âš™ï¸ Klassen-Manager geÃ¶ffnet');
}

function closeClassManager() {
  document.getElementById('classManagerModal').style.display = 'none';
  
  // TemporÃ¤re Ã„nderungen verwerfen falls nicht gespeichert
  if (window.tempClassSettings) {
    delete window.tempClassSettings;
    console.log('âš ï¸ TemporÃ¤re Ã„nderungen verworfen');
  }
}

function toggleClassVisibility(className, isVisible) {
  // TemporÃ¤re Einstellungen abrufen oder erstellen
  if (!window.tempClassSettings) {
    window.tempClassSettings = { ...StorageManager.getClassSettings() };
  }
  
  window.tempClassSettings[className].visible = isVisible;
  console.log(`ðŸ”„ ${className} ${isVisible ? 'aktiviert' : 'deaktiviert'} (temporÃ¤r)`);
}

function saveClassSettings() {
  if (window.tempClassSettings) {
    StorageManager.saveClassSettings(window.tempClassSettings);
    delete window.tempClassSettings;
  }
  
  closeClassManager();
  renderClassSelection(); // Neu rendern mit neuen Einstellungen
  
  console.log('âœ… Klassen-Einstellungen gespeichert und angewendet');
}

function resetToDefaults() {
  // LÃ¶sche gespeicherte Einstellungen
  localStorage.removeItem('fahrschul_class_settings');
  
  // Checkboxes zurÃ¼cksetzen
  const allClasses = ['B', 'BE', 'AM', 'A1', 'A2', 'A', 'C1', 'C1E', 'C', 'CE'];
  const defaultSettings = StorageManager.getClassSettings();
  
  allClasses.forEach(className => {
    const checkbox = document.getElementById(`class-${className}`);
    if (checkbox) {
      checkbox.checked = defaultSettings[className]?.visible || false;
    }
  });
  
  window.tempClassSettings = defaultSettings;
  console.log('ðŸ”„ Standard-Einstellungen wiederhergestellt');
}

// ðŸš› BE-SPEZIFISCHE RENDERING-FUNKTIONEN (SEPARATE LOGIK)

// BE-spezifische Spezial-Fahrten Header mit korrekten PS-Zahlen
function renderBESpecialFahrtenHeader(studentId, category, categoryKey, percentage, completedItems, totalItems, blueCircleCount) {
  const progress = StorageManager.getProgressForStudent(studentId, currentClass);
  const blueCircles = progress[`${categoryKey}_blue_circles`] || Array(blueCircleCount).fill(false);
  const quarterCircles = progress[`${categoryKey}_header_quarters`] || [];

  return `
    <div class="training-info-with-circles">
      <div class="training-info">
        <h3>${category.name}</h3>
        ${category.subtitle ? `<div class="training-subtitle">${category.subtitle}</div>` : ''}
      </div>
      <div class="grundstufe-circles" onclick="event.stopPropagation()">
        <div class="circle-row">
          ${blueCircles.map((filled, index) => `
            <div class="ue-circle ${filled ? 'blue-filled' : 'blue-empty'}" onclick="event.stopPropagation(); toggleBlueCircle('${studentId}', '${categoryKey}', ${index})" title="${category.name} ${index + 1} - Klick zum FÃ¼llen/Leeren">
              ${index + 1}
            </div>
          `).join('')}
          <span style="margin-left: 8px; color: #3b82f6; font-weight: 600; font-size: 14px;">PS</span>
        </div>
        <div class="circle-row">
          ${quarterCircles.map((fillLevel, index) => `
            <div class="quarter-circle ${getFillLevelClass(fillLevel)}"
                 onclick="event.stopPropagation(); toggleCategoryQuarterCircle('${studentId}', '${categoryKey}', ${index})"
                 title="Klicken: 0% â†’ 25% â†’ 50% â†’ 75% â†’ LÃ¶schen"></div>
          `).join('')}
          <div class="add-circle-btn" onclick="event.stopPropagation(); addCategoryQuarterCircle('${studentId}', '${categoryKey}')" title="Viertel-Kreis hinzufÃ¼gen">+</div>
          ${quarterCircles.length > 0 ? '<span style="margin-left: 8px; color: #22c55e; font-weight: 600; font-size: 14px;">UE</span>' : ''}
        </div>
      </div>
    </div>
    <div class="training-progress">
      <div class="progress-circle"></div>
      <div class="progress-text">${percentage}%</div>
      <div class="progress-count">(${completedItems}/${totalItems})</div>
      <div class="dropdown-arrow">â–¼</div>
    </div>
  `;
}

// BE-spezifische Kategorie-Header Logik
function renderBECategoryHeader(studentId, category, key, percentage, treatedItems, totalItems) {
  // BE-spezifische GrÃ¼ne Kreise
  if (key === 'grundstufe' || key === 'aufbaustufe' || key === 'leistungsstufe' || key === 'grundfahraufgaben' || key === 'wichtige_fahraufgaben') {
    return renderCategoryHeaderWithCircles(studentId, category, key, percentage, treatedItems, totalItems);
  }
  // BE-spezifische PS-Kreise mit KORREKTEN ZAHLEN
  else if (key === 'uberlandfahrten') {
    // Bundes-/LandstraÃŸen: 3 PS-Kreise (nicht 5!)
    return renderBESpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 3);
  } 
  else if (key === 'autobahn') {
    // Autobahnen: 1 PS-Kreis (nicht 4!)
    return renderBESpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 1);
  } 
  else if (key === 'dammerung_dunkelheit') {
    // DÃ¤mmerung: 1 PS-Kreis (nicht 3!)
    return renderBESpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 1);
  }
  // Alle anderen BE-Kategorien: Standard
  else {
    return renderStandardHeader(category, percentage, treatedItems, totalItems);
  }
}

// ðŸš— KLASSE-B-SPEZIFISCHE LOGIK (ORIGINAL)
function renderBCategoryHeader(studentId, category, key, percentage, treatedItems, totalItems) {
  if (key === 'grundstufe' || key === 'aufbaustufe' || key === 'leistungsstufe' || key === 'grundfahraufgaben') {
    return renderCategoryHeaderWithCircles(studentId, category, key, percentage, treatedItems, totalItems);
  } else if (key === 'uberlandfahrten') {
    return renderSpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 5);
  } else if (key === 'autobahn') {
    return renderSpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 4);
  } else if (key === 'dammerung_dunkelheit') {
    return renderSpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 3);
  } else {
    return renderStandardHeader(category, percentage, treatedItems, totalItems);
  }
}

// ðŸï¸ KLASSE-A-SPEZIFISCHE LOGIK (KOPIE VON B)
function renderAMCategoryHeader(studentId, category, key, percentage, treatedItems, totalItems) {
  // AM-Klasse hat KEINE PS-Kreise (Ãœberland, Autobahn, Nacht)
  if (key === 'grundstufe' || key === 'aufbaustufe' || key === 'leistungsstufe' || key === 'grundfahraufgaben' || key === 'reifestufe' || key === 'checkliste') {
    return renderCategoryHeaderWithCircles(studentId, category, key, percentage, treatedItems, totalItems);
  } else {
    return renderStandardHeader(category, percentage, treatedItems, totalItems);
  }
}

function renderACategoryHeader(studentId, category, key, percentage, treatedItems, totalItems) {
  if (key === 'grundstufe' || key === 'aufbaustufe' || key === 'leistungsstufe' || key === 'grundfahraufgaben' || key === 'reifestufe' || key === 'checkliste') {
    return renderCategoryHeaderWithCircles(studentId, category, key, percentage, treatedItems, totalItems);
  } else if (key === 'uberlandfahrten') {
    return renderSpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 5);
  } else if (key === 'autobahn') {
    return renderSpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 4);
  } else if (key === 'dammerung_dunkelheit') {
    return renderSpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 3);
  } else {
    return renderStandardHeader(category, percentage, treatedItems, totalItems);
  }
}

// ðŸš› KLASSE-C-SPEZIFISCHE LOGIK (KOPIE VON B)  
function renderCCategoryHeader(studentId, category, key, percentage, treatedItems, totalItems) {
  if (key === 'grundstufe' || key === 'aufbaustufe' || key === 'leistungsstufe' || key === 'grundfahraufgaben') {
    return renderCategoryHeaderWithCircles(studentId, category, key, percentage, treatedItems, totalItems);
  } else if (key === 'uberlandfahrten') {
    return renderSpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 5);
  } else if (key === 'autobahn') {
    return renderSpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 4);
  } else if (key === 'dammerung_dunkelheit') {
    return renderSpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 3);
  } else {
    return renderStandardHeader(category, percentage, treatedItems, totalItems);
  }
}

// ðŸšš KLASSE-CE-SPEZIFISCHE LOGIK (KOPIE VON B)
function renderCECategoryHeader(studentId, category, key, percentage, treatedItems, totalItems) {
  if (key === 'grundstufe' || key === 'aufbaustufe' || key === 'leistungsstufe' || key === 'grundfahraufgaben') {
    return renderCategoryHeaderWithCircles(studentId, category, key, percentage, treatedItems, totalItems);
  } else if (key === 'uberlandfahrten') {
    return renderSpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 5);
  } else if (key === 'autobahn') {
    return renderSpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 4);
  } else if (key === 'dammerung_dunkelheit') {
    return renderSpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 3);
  } else {
    return renderStandardHeader(category, percentage, treatedItems, totalItems);
  }
}

// ðŸš› KLASSE-BE-SPEZIFISCHE LOGIK (MIT KORREKTEN PS-ZAHLEN)
function renderBECategoryHeader(studentId, category, key, percentage, treatedItems, totalItems) {
  // BE-spezifische GrÃ¼ne Kreise
  if (key === 'grundstufe' || key === 'aufbaustufe' || key === 'leistungsstufe' || key === 'grundfahraufgaben' || key === 'wichtige_fahraufgaben') {
    return renderCategoryHeaderWithCircles(studentId, category, key, percentage, treatedItems, totalItems);
  }
  // BE-spezifische PS-Kreise mit KORREKTEN ZAHLEN
  else if (key === 'uberlandfahrten') {
    // BE: 3 PS-Kreise (nicht 5!)
    return renderBESpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 3);
  } 
  else if (key === 'autobahn') {
    // BE: 1 PS-Kreis (nicht 4!)
    return renderBESpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 1);
  } 
  else if (key === 'dammerung_dunkelheit') {
    // BE: 1 PS-Kreis (nicht 3!)
    return renderBESpecialFahrtenHeader(studentId, category, key, percentage, treatedItems, totalItems, 1);
  }
  // Alle anderen BE-Kategorien: Standard
  else {
    return renderStandardHeader(category, percentage, treatedItems, totalItems);
  }
}

// ðŸ“± HAUPT-ROUTER-FUNKTION (KEINE EIGENE LOGIK MEHR!)
function renderCategoryHeader(studentId, category, key, percentage, treatedItems, totalItems) {
  // ðŸ”§ CURRENTCLASS-STABILISIERUNG - prÃ¼fe SchÃ¼ler-Storage
  if (!currentClass || currentClass === 'B') {
    // Finde die richtige Klasse basierend auf dem SchÃ¼ler
    const classes = ['BE', 'A', 'A1', 'A2', 'B', 'C', 'C1', 'C1E', 'CE'];
    for (let className of classes) {
      const students = JSON.parse(localStorage.getItem(`fahrschul_students_${className}`) || '[]');
      if (students.some(s => s.id === studentId)) {
        currentClass = className;
        break;
      }
    }
  }
  
  // ðŸ“± REINER ROUTER - KEINE EIGENE LOGIK!
  switch(currentClass) {
    case 'B':
      return renderBCategoryHeader(studentId, category, key, percentage, treatedItems, totalItems);
    case 'A':
    case 'A1': 
    case 'A2':
      return renderACategoryHeader(studentId, category, key, percentage, treatedItems, totalItems);
    case 'AM':
      return renderAMCategoryHeader(studentId, category, key, percentage, treatedItems, totalItems);
    case 'BE':
      return renderBECategoryHeader(studentId, category, key, percentage, treatedItems, totalItems);
    case 'C':
    case 'C1':
    case 'C1E':
      return renderCCategoryHeader(studentId, category, key, percentage, treatedItems, totalItems);
    case 'CE':
      return renderCECategoryHeader(studentId, category, key, percentage, treatedItems, totalItems);
    default:
      // Fallback fÃ¼r unbekannte Klassen - verwende B-Logik
      return renderBCategoryHeader(studentId, category, key, percentage, treatedItems, totalItems);
  }
}

// ðŸ“± STANDARD HEADER (ohne Kreise)
function renderStandardHeader(category, percentage, treatedItems, totalItems) {
  return `
    <div class="training-info-with-circles">
      <div class="training-info">
        <h3>${category.name}</h3>
        ${category.subtitle ? `<div class="training-subtitle">${category.subtitle}</div>` : ''}
      </div>
    </div>
    <div class="training-progress">
      <div class="progress-circle"></div>
      <div class="progress-text">${percentage}%</div>
      <div class="progress-count">(${treatedItems}/${totalItems})</div>
      <div class="dropdown-arrow">â–¼</div>
    </div>
  `;
}





</script>
</body>
</html>